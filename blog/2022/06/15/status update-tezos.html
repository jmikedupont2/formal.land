<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.1.1">
<title data-rh="true">Status update on the verification of Tezos | Formal Land</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://formal.land/img/land-512.png"><meta data-rh="true" name="twitter:image" content="https://formal.land/img/land-512.png"><meta data-rh="true" property="og:url" content="https://formal.land/blog/2022/06/15/status update-tezos"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Status update on the verification of Tezos | Formal Land"><meta data-rh="true" name="description" content="Here we give an update on our verification effort on the protocol of Tezos. We add the marks:"><meta data-rh="true" property="og:description" content="Here we give an update on our verification effort on the protocol of Tezos. We add the marks:"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2022-06-15T00:00:00.000Z"><meta data-rh="true" property="article:tag" content="tezos,coq-of-ocaml,coq"><link data-rh="true" rel="icon" href="/img/land-512.png"><link data-rh="true" rel="canonical" href="https://formal.land/blog/2022/06/15/status update-tezos"><link data-rh="true" rel="alternate" href="https://formal.land/blog/2022/06/15/status update-tezos" hreflang="en"><link data-rh="true" rel="alternate" href="https://formal.land/blog/2022/06/15/status update-tezos" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Formal Land RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Formal Land Atom Feed">



<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-MQLHF4EV4J"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-MQLHF4EV4J",{anonymize_ip:!0})</script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.c7523a6c.css">
<script src="/assets/js/runtime~main.8139c3df.js" defer="defer"></script>
<script src="/assets/js/main.9798b558.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,t("light"))}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" style="background-color:#fafbfc;color:#091E42" role="banner"><div class="content_knG7 announcementBarContent_xLdY">For our services, email us at <a href="mailto:&#099;&#111;&#110;&#116;&#097;&#099;&#116;&#064;formal&#046;&#108;&#097;&#110;&#100;">&#099;&#111;&#110;&#116;&#097;&#099;&#116;&#064;formal&#046;&#108;&#097;&#110;&#100;</a>&nbsp;üíå&nbsp;!</div></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/land-512.png" alt="Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/land-512.png" alt="Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Formal Land</b></a><a class="navbar__item navbar__link" href="/docs/company/about">Company</a><a class="navbar__item navbar__link" href="/docs/coq-of-rust/introduction">coq-of-rust</a><a class="navbar__item navbar__link" href="/docs/coq-of-ocaml/introduction">coq-of-ocaml</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/formal-land" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://gitlab.com/formal-land" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitLab<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2024/05/22/translation-of-python-code-simulations-from-trace">Simulation of Python code from traces in Coq</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2024/05/14/translation-of-python-code-simulations">Simulation of Python code in Coq</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2024/05/10/translation-of-python-code">Translation of Python code to Coq</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2024/04/26/translation-core-alloc-crates">Translation of the Rust&#x27;s core and alloc crates</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2024/04/03/monadic-notation-for-rust-translation">Monadic notation for the Rust translation</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="https://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="Here we give an update on our verification effort on the protocol of Tezos. We add the marks:"><header><h1 class="title_f1Hy" itemprop="headline">Status update on the verification of Tezos</h1><div class="container_mt6G margin-vert--md"><time datetime="2022-06-15T00:00:00.000Z" itemprop="datePublished">June 15, 2022</time> ¬∑ <!-- -->8 min read</div></header><div id="__blog-post-container" class="markdown" itemprop="articleBody"><p>Here we give an update on our <a href="https://formal-land.gitlab.io/coq-tezos-of-ocaml/" target="_blank" rel="noopener noreferrer">verification effort</a> on the protocol of Tezos. We add the marks:</p>
<ul>
<li>‚úÖ for &quot;rather done&quot;</li>
<li>üåä for &quot;partially done&quot;</li>
<li>‚ùå for &quot;most is yet to do&quot;</li>
</ul>
<p>On the website of project, we also automatically generates pages such as <a href="https://formal-land.gitlab.io/coq-tezos-of-ocaml/docs/status/compare/" target="_blank" rel="noopener noreferrer">Compare</a> to follow the status of the tasks.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="maintenance-of-the-translation-">Maintenance of the translation ‚úÖ<a href="#maintenance-of-the-translation-" class="hash-link" aria-label="Direct link to Maintenance of the translation ‚úÖ" title="Direct link to Maintenance of the translation ‚úÖ">‚Äã</a></h2>
<p>We were able to maintain most of the translation from OCaml to Coq of the protocol of Tezos using <a href="https://github.com/formal-land/coq-of-ocaml" target="_blank" rel="noopener noreferrer">coq-of-ocaml</a>, including all the translation of the Michelson interpreter. There was an increase in the size of the OCaml code base in recent months, due to new features added in Tezos like the <a href="https://research-development.nomadic-labs.com/tezos-is-scaling.html" target="_blank" rel="noopener noreferrer">rollups</a>. Here are the numbers of lines of code (<code>.ml</code> and <code>.mli</code> files) for the various protocol versions:</p>
<ul>
<li>protocol H: <code>51147</code></li>
<li>protocol I: <code>59535</code></li>
<li>protocol J: <code>83271</code> (increase mainly due to the rollups)</li>
<li>protocol Alpha (development version of K): <code>90716</code></li>
</ul>
<p>We still translate most of the protocol code up to version J. We stayed on version J for a while as we wanted to add as many proofs as possible before doing a proof of backward compatibility between J and K. We are currently updating the translation to support the protocol version Alpha, preparing for the translation of K.</p>
<p>For protocol J, we needed to add a <a href="https://gitlab.com/nomadic-labs/coq-tezos-of-ocaml/-/blob/master/blacklist.txt" target="_blank" rel="noopener noreferrer">blacklist.txt</a> of files that we do not support. Indeed, we need to add new changes to <code>coq-of-ocaml</code> to support these or do hard-to-maintain changes to <a href="https://gitlab.com/tezos/tezos/-/merge_requests/3303" target="_blank" rel="noopener noreferrer">our fork</a> of the Tezos protocol. We plan to complete the translation and remove this black-list for the protocol J soon (in a week or two).</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="size-of-the-proofs-">Size of the proofs ‚úÖ<a href="#size-of-the-proofs-" class="hash-link" aria-label="Direct link to Size of the proofs ‚úÖ" title="Direct link to Size of the proofs ‚úÖ">‚Äã</a></h2>
<p>One of our plans is to have a reasonable quantity of proofs, to cover a reasonable quantity of code and properties from the protocol. We believe we have a good quantity of proofs now, as we have more than 50,000 lines of Coq code (for an OCaml codebase of 80,000 lines).</p>
<p>In addition to our main targets, we verify many &quot;smaller&quot; properties, such as:</p>
<ul>
<li>conversion functions are inverses (when there are two <code>to_int</code> and <code>of_int</code> functions in a file, we show that they are inverses);</li>
<li>the <code>compare</code> functions, to order elements, are well defined (see our blog post <a href="https://formal-land.gitlab.io/coq-tezos-of-ocaml/blog/2022/04/04/verifying-the-compare-functions" target="_blank" rel="noopener noreferrer">Verifying the compare functions of OCaml</a>);</li>
<li>invariants are preserved. For example, <a href="https://formal-land.gitlab.io/coq-tezos-of-ocaml/docs/proofs/carbonated_map#Make.update_is_valid" target="_blank" rel="noopener noreferrer">here</a> we show that updating a carbonated map preserves the property of having a size field actually equal to the number of elements.</li>
</ul>
<p>We should note that the size of Coq proofs tends to grow faster than the size of the verified code. We have no coverage metrics to know how much of the code is covered by these proofs.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="data-encodings-">Data-encodings üåä<a href="#data-encodings-" class="hash-link" aria-label="Direct link to Data-encodings üåä" title="Direct link to Data-encodings üåä">‚Äã</a></h2>
<p>The <a href="https://gitlab.com/nomadic-labs/data-encoding" target="_blank" rel="noopener noreferrer">data-encoding</a> library is a set of combinators to write serialization/de-serialization functions. We verify that the encodings defined for each protocol data type are bijective. The good thing we have is a semi-automated tactic to verify the use of the <code>data-encoding</code> primitives. We detail this approach in our blog post <a href="https://formal-land.gitlab.io/coq-tezos-of-ocaml/blog/2021/11/22/data-encoding-automation" target="_blank" rel="noopener noreferrer">Automation of <code>data_encoding</code> proofs</a>. We can verify most of the encoding functions that we encounter. From there, we also express the <strong>invariant</strong> associated with each data type, which the encodings generally check at runtime. The invariants are then the domain of definition of the encodings.</p>
<p>However, we have a hole: we do not verify the <code>data-encoding</code> library itself. Thus the <a href="https://formal-land.gitlab.io/coq-tezos-of-ocaml/docs/environment/proofs/data_encoding" target="_blank" rel="noopener noreferrer">axioms we made</a> on the data-encoding primitives may have approximations. And indeed, we missed one issue in the development code of the protocol. This is thus a new high-priority target to verify the <code>data-encoding</code> library itself. One of the challenges for the proof is the use of side-effects (references and exceptions) in this library.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="property-based-tests-">Property-based tests üåä<a href="#property-based-tests-" class="hash-link" aria-label="Direct link to Property-based tests üåä" title="Direct link to Property-based tests üåä">‚Äã</a></h2>
<p>The property-based tests on the protocol are located in <a href="https://gitlab.com/tezos/tezos/-/tree/master/src/proto_alpha/lib_protocol/test/pbt" target="_blank" rel="noopener noreferrer"><code>src/proto_alpha/lib_protocol/test/pbt</code></a>. These tests are composed of:</p>
<ul>
<li>a generator, generating random inputs of a certain shape;</li>
<li>a property function, a boolean function taking a generated input and supposed to always answer <code>true</code>.</li>
</ul>
<p>We translated a part of these tests to Coq, to convert them to theorems and have specifications extracted from the code. The result of this work is summarized in this blog post: <a href="https://formal-land.gitlab.io/coq-tezos-of-ocaml/blog/2022/06/07/formal-verification-of-property-based-tests" target="_blank" rel="noopener noreferrer">Formal verification of property based tests</a>. We have fully translated and verified four test files over a total of twelve. We are continuing the work of translations and proofs.</p>
<p>However, we found that for some of the files the proofs were taking a long time to write compared to the gains in safety. Indeed, the statements made in the tests are sometimes too complex when translated into general theorems. For example, for <a href="https://gitlab.com/tezos/tezos/-/blob/master/src/proto_alpha/lib_protocol/test/pbt/test_carbonated_map.ml" target="_blank" rel="noopener noreferrer">test_carbonated_map.ml</a> we have to deal with:</p>
<ul>
<li>gas exhaustion (seemingly impossible in the tests);</li>
<li>data structures of size greater than <code>max_int</code> (impossible in practice).</li>
</ul>
<p>All of that complicate the proofs for little gain in safety. So I would say that not all the property-based tests have a nice and useful translation to Coq. We should still note that for some of the tests, like with saturation arithmetic, we have proofs that work well. For these, we rely on the automated linear arithmetic tactic <a href="https://coq.inria.fr/refman/addendum/micromega.html" target="_blank" rel="noopener noreferrer"><code>lia</code></a> of Coq to verify properties over integer overflows.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="storage-system-">Storage system üåä<a href="#storage-system-" class="hash-link" aria-label="Direct link to Storage system üåä" title="Direct link to Storage system üåä">‚Äã</a></h2>
<p>By &quot;storage system&quot; we understand the whole set of functors defined in <a href="https://gitlab.com/tezos/tezos/-/blob/master/src/proto_alpha/lib_protocol/storage_functors.ml" target="_blank" rel="noopener noreferrer"><code>storage_functors.ml</code></a> and how we apply them to define the protocol storage in <a href="https://gitlab.com/tezos/tezos/-/blob/master/src/proto_alpha/lib_protocol/storage_functors.ml" target="_blank" rel="noopener noreferrer"><code>storage.ml</code></a>. These functors create sub-storages with signatures such as:</p>
<div class="language-ocaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ocaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">module</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> Non_iterable_indexed_data_storage </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sig</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> context </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">value</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> mem </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> context </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> key </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> bool Lwt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> get </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> context </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> key </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">value</span><span class="token plain"> tzresult Lwt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> find </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> context </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> key </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">value</span><span class="token plain"> option tzresult Lwt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> update </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> context </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> key </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">value</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> Raw_context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t tzresult Lwt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> init </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> context </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> key </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">value</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> Raw_context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t tzresult Lwt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> add </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> context </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> key </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">value</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> Raw_context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Lwt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> add_or_remove </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> context </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> key </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">value</span><span class="token plain"> option </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> Raw_context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Lwt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> remove_existing </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> context </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> key </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> Raw_context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t tzresult Lwt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> remove </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> context </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> key </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> Raw_context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Lwt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This <code>Non_iterable_indexed_data_storage</code> API looks like the API of an OCaml&#x27;s <a href="https://v2.ocaml.org/api/Map.Make.html" target="_blank" rel="noopener noreferrer">Map</a>. As a result, our goal for the storage is to show that is can be simulated by standard OCaml data structures such as sets and maps. This is a key step to unlock further reasoning about code using the storage.</p>
<p>Unfortunately, we were not able to verify the whole storage system yet. Among the difficulties are that:</p>
<ul>
<li>there are many layers in the definition of the storage;</li>
<li>the storage functors use a lot of abstractions, and sometimes it is unclear how to specify them in the general case.</li>
</ul>
<p>Still, we have verified some of the functors as seen in <a href="https://formal-land.gitlab.io/coq-tezos-of-ocaml/docs/proofs/storage_functors" target="_blank" rel="noopener noreferrer"><code>Proofs/Storage_functors.v</code></a> and specified the <code>storage.ml</code> file in <a href="https://formal-land.gitlab.io/coq-tezos-of-ocaml/docs/storage" target="_blank" rel="noopener noreferrer"><code>Proos/Storage.v</code></a>. We believe in having the correct specifications for all of the storage abstractions now. We plan to complete all these proofs later.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="michelson">Michelson<a href="#michelson" class="hash-link" aria-label="Direct link to Michelson" title="Direct link to Michelson">‚Äã</a></h2>
<p>The verification of the Michelson interpreter is what occupied most of our time. By considering the OCaml files whose name starts by <code>script_</code>, the size of the Michelson interpreter is around 20,000 lines of OCaml code.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="simulations-">Simulations üåä<a href="#simulations-" class="hash-link" aria-label="Direct link to Simulations üåä" title="Direct link to Simulations üåä">‚Äã</a></h3>
<p>The interpreter relies heavily on <a href="https://v2.ocaml.org/manual/gadts.html" target="_blank" rel="noopener noreferrer">GADTs</a> in OCaml. Because these do not translate nicely in Coq, we need to write simulations in dependent types of the interpreter functions, and prove them correct in Coq. We describe this process in our <a href="https://formal-land.gitlab.io/coq-tezos-of-ocaml/docs/guides/michelson" target="_blank" rel="noopener noreferrer">Michelson Guide</a>.</p>
<p>The main difficulties we encountered are:</p>
<ul>
<li>the number of simulations to write (covering the 20,000 lines of OCaml);</li>
<li>the execution time of the proof of correctness of the simulations. This is due to the large size of the inductive types describing the Michelson AST, and the use of dependent types generating large proof terms. For example, there are around 30 cases for the types and 150 for the instructions node in the AST.</li>
</ul>
<p>When writing the simulations, we are also verifying the termination of all the functions and the absence of reachable <code>assert false</code>. We have defined the simulation of many functions, but are still missing important ones such as <a href="https://formal-land.gitlab.io/coq-tezos-of-ocaml/docs/script_ir_translator/#parse_instr_aux" target="_blank" rel="noopener noreferrer"><code>parse_instr_aux</code></a> to parse Michelson programs.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="mi-cho-coq-">Mi-Cho-Coq üåä<a href="#mi-cho-coq-" class="hash-link" aria-label="Direct link to Mi-Cho-Coq üåä" title="Direct link to Mi-Cho-Coq üåä">‚Äã</a></h3>
<p>We have a project to verify that the <a href="https://gitlab.com/nomadic-labs/mi-cho-coq" target="_blank" rel="noopener noreferrer">Mi-Cho-Coq</a> framework, used to formally verify smart contracts written in Michelson, is compatible with the implementation of the Michelson interpreter in OCaml. We have a partial proof of compatibility in <a href="https://formal-land.gitlab.io/coq-tezos-of-ocaml/docs/simulations/micho_to_dep" target="_blank" rel="noopener noreferrer">Micho_to_dep.v</a>. We still need to complete this proof, especially to handle instructions with loops. Our goal is to show a complete inclusion of the semantics of Mi-Cho-Coq into the semantics of the implementation.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="parseunparse-">Parse/unparse ‚ùå<a href="#parseunparse-" class="hash-link" aria-label="Direct link to Parse/unparse ‚ùå" title="Direct link to Parse/unparse ‚ùå">‚Äã</a></h3>
<p>We wanted to verify that the various parsing and unparsing functions over Michelson are inverses. These functions exist for:</p>
<ul>
<li>comparable types</li>
<li>types</li>
<li>comparable data</li>
<li>data</li>
</ul>
<p>Because we are still focused on writing, verifying or updating the simulations, we are still not done for this task.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">‚Äã</a></h2>
<p>We have many ongoing projects but few fully completed tasks. We will focus more on having terminated proofs.</p></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_mRVl"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/tezos">tezos</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/coq-of-ocaml">coq-of-ocaml</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/coq">coq</a></li></ul></div></footer></article><div style="margin-top:40px"></div><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/2022/06/23/upgrade-coq-of-ocaml-4.14"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Upgrade coq-of-ocaml to OCaml 4.14</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/2022/02/02/make-tezos-a-formally-verified-crypto"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Make Tezos the first formally verified cryptocurrency</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#maintenance-of-the-translation-" class="table-of-contents__link toc-highlight">Maintenance of the translation ‚úÖ</a></li><li><a href="#size-of-the-proofs-" class="table-of-contents__link toc-highlight">Size of the proofs ‚úÖ</a></li><li><a href="#data-encodings-" class="table-of-contents__link toc-highlight">Data-encodings üåä</a></li><li><a href="#property-based-tests-" class="table-of-contents__link toc-highlight">Property-based tests üåä</a></li><li><a href="#storage-system-" class="table-of-contents__link toc-highlight">Storage system üåä</a></li><li><a href="#michelson" class="table-of-contents__link toc-highlight">Michelson</a><ul><li><a href="#simulations-" class="table-of-contents__link toc-highlight">Simulations üåä</a></li><li><a href="#mi-cho-coq-" class="table-of-contents__link toc-highlight">Mi-Cho-Coq üåä</a></li><li><a href="#parseunparse-" class="table-of-contents__link toc-highlight">Parse/unparse ‚ùå</a></li></ul></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Content</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/company/about">Company</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/company/claims">Claims</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/company/press">Press</a></li></ul></div><div class="col footer__col"><div class="footer__title">Links</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://twitter.com/LandFoobar" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://fr.linkedin.com/company/formal-land" target="_blank" rel="noopener noreferrer" class="footer__link-item">Linkedin<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://t.me/formal_land" target="_blank" rel="noopener noreferrer" class="footer__link-item">Telegram<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.tiktok.com/@formal.land" target="_blank" rel="noopener noreferrer" class="footer__link-item">TikTok<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer" class="footer__link-item">Email<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/formal-land" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://gitlab.com/formal-land" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitLab<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://formal-land.gitlab.io/coq-tezos-of-ocaml/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Coq Tezos of OCaml<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright ¬© 2024 Formal Land (Arae SARL) üê¶, Paris<br><em>Formal verification for everyday-life applications üèá</em><!-- Start of LiveChat (www.livechat.com) code -->
<script>window.__lc=window.__lc||{},window.__lc.license=14938650,function(n,t,c){function i(n){return e._h?e._h.apply(null,n):e._q.push(n)}var e={_q:[],_h:null,_v:"2.0",on:function(){i(["on",c.call(arguments)])},once:function(){i(["once",c.call(arguments)])},off:function(){i(["off",c.call(arguments)])},get:function(){if(!e._h)throw new Error("[LiveChatWidget] You can't use getters before load.");return i(["get",c.call(arguments)])},call:function(){i(["call",c.call(arguments)])},init:function(){var n=t.createElement("script");n.async=!0,n.type="text/javascript",n.src="https://cdn.livechatinc.com/tracking.js",t.head.appendChild(n)}};!n.__lc.asyncInit&&e.init(),n.LiveChatWidget=n.LiveChatWidget||e}(window,document,[].slice)</script>
<noscript><a href="https://www.livechat.com/chat-with/14938650/" rel="nofollow">Chat with us</a>, powered by <a href="https://www.livechat.com/?welcome" rel="noopener nofollow" target="_blank">LiveChat</a></noscript>
<!-- End of LiveChat code --></div></div></div></footer></div>
</body>
</html>