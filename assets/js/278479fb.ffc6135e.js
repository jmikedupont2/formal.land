"use strict";(self.webpackChunkformal_land=self.webpackChunkformal_land||[]).push([[6390],{3609:(e,t,o)=>{o.r(t),o.d(t,{assets:()=>l,contentTitle:()=>r,default:()=>d,frontMatter:()=>s,metadata:()=>i,toc:()=>c});var n=o(4848),a=o(8453);const s={title:"Upgrade coq-of-ocaml to OCaml 4.14",tags:["coq-of-ocaml","ocaml",4.14]},r=void 0,i={permalink:"/blog/2022/06/23/upgrade-coq-of-ocaml-4.14",source:"@site/blog/2022-06-23-upgrade-coq-of-ocaml-4.14.md",title:"Upgrade coq-of-ocaml to OCaml 4.14",description:"In an effort to support the latest version of the protocol of Tezos we upgraded coq-of-ocaml to add compatibility with OCaml 4.14. The result is available in the branch ocaml-4.14. We describe here how we made this upgrade.",date:"2022-06-23T00:00:00.000Z",formattedDate:"June 23, 2022",tags:[{label:"coq-of-ocaml",permalink:"/blog/tags/coq-of-ocaml"},{label:"ocaml",permalink:"/blog/tags/ocaml"},{label:"4.14",permalink:"/blog/tags/4-14"}],readingTime:2.195,hasTruncateMarker:!0,authors:[],frontMatter:{title:"Upgrade coq-of-ocaml to OCaml 4.14",tags:["coq-of-ocaml","ocaml","4.14"]},unlisted:!1,prevItem:{title:"Latest blog posts on our formal verification effort on Tezos",permalink:"/blog/2022/12/13/latest-blog-posts-on-tezos"},nextItem:{title:"Status update on the verification of Tezos",permalink:"/blog/2022/06/15/status update-tezos"}},l={authorsImageUrls:[]},c=[{value:"Usage of Merlin",id:"usage-of-merlin",level:2},{value:"Upgrade",id:"upgrade",level:2},{value:"Git submodule or copy &amp; paste?",id:"git-submodule-or-copy--paste",level:2},{value:"Next",id:"next",level:2}];function h(e){const t={a:"a",code:"code",h2:"h2",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,a.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)(t.p,{children:["In an effort to support the latest version of the ",(0,n.jsx)(t.a,{href:"https://gitlab.com/tezos/tezos/-/tree/master/src/proto_alpha/lib_protocol",children:"protocol of Tezos"})," we upgraded ",(0,n.jsx)(t.a,{href:"https://github.com/formal-land/coq-of-ocaml",children:(0,n.jsx)(t.code,{children:"coq-of-ocaml"})})," to add compatibility with OCaml 4.14. The result is available in the branch ",(0,n.jsx)(t.a,{href:"https://github.com/formal-land/coq-of-ocaml/pull/217",children:(0,n.jsx)(t.code,{children:"ocaml-4.14"})}),". We describe here how we made this upgrade."]}),"\n",(0,n.jsx)(t.h2,{id:"usage-of-merlin",children:"Usage of Merlin"}),"\n",(0,n.jsxs)(t.p,{children:["In ",(0,n.jsx)(t.code,{children:"coq-of-ocaml"})," we are using ",(0,n.jsx)(t.a,{href:"https://github.com/ocaml/merlin",children:"Merlin"})," to get the typed ",(0,n.jsx)(t.a,{href:"https://en.wikipedia.org/wiki/Abstract_syntax_tree",children:"abstract syntax tree"})," of OCaml files. We see the AST through the ",(0,n.jsx)(t.a,{href:"https://docs.mirage.io/ocaml/Typedtree/index.html",children:"Typedtree"})," interface, together with an access to all the definitions of the current compilation environment. Merlin computes the current environment by understanding how an OCaml project is configured and connecting to the ",(0,n.jsx)(t.a,{href:"https://dune.build/",children:"dune"})," build system. The environment is mandatory for certain transformations in ",(0,n.jsx)(t.code,{children:"coq-of-ocaml"}),", like:"]}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsx)(t.li,{children:"finding a canonical name for module types;"}),"\n",(0,n.jsx)(t.li,{children:"propagating phantom types."}),"\n"]}),"\n",(0,n.jsxs)(t.p,{children:["In order to use Merlin as a library (rather than as a daemon), we vendor the ",(0,n.jsx)(t.a,{href:"https://github.com/rgrinberg/merlin/tree/lsp",children:"LSP version"})," of ",(0,n.jsx)(t.a,{href:"https://github.com/rgrinberg",children:"rgrinberg"})," in the folder ",(0,n.jsx)(t.a,{href:"https://github.com/formal-land/coq-of-ocaml/tree/master/vendor",children:(0,n.jsx)(t.code,{children:"vendor/"})}),". This vendored version works with no extra configurations."]}),"\n",(0,n.jsx)(t.h2,{id:"upgrade",children:"Upgrade"}),"\n",(0,n.jsxs)(t.p,{children:["When a new version of OCaml is out, we upgrade our vendored version of Merlin to a compatible one. Then we do the necessary changes to ",(0,n.jsx)(t.code,{children:"coq-of-ocaml"}),", as the interface of the AST generally evolves with small changes. For OCaml 4.14, the main change was some types becoming abstract such as ",(0,n.jsx)(t.code,{children:"Types.type_expr"}),". To access to the fields of these types, we now need to use a specific getter and do changes such as:"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-diff",children:"+    match typ.desc with\n-    match Types.get_desc typ with\n"})}),"\n",(0,n.jsxs)(t.p,{children:["This made some patterns in ",(0,n.jsx)(t.code,{children:"match"})," expressions more complex, but otherwise the changes were very minimal. We ran all the unit-tests of ",(0,n.jsx)(t.code,{children:"coq-of-ocaml"})," after the upgrade and they were still valid."]}),"\n",(0,n.jsx)(t.h2,{id:"git-submodule-or-copy--paste",children:"Git submodule or copy & paste?"}),"\n",(0,n.jsx)(t.p,{children:"To vendor Merlin we have two possibilities:"}),"\n",(0,n.jsxs)(t.ol,{children:["\n",(0,n.jsxs)(t.li,{children:["Using a ",(0,n.jsx)(t.a,{href:"https://git-scm.com/book/en/v2/Git-Tools-Submodules",children:"Git submodule"}),"."]}),"\n",(0,n.jsx)(t.li,{children:"Doing a copy & paste of the code."}),"\n"]}),"\n",(0,n.jsx)(t.p,{children:"The first possibility is more efficient in terms of space, but there are a few disadvantages:"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsx)(t.li,{children:"we cannot make small modifications if needed;"}),"\n",(0,n.jsxs)(t.li,{children:["the archives generated by Github do not contain the code of the submodules (see this ",(0,n.jsx)(t.a,{href:"https://github.com/dear-github/dear-github/issues/214",children:"issue"}),")"]}),"\n",(0,n.jsx)(t.li,{children:"if a commit in the repository for the submodule disappears, then the submodule is unusable."}),"\n"]}),"\n",(0,n.jsxs)(t.p,{children:["The last reason forced us to do a copy & paste for OCaml 4.14. We now have to be cautious not to commit the generate ",(0,n.jsx)(t.code,{children:".ml"})," file for the OCaml parser."]}),"\n",(0,n.jsx)(t.h2,{id:"next",children:"Next"}),"\n",(0,n.jsx)(t.p,{children:"The next change will be doing the upgrade to OCaml 5. There should be much more changes, and in particular a new way of handling the effects. We do not know yet if it will be possible to translate the effect handlers to Coq in a nice way."})]})}function d(e={}){const{wrapper:t}={...(0,a.R)(),...e.components};return t?(0,n.jsx)(t,{...e,children:(0,n.jsx)(h,{...e})}):h(e)}},8453:(e,t,o)=>{o.d(t,{R:()=>r,x:()=>i});var n=o(6540);const a={},s=n.createContext(a);function r(e){const t=n.useContext(s);return n.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function i(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:r(e.components),n.createElement(s.Provider,{value:t},e.children)}}}]);