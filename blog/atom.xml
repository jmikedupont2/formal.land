<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://formal.land/blog</id>
    <title>Formal Land Blog</title>
    <updated>2024-03-08T00:00:00.000Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://formal.land/blog"/>
    <subtitle>Formal Land Blog</subtitle>
    <icon>https://formal.land/img/land-512.png</icon>
    <entry>
        <title type="html"><![CDATA[Improvements in the Rust translation to Coq, part 2]]></title>
        <id>https://formal.land/blog/2024/03/08/improvements-rust-translation-part-2</id>
        <link href="https://formal.land/blog/2024/03/08/improvements-rust-translation-part-2"/>
        <updated>2024-03-08T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[In our previous blog post, we stated our plan to improve our translation of Rust&nbsp;ü¶Ä to Coq&nbsp;üêì with coq-of-rust. We also provided a new definition for our Rust monad in Coq, and the definition of a unified type to represent any Rust values. We will now see how we modify the Rust implementation of&nbsp;coq-of-rust to make the generated code use these new definitions.]]></summary>
        <content type="html"><![CDATA[<p>In our <a href="https://formal.land/blog/2024/02/29/improvements-rust-translation">previous blog post</a>, we stated our plan to improve our translation of Rust&nbsp;ü¶Ä to Coq&nbsp;üêì with <a href="https://github.com/formal-land/coq-of-rust" target="_blank" rel="noopener noreferrer">coq-of-rust</a>. We also provided a new definition for our Rust monad in Coq, and the definition of a unified type to represent any Rust values. We will now see how we modify the Rust implementation of&nbsp;<code>coq-of-rust</code> to make the generated code use these new definitions.</p>
<p>With this new translation strategy, to support more Rust code, we want:</p>
<ol>
<li>to remove the types from the translation,</li>
<li>to avoid the need to order the definitions in the generated Coq code.</li>
</ol>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><ul>
<li>Previous post: <a href="https://formal.land/blog/2024/02/29/improvements-rust-translation">Improvements in the Rust translation to Coq, part 1</a></li>
</ul></div></div>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Contact</div><div class="admonitionContent_BuS1"><p>This work is funded by the <a href="https://alephzero.org/" target="_blank" rel="noopener noreferrer">Aleph Zero</a> crypto-currency to verify their Rust smart contracts. You can <a href="https://twitter.com/LandFoobar" target="_blank" rel="noopener noreferrer">follow us on X</a> to get our updates. We propose tools and services to make your codebase bug-free with <a href="https://en.wikipedia.org/wiki/Formal_verification" target="_blank" rel="noopener noreferrer">formal verification</a>.</p><p>Contact us at&nbsp;<a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">contact@formal.land</a> to chat!</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="implementation-of-the-monad">Implementation of the monad<a href="https://formal.land/blog/2024/03/08/improvements-rust-translation-part-2#implementation-of-the-monad" class="hash-link" aria-label="Direct link to Implementation of the monad" title="Direct link to Implementation of the monad">‚Äã</a></h2>
<p>We implemented the new monad and the type <code>Value.t</code> holding any kind of Rust values as described in the previous blog post. For now, we have removed the definitions related to the standard library of Rust (everything except the base definitions such as the integer types). This should not be an issue to type-check the generated Coq code, as the new code should be independent of the ordering of definitions: in particular, it should type-check even if the needed definitions are not yet there.</p>
<p>We added some definitions for the primitive unary and binary operators. These include some operations on the integers such arithmetic operations (with or without overflow, depending on the compilation mode), as well as comparisons (equality, lesser or equal than, ...).</p>
<p>Now that the main library file <a href="https://github.com/formal-land/coq-of-rust/blob/main/CoqOfRust/CoqOfRust.v" target="_blank" rel="noopener noreferrer">CoqOfRust/CoqOfRust.v</a> compiles in Coq, we can start to test the translation on our examples.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="generating-the-tests">Generating the tests<a href="https://formal.land/blog/2024/03/08/improvements-rust-translation-part-2#generating-the-tests" class="hash-link" aria-label="Direct link to Generating the tests" title="Direct link to Generating the tests">‚Äã</a></h2>
<p>We generate new snapshots for our translations with:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">cargo</span><span class="token plain"> build </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">time</span><span class="token plain"> python run_tests.py</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This builds the project <code>coq-of-rust</code> (with a lot of warning about unused code for now) and re-generates our snapshots: for each Rust file in the <a href="https://github.com/formal-land/coq-of-rust/tree/main/examples" target="_blank" rel="noopener noreferrer">examples</a> directory, we generate a Coq file with the same name but the extension&nbsp;<code>.v</code>. We generate two versions:</p>
<ul>
<li>one in axiom mode, where all definitions are axiomatized, to translate libraries, for example, and</li>
<li>one in full definition mode, where we also translate the bodies of the function definitions.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="axiom-mode">Axiom mode<a href="https://formal.land/blog/2024/03/08/improvements-rust-translation-part-2#axiom-mode" class="hash-link" aria-label="Direct link to Axiom mode" title="Direct link to Axiom mode">‚Äã</a></h2>
<p>We first try to type-check and fix the code generated in axiom mode.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="type-aliases">Type aliases<a href="https://formal.land/blog/2024/03/08/improvements-rust-translation-part-2#type-aliases" class="hash-link" aria-label="Direct link to Type aliases" title="Direct link to Type aliases">‚Äã</a></h3>
<p>We have a first error for type aliases that we do not translate properly. We need access to the fully qualified name of the alias. We do that by combining calls to the functions:</p>
<ul>
<li><a href="https://doc.rust-lang.org/beta/nightly-rustc/rustc_middle/ty/context/struct.TyCtxt.html#method.crate_name" target="_blank" rel="noopener noreferrer">crate_name</a> to get the name of the current crate and</li>
<li><a href="https://doc.rust-lang.org/beta/nightly-rustc/rustc_middle/ty/context/struct.TyCtxt.html#method.def_path" target="_blank" rel="noopener noreferrer">def_path</a> to get the whole definition path without the crate name.</li>
</ul>
<p>As a result, for the file <a href="https://github.com/formal-land/coq-of-rust/blob/main/examples/ink_contracts/basic_contract_caller.rs" target="_blank" rel="noopener noreferrer">examples/ink_contracts/basic_contract_caller.rs</a>, we translate the type alias:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token type-definition class-name">Hash</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token keyword" style="color:#00009f">u8</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">32</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>into the Coq code:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Axiom</span><span class="token plain"> Hash </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Ty</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">path </span><span class="token string" style="color:#e3116c">"basic_contract_caller::Hash"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Ty</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">apply</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Ty</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">path </span><span class="token string" style="color:#e3116c">"array"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Ty</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">path </span><span class="token string" style="color:#e3116c">"u8"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Then, during the proofs, we will be able to substitute the type <code>Hash</code> by its definition when it appears. Note that we now translate types by values of the type <code>Ty.t</code>, so there should be no difficulties in rewriting types.</p>
<p>We should add the length of the array in the type. This is not done yet.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="traits">Traits<a href="https://formal.land/blog/2024/03/08/improvements-rust-translation-part-2#traits" class="hash-link" aria-label="Direct link to Traits" title="Direct link to Traits">‚Äã</a></h3>
<p>In axiom mode, we remove most of the trait definitions. Instead, with our new translation model, the traits are mostly unique names (the absolute path of the trait definition). The main use of traits is to distinguish them from other traits, to know which trait implementation to use when calling a trait's method. We still translate the provided methods (that are default methods in the trait definition) to axioms and add a predicate stating that they are associated with the current trait. For example, we translate the following Rust trait:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// crate `my_crate`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">trait</span><span class="token plain"> </span><span class="token type-definition class-name">Animal</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">new</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token lifetime-annotation symbol" style="color:#36acaa">'static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">str</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Self</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">name</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token lifetime-annotation symbol" style="color:#36acaa">'static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">str</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">noise</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token lifetime-annotation symbol" style="color:#36acaa">'static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">str</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">talk</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token macro property" style="color:#36acaa">println!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"{} says {}"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">name</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">noise</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>to the Coq code:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">(* Trait *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> Animal</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Parameter</span><span class="token plain"> talk </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">list Ty</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">list Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Axiom</span><span class="token plain"> ProvidedMethod_talk </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">IsProvidedMethod </span><span class="token string" style="color:#e3116c">"my_crate::Animal"</span><span class="token plain"> talk</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">End</span><span class="token plain"> Animal</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We realize with this example that the translation in axiom mode generates very few errors, as we remove all the type definitions and all the function axioms have the same signature:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">(* A list of types that can be empty for non-polymorphic functions,</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">   a list of parameters, and a return value in the monad `M`. *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">list Ty</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> list Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> M</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>so the type-checking of these axioms never fails. We thus jump to the full definition mode as this is where our new approach might fail.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="definition-mode">Definition mode<a href="https://formal.land/blog/2024/03/08/improvements-rust-translation-part-2#definition-mode" class="hash-link" aria-label="Direct link to Definition mode" title="Direct link to Definition mode">‚Äã</a></h2>
<p>We now try to type-check the generated Coq code in full definition mode. We start with the <a href="https://github.com/formal-land/coq-of-rust/blob/main/examples/ink_contracts/dns.rs" target="_blank" rel="noopener noreferrer">dns.rs</a> smart contract example.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="polymorphic-trait-implementation">Polymorphic trait implementation<a href="https://formal.land/blog/2024/03/08/improvements-rust-translation-part-2#polymorphic-trait-implementation" class="hash-link" aria-label="Direct link to Polymorphic trait implementation" title="Direct link to Polymorphic trait implementation">‚Äã</a></h3>
<p>This example is interesting, as it contains polymorphic implementations, such as for the <a href="https://en.wikipedia.org/wiki/Mock_object" target="_blank" rel="noopener noreferrer">mock</a> type&nbsp;<code>Mapping</code>:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token attribute attr-name" style="color:#00a4db">#[derive(Default)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token type-definition class-name">Mapping</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">K</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">V</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    _key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">core</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token namespace" style="opacity:0.7">marker</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token class-name">PhantomData</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">K</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    _value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">core</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token namespace" style="opacity:0.7">marker</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token class-name">PhantomData</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">V</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>that implements the <a href="https://doc.rust-lang.org/core/default/trait.Default.html" target="_blank" rel="noopener noreferrer">Default</a> trait on the type <code>Mapping&lt;K, V&gt;</code> for two type parameters&nbsp;<code>K</code> and&nbsp;<code>V</code>. We translate it to:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token comment" style="color:#999988;font-style:italic">(* Struct Mapping *)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> Impl_core_default_Default_for_dns_Mapping_K_V</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">(*</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token comment" style="color:#999988;font-style:italic">  Default</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token comment" style="color:#999988;font-style:italic">  *)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> default </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ùúè </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list Ty</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Œ± </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> ùúè</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Œ± </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> Self</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> K</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> V </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_method</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">          </span><span class="token string" style="color:#e3116c">"core::default::Default"</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">          </span><span class="token string" style="color:#e3116c">"default"</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">(* Self *)</span><span class="token plain"> Ty</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">apply</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Ty</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">path </span><span class="token string" style="color:#e3116c">"core::marker::PhantomData"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> K </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">call Œ±</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_method</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">          </span><span class="token string" style="color:#e3116c">"core::default::Default"</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">          </span><span class="token string" style="color:#e3116c">"default"</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">(* Self *)</span><span class="token plain"> Ty</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">apply</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Ty</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">path </span><span class="token string" style="color:#e3116c">"core::marker::PhantomData"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> V </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">call Œ±</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">      M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pure</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StructRecord </span><span class="token string" style="color:#e3116c">"dns::Mapping"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"_key"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"_value"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">impossible</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">end</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Axiom</span><span class="token plain"> Implements </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">forall</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">K V </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Ty</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">IsTraitInstance</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">      </span><span class="token string" style="color:#e3116c">"core::default::Default"</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">(* Self *)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Ty</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">apply</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Ty</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">path </span><span class="token string" style="color:#e3116c">"dns::Mapping"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> K</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> V </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"default"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> InstanceField</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">Method</span><span class="token plain"> default</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> K</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> V </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token keyword" style="color:#00009f">End</span><span class="token plain"> Impl_core_default_Default_for_dns_Mapping_K_V</span><span class="token punctuation" style="color:#393A34">.</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Here are the interesting bits of this code:</p>
<ul>
<li>
<p>On line 1, we translate the <code>Mapping</code> type into a single comment, as the types disappear in our translation and become just markers. The marker for <code>Mapping</code> is its absolute name <code>Ty.path "dns::Mapping"</code>.</p>
</li>
<li>
<p>On line 7, the function <code>default</code> takes a list of types&nbsp;<code>ùúè</code> as a parameter in case it is polymorphic. Here, this method is not polymorphic, but we still add the&nbsp;<code>ùúè</code> parameter for uniformity. We also take three additional type parameters:</p>
<ul>
<li><code>Self</code></li>
<li><code>K</code></li>
<li><code>V</code></li>
</ul>
<p>that represent the <code>Self</code> type on which the trait is implemented, and the two type parameters of the <code>Mapping</code> type. These will be provided when calling the&nbsp;<code>default</code> method.</p>
</li>
<li>
<p>On line 11, we use the primitive&nbsp;<code>M.get_method</code> (axiomatized for now) to get the method <code>default</code> of the trait <code>core::default::Default</code> for the type <code>core::marker::PhantomData&lt;K&gt;</code>. Here, we see that having access to the type <code>K</code> in the body of the <code>default</code> function is useful, as it helps us to disambiguate between the various implementations of the <code>Default</code> trait instances that we call. Here, we provide the&nbsp;<code>Self</code> type of the trait in a list of a single element. If the <code>Default</code> trait or the <code>default</code> method were polymorphic, we would also append these type parameters in this list.</p>
</li>
<li>
<p>On line 15, we call the&nbsp;<code>default</code> method instance that we found with an empty list of arguments.</p>
</li>
<li>
<p>On line 23, we build a value of type <code>Mapping</code> with the two fields <code>_key</code> and <code>_value</code> initialized with the results of the two calls to the <code>default</code> method. We use the <code>Value.StructRecord</code> constructor to build the value, and its result is of type <code>Value.t</code> like all other Rust values.</p>
</li>
<li>
<p>On line 24, we eliminate a case with a wrong number of type and value arguments. This should never happen as the arity of all the function calls is checked by the Rust type-checker.</p>
</li>
<li>
<p>On line 27, we state that we have a new instance of the <code>Default</code> trait for the <code>Mapping</code> type, with the <code>default</code> method implemented by the <code>default</code> function. This is true for any values of the types <code>K</code> and <code>V</code>.</p>
</li>
<li>
<p>On line 34, we specify that&nbsp;<code>[K, V]</code> are the type parameters of this implementation that should be given as extra parameters when calling the <code>default</code> method of this instance, together with the&nbsp;<code>Self</code> type.</p>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="polymorphic-implementation">Polymorphic implementation<a href="https://formal.land/blog/2024/03/08/improvements-rust-translation-part-2#polymorphic-implementation" class="hash-link" aria-label="Direct link to Polymorphic implementation" title="Direct link to Polymorphic implementation">‚Äã</a></h3>
<p>Next, we have a polymorphic implementation of mock associated functions for the&nbsp;<code>Mapping</code> type:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">impl</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">K</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">V</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token class-name">Mapping</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">K</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">V</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">contains</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token class-name">K</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">bool</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token macro property" style="color:#36acaa">unimplemented!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We translate it to:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> Impl_dns_Mapping_K_V</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> Self </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">K V </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Ty</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Ty</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    Ty</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">apply</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Ty</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">path </span><span class="token string" style="color:#e3116c">"dns::Mapping"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> K</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> V </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">(*</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token comment" style="color:#999988;font-style:italic">      fn contains(&amp;self, _key: &amp;K) -&gt; bool {</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token comment" style="color:#999988;font-style:italic">          unimplemented!()</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token comment" style="color:#999988;font-style:italic">      }</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token comment" style="color:#999988;font-style:italic">  *)</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> contains </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ùúè </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list Ty</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Œ± </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> ùúè</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Œ± </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> Self</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> K</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> V </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> _key </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> self </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc self </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> _key </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc _key </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var </span><span class="token string" style="color:#e3116c">"core::panicking::panic"</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mk_str </span><span class="token string" style="color:#e3116c">"not implemented"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">call Œ±</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">      never_to_any Œ±</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">impossible</span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">end</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Axiom</span><span class="token plain"> AssociatedFunction_contains </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">forall</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">K V </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Ty</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">IsAssociatedFunction </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Self K V</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"contains"</span><span class="token plain"> contains </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> K</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> V </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">(* ... *)</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We follow a similar approach as for the translation of trait implementations, especially regarding the handling of polymorphic type variables. Here are some differences:</p>
<ul>
<li>On line 2, we define a <code>Self</code> type as a function of the type parameters&nbsp;<code>K</code> and&nbsp;<code>V</code>. This is useful for avoiding repeating the same type expression later.</li>
<li>On line 22, we use the predicate <code>M.IsAssociatedFunction</code> to state that we have a new associated function <code>contains</code> for the <code>Mapping</code> type, with the <code>contains</code> method implemented by the <code>contains</code> function. This is true for any values of the types <code>K</code> and <code>V</code>. Like for the trait implementations, we explicit the list&nbsp;<code>[K, V]</code> that will be given as an extra parameter to the function&nbsp;<code>contains</code>.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="https://formal.land/blog/2024/03/08/improvements-rust-translation-part-2#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">‚Äã</a></h2>
<p>In the next blog post, we will see how we continue to translate the examples in full definition mode. There is still a lot to do to get to the same level of Rust support as before, but we are hopeful that our new approach will be more robust and easier to maintain.</p>
<p>If you are interested in formally verifying your Rust projects, do not hesitate to get in touch with us at&nbsp;<a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">contact@formal.land</a>! Formal verification provides the highest level of safety for critical applications. See the <a href="https://www.whitehouse.gov/wp-content/uploads/2024/02/Final-ONCD-Technical-Report.pdf" target="_blank" rel="noopener noreferrer">White House report on secure software development</a> for more on the importance of formal verification.</p>]]></content>
        <category label="coq-of-rust" term="coq-of-rust"/>
        <category label="Rust" term="Rust"/>
        <category label="Coq" term="Coq"/>
        <category label="translation" term="translation"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Improvements in the Rust translation to Coq, part 1]]></title>
        <id>https://formal.land/blog/2024/02/29/improvements-rust-translation</id>
        <link href="https://formal.land/blog/2024/02/29/improvements-rust-translation"/>
        <updated>2024-02-29T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Our tool coq-of-rust is translating Rust&nbsp;ü¶Ä programs to the proof system Coq&nbsp;üêì to do formal verification on Rust programs. Even if we are able to verify realistic code, such as an ERC-20 smart contract, coq-of-rust still has some limitations:]]></summary>
        <content type="html"><![CDATA[<p>Our tool <a href="https://github.com/formal-land/coq-of-rust" target="_blank" rel="noopener noreferrer">coq-of-rust</a> is translating Rust&nbsp;ü¶Ä programs to the proof system Coq&nbsp;üêì to do formal verification on Rust programs. Even if we are able to verify realistic code, such as an <a href="http://localhost:3000/blog/2023/12/13/rust-verify-erc-20-smart-contract" target="_blank" rel="noopener noreferrer">ERC-20 smart contract</a>, <code>coq-of-rust</code> still has some limitations:</p>
<ul>
<li>fragile trait handling</li>
<li>difficulties in ordering the definitions, in their order of dependencies as required by Coq</li>
</ul>
<p>We will present how we plan to improve our tool to address these limitations.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><ul>
<li>Next post: <a href="https://formal.land/blog/2024/03/08/improvements-rust-translation-part-2">Improvements in the Rust translation to Coq, part 2</a></li>
</ul></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction">Introduction<a href="https://formal.land/blog/2024/02/29/improvements-rust-translation#introduction" class="hash-link" aria-label="Direct link to Introduction" title="Direct link to Introduction">‚Äã</a></h2>
<p>As emphasized in the <a href="https://www.whitehouse.gov/wp-content/uploads/2024/02/Final-ONCD-Technical-Report.pdf" target="_blank" rel="noopener noreferrer">recent report from the White House</a>, memory safety and formal verification are keys to ensure secure and correct software. Rust provides memory safety and we provide formal verification on top of it with <code>coq-of-rust</code>.</p>
<p>We will take the Rust <a href="https://github.com/serde-rs/serde" target="_blank" rel="noopener noreferrer">serde</a> serialization library to have an example of code to translate in Coq. This is a popular Rust library that is used in almost all projects, either as a direct or transitive dependency. Serialization has a simple specification (being a bijection between the data and its serialized form) and is a good candidate for formal verification. We might verify this library afterwards if there is a need.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Contact</div><div class="admonitionContent_BuS1"><p>This work is funded by the <a href="https://alephzero.org/" target="_blank" rel="noopener noreferrer">Aleph Zero</a> crypto-currency in order to verify their Rust smart contracts. You can <a href="https://twitter.com/LandFoobar" target="_blank" rel="noopener noreferrer">follow us on X</a> to get our updates. We propose tools and services to make your codebase totally bug-free. Contact us at&nbsp;<a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">contact@formal.land</a> to chat! We offer a free audit to assess the feasibility of formal verification on your case.</p></div></div>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>Goal</div><div class="admonitionContent_BuS1"><p>Our company goal is to make formal verification accessible to all projects, reducing its cost to&nbsp;20% of the development cost. There should be no reason to have bugs in end-user products!</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="warnings">Warnings<a href="https://formal.land/blog/2024/02/29/improvements-rust-translation#warnings" class="hash-link" aria-label="Direct link to Warnings" title="Direct link to Warnings">‚Äã</a></h2>
<p>We start by running the command:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">cargo</span><span class="token plain"> coq-of-rust</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>in the <code>serde</code> directory. We get a lot of warnings, but the translation does not panic as it tries to always produce something for debugging purposes. We have two kinds of warnings.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="constants-in-patterns">Constants in patterns<a href="https://formal.land/blog/2024/02/29/improvements-rust-translation#constants-in-patterns" class="hash-link" aria-label="Direct link to Constants in patterns" title="Direct link to Constants in patterns">‚Äã</a></h3>
<p>The warning is the following:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">warning: Constants in patterns are not yet supported.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    --&gt; serde/src/de/mod.rs:2277:13</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2277 |             0 =&gt; panic!(), // special case elsewhere</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     |             ^</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The reason why we did not handle constants in patterns is that they are represented in a special format in the Rust compiler that was not obvious to handle. The definition of <a href="https://doc.rust-lang.org/beta/nightly-rustc/rustc_middle/mir/consts/enum.Const.html" target="_blank" rel="noopener noreferrer">rustc_middle::mir::consts::Const</a> representing the constants in patterns is:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">enum</span><span class="token plain"> </span><span class="token type-definition class-name">Const</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token lifetime-annotation symbol" style="color:#36acaa">'tcx</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Ty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Const</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token lifetime-annotation symbol" style="color:#36acaa">'tcx</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Unevaluated</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">UnevaluatedConst</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token lifetime-annotation symbol" style="color:#36acaa">'tcx</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Ty</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token lifetime-annotation symbol" style="color:#36acaa">'tcx</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Val</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">ConstValue</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token lifetime-annotation symbol" style="color:#36acaa">'tcx</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Ty</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token lifetime-annotation symbol" style="color:#36acaa">'tcx</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>There are three cases, and each contains several more cases. To fix this issue, we added the code to handle the signed and unsigned integers, which are enough for our <code>serde</code> example. We will need to add other cases later, especially for the strings. This allowed us to discover and fix a bug in our handling of patterns for tuples with elision&nbsp;<code>..</code>, like in the example:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> triple </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> triple </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token macro property" style="color:#36acaa">println!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"First is `0`, `y` is {:?}, and `z` is {:?}"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token macro property" style="color:#36acaa">println!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"First is `1` and the rest doesn't matter"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token macro property" style="color:#36acaa">println!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"last is `2` and the rest doesn't matter"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">..</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token macro property" style="color:#36acaa">println!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"First is `3`, last is `4`, and the rest doesn't matter"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _ </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token macro property" style="color:#36acaa">println!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"It doesn't matter what they are"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>These changes are in the pull-request <a href="https://github.com/formal-land/coq-of-rust/pull/470" target="_blank" rel="noopener noreferrer">coq-of-rust#470</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="unimplemented-parent_kind">Unimplemented <code>parent_kind</code><a href="https://formal.land/blog/2024/02/29/improvements-rust-translation#unimplemented-parent_kind" class="hash-link" aria-label="Direct link to unimplemented-parent_kind" title="Direct link to unimplemented-parent_kind">‚Äã</a></h3>
<p>We get a second form of warning:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">unimplemented parent_kind: Struct</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">expression: Expr {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kind: ZstLiteral {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        user_ty: None,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ty: FnDef(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DefId(2:31137 ~ core[10bc]::cmp::Reverse::{constructor#0}),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        T/#1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    temp_lifetime: Some(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Node(14),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    span: serde/src/de/impls.rs:778:22: 778:29 (#0),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This is for some cases of expressions <a href="https://doc.rust-lang.org/beta/nightly-rustc/rustc_middle/thir/enum.ExprKind.html#variant.ZstLiteral" target="_blank" rel="noopener noreferrer">rustc_middle::thir::ExprKind::ZstLiteral</a> in the Rust's <a href="https://rustc-dev-guide.rust-lang.org/thir.html" target="_blank" rel="noopener noreferrer">THIR representation</a> that we do not handle. If we look at the <code>span</code> field, we see that it appears in the source in the file <code>serde/src/de/impls.rs</code> at line 778:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">forwarded_impl!</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Reverse</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">T</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Reverse</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// Here is the error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This is not very informative as this code is generated by a macro. Another similar kind of expression appears later:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">impl</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token lifetime-annotation symbol" style="color:#36acaa">'de</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token class-name">Deserialize</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token lifetime-annotation symbol" style="color:#36acaa">'de</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token class-name">Wrapping</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">T</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Deserialize</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token lifetime-annotation symbol" style="color:#36acaa">'de</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">deserialize</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">D</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">deserializer</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">D</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">Result</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">Self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">D</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Error</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">D</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Deserializer</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token lifetime-annotation symbol" style="color:#36acaa">'de</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token class-name">Deserialize</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">deserialize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">deserializer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">map</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic">// Here is the error:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token class-name">Wrapping</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The <code>Wrapping</code> term is the constructor of a structure, used as a function. We add the support of this case in the pull-request <a href="https://github.com/formal-land/coq-of-rust/pull/471" target="_blank" rel="noopener noreferrer">coq-of-rust#471</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="coq-errors">Coq errors<a href="https://formal.land/blog/2024/02/29/improvements-rust-translation#coq-errors" class="hash-link" aria-label="Direct link to Coq errors" title="Direct link to Coq errors">‚Äã</a></h2>
<p>When we type-check the generated Coq code, we quickly get an error:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">(* Generated by coq-of-rust *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Require</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Import</span><span class="token plain"> CoqOfRust</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CoqOfRust</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> lib</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> core</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">End</span><span class="token plain"> core</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">End</span><span class="token plain"> lib</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> macros</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">End</span><span class="token plain"> macros</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> integer128</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">End</span><span class="token plain"> integer128</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> de</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">Module</span><span class="token plain">  Error</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">Section</span><span class="token plain"> Error</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">Record</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">(* Here is the error: *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        err </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ltac</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">serde</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">de</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ErrorImpl</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">(* 180.000 more lines! *)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The reason is that&nbsp;<code>serde.de.value.ErrorImpl</code> is not yet defined here. In Coq, we must order the definitions in the order of dependencies to ensure that there are no non-terminating definitions with infinite recursive calls and to preserve the consistency of the system.</p>
<p>This issue does not seem easy to us, as in a Rust crate, everything can depend on each other:</p>
<ul>
<li>types</li>
<li>definitions</li>
<li>traits</li>
<li><code>impl</code> blocks</li>
</ul>
<p>Our current solutions are:</p>
<ol>
<li><strong>To reorder the definitions in the source Rust code</strong>, so that they appear in the right order for Coq. This is technically the simplest solution (no changes in <code>coq-of-rust</code>), but it is not very practical. Indeed, reordering elements in a big project generates a lot of conflicts in the version control system, especially if we cannot upstream the changes to the original project.</li>
<li><strong>To use a configuration file</strong> to specify the order of the definitions. This works in a lot of cases, but we need to write this file manually and have it complete to compile the whole crate in Coq, even if we are interested in verifying a small part of the code. There are also some cases that are hard to entangle, in particular with traits that can depend on both types and definitions, that themselves may depend on traits.</li>
</ol>
<p>In order to handle large projects, such as <code>serde</code>, we need to find a more definitive solution to handle the order of dependencies.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="plan-for-the-order-of-definitions">Plan for the order of definitions<a href="https://formal.land/blog/2024/02/29/improvements-rust-translation#plan-for-the-order-of-definitions" class="hash-link" aria-label="Direct link to Plan for the order of definitions" title="Direct link to Plan for the order of definitions">‚Äã</a></h2>
<p>Our idea is to use a more verbose, but simpler translation, to generate Coq code that is not sensitive to the ordering of Rust. In addition, we should have a more robust mechanism for the traits, as there are still some edge cases that we do not handle well.</p>
<p>Our main ingredients are:</p>
<ol>
<li>Generating an untyped code, where all Rust values become part of a single and shared <code>Value</code> type. With this approach, we can represent mutually recursive Rust types, that are generally hard to translate in a sound manner to Coq. We should also avoid a lot of errors on the Coq side related to type inference.</li>
<li>Adding an indirection level to all function calls, as any function call might refer to a definition that appears later in the code.</li>
</ol>
<p>These ingredients have some drawbacks:</p>
<ul>
<li>By removing the types, we will obtain a code that is less readable. It might contain translation errors that will be harder to spot. We will need to add the types back during the specification of the code.</li>
<li>We will need to add error cases corresponding to type errors at runtime, as we will not have the type system to ensure that functions expecting a certain type of value receive it. We know from the Rust type checker that these errors should not happen, but we will need to prove it in Coq.</li>
<li>We will have to resolve the indirections in the calls at proof time, or with other mechanisms, that will be more complex than the current translation.</li>
<li>We will still need to have a translation of the types (as values), to guide the inference of trait instances.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="definition-of-a-new-monad">Definition of a new monad<a href="https://formal.land/blog/2024/02/29/improvements-rust-translation#definition-of-a-new-monad" class="hash-link" aria-label="Direct link to Definition of a new monad" title="Direct link to Definition of a new monad">‚Äã</a></h2>
<p>We rework our definitions of values, pointers and monad to represent the effects, taking into account the fact that we remove the types from the translation. Here are the main definitions that we are planning to use. We have not tested them yet as we need to update the translation to Coq to use them. We will do that just after.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="pointers">Pointers<a href="https://formal.land/blog/2024/02/29/improvements-rust-translation#pointers" class="hash-link" aria-label="Direct link to Pointers" title="Direct link to Pointers">‚Äã</a></h3>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> Pointer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> Index</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">Inductive</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Tuple </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">index </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Array </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">index </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> StructRecord </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">constructor field </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> StructTuple </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">constructor </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">index </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">End</span><span class="token plain"> Index</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Path</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> list Index</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">End</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Path</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Inductive</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Value </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Immediate</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Mutable </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Address </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">address </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Address</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">path </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Path</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Arguments</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Immediate</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Arguments</span><span class="token plain"> Mutable </span><span class="token punctuation" style="color:#393A34">{</span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">End</span><span class="token plain"> Pointer</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>A pointer is either:</p>
<ul>
<li>a pointer to an immutable data, that is directly represented by its data;</li>
<li>a pointer to a mutable data, that is inside a cell at a certain address in the memory. The exact location in the cell is given by the path.</li>
</ul>
<p>The type of <code>Address</code> is not enforced yet, but we will do it when defining the semantics.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="values">Values<a href="https://formal.land/blog/2024/02/29/improvements-rust-translation#values" class="hash-link" aria-label="Direct link to Values" title="Direct link to Values">‚Äã</a></h3>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Inductive</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Bool </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> bool </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Integer </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Integer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> Z </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">(** For now we do not know how to represent floats so we use a string *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Float </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> string </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> UnicodeChar </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">String</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> string </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Tuple </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list t </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Array </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list t </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> StructRecord </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> string </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> list </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">string </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> StructTuple </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> string </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> list t </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Pointer </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Pointer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t t </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">(** The two existential types of the closure must be [Value.t] and [M]. We</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">      cannot enforce this constraint there yet, but we will do when defining the</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">      semantics. *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Closure </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token operator" style="color:#393A34">'</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">@</span><span class="token plain"> t </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">End</span><span class="token plain"> Value</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Here, this type aims to represent any Rust value. We might add a few cases later to represent the <code>dyn</code> values, for example. Most of the cases of this type are as expected:</p>
<ul>
<li>The constructor&nbsp;<code>StructRecord</code> is for constructors of <code>struct</code> or <code>enum</code> with named fields.</li>
<li>The constructor&nbsp;<code>StructTuple</code> is for constructors of <code>struct</code> or <code>enum</code> with unnamed fields.</li>
<li>The constructor&nbsp;<code>Pointer</code> is for pointers to data, that could be either <code>&amp;</code>, <code>&amp;mut</code>, <code>*const</code>, or <code>*mut</code>.</li>
<li>The constructor&nbsp;<code>Closure</code> is for closures (anonymous functions). To prevent errors with the positivity checker of Coq, we use an existential type for the type <code>Value.t</code> (as well as <code>M</code>, which will be defined later). Note that we are using impredicative <code>Set</code> in Coq, and <code>{A : Set @ P A}</code> is our notation for existential <code>Set</code> in <code>Set</code>. Without impredicative sets, we could have issues with the universe levels. The fact that these existential types are always <code>Value.t</code> and <code>M</code> will be enforced when defining the semantics.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="monads-primitives">Monad's primitives<a href="https://formal.land/blog/2024/02/29/improvements-rust-translation#monads-primitives" class="hash-link" aria-label="Direct link to Monad's primitives" title="Direct link to Monad's primitives">‚Äã</a></h3>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Primitive</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Inductive</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> StateAlloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> StateRead </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Address </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">address </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Address</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> StateWrite </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Address </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">address </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Address</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> EnvRead</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">End</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Primitive</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Here are the IO calls to the system that the monad can make. This list might be extended later. For now, we mainly have primitives to access the memory.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="monad-base">Monad: base<a href="https://formal.land/blog/2024/02/29/improvements-rust-translation#monad-base" class="hash-link" aria-label="Direct link to Monad: base" title="Direct link to Monad: base">‚Äã</a></h3>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> LowM</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Inductive</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Pure </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t A</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> CallPrimitive </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Primitive</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t A</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Loop </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t A </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">A </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> bool</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">A </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t A</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Impossible </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t A</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">(** This constructor is not strictly necessary, but is used as a marker for</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">      functions calls in the generated code, to help the tactics to recognize</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">      points where we can compose about functions. *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Call </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t A </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">A </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t A</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Arguments</span><span class="token plain"> Pure </span><span class="token punctuation" style="color:#393A34">{</span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Arguments</span><span class="token plain"> CallPrimitive </span><span class="token punctuation" style="color:#393A34">{</span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Arguments</span><span class="token plain"> Loop </span><span class="token punctuation" style="color:#393A34">{</span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Arguments</span><span class="token plain"> Impossible </span><span class="token punctuation" style="color:#393A34">{</span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Arguments</span><span class="token plain"> Call </span><span class="token punctuation" style="color:#393A34">{</span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Fixpoint</span><span class="token plain"> let_ </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e1 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">f </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t A </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> e1 </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Pure v </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> f v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> CallPrimitive primitive k </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      CallPrimitive primitive </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> v </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> let_ </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k v</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> f</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Loop body is_break k </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Loop body is_break </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> v </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> let_ </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k v</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> f</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Impossible </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> Impossible</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Call e k </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Call e </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> v </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> let_ </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k v</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> f</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">end</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">End</span><span class="token plain"> LowM</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This is the first layer of our monad, very similar to what we had before. We remove the cast operation, as now everything has the same type. We use a style by continuation, but we also define a <code>let_</code> function to have a "bind" operator. Note that we always have the same type as parameter, so this is not really a monad as the "bind" operator should have the type:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">forall</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A B </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> M A </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">A </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> M B</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> M B</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Always having the same type is enough for us as we use a single type of all Rust values.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="monad-with-exceptions">Monad: with exceptions<a href="https://formal.land/blog/2024/02/29/improvements-rust-translation#monad-with-exceptions" class="hash-link" aria-label="Direct link to Monad: with exceptions" title="Direct link to Monad: with exceptions">‚Äã</a></h3>
<p>We have the same type as before for the exceptions, representing the panics and all the special control flow operations such as <code>continue</code>, <code>return</code>, and <code>break</code>:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> Exception</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Inductive</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">(** exceptions for Rust's `return` *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Return </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">(** exceptions for Rust's `continue` *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Continue </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">(** exceptions for Rust's `break` *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Break </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">(** escape from a match branch once we know that it is not valid *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> BreakMatch </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Panic </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> string </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">End</span><span class="token plain"> Exception</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Our final monad definition is a thin wrapper around <code>LowM</code>, to add an error monad to propagate the exceptions:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> M </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  LowM</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> Exception</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> let_ </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e1 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e2 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  LowM</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">let_ e1 </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> v1 </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> v1 </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> inl v1 </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> e2 v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> inr error </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> LowM</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pure </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">inr error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">end</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Once again, this is not really a monad as the type of the values that we compute is always the same, and we do not need more. Having a definition in two steps (<code>LowM</code> and <code>M</code>) is useful to separate the part that can be defined by computation (the <code>M</code> part) from the part whose semantics can only be given by inductive predicates (the <code>LowM</code> part).</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="https://formal.land/blog/2024/02/29/improvements-rust-translation#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">‚Äã</a></h2>
<p>Next, we will see how we can use this new definition of Rust values, whether it works to translate our examples, and most importantly, how to modify <code>coq-of-rust</code> to generate terms without types.</p>
<p>If you are interested in formally verifying Rust projects, do not hesitate to get in touch with us at&nbsp;<a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">contact@formal.land</a> or go to our <a href="https://github.com/formal-land/coq-of-rust" target="_blank" rel="noopener noreferrer">GitHub repository</a> for <code>coq-of-rust</code>.</p>]]></content>
        <category label="coq-of-rust" term="coq-of-rust"/>
        <category label="Rust" term="Rust"/>
        <category label="Coq" term="Coq"/>
        <category label="translation" term="translation"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Translating Go to Coq, part 1]]></title>
        <id>https://formal.land/blog/2024/02/22/journey-coq-of-go</id>
        <link href="https://formal.land/blog/2024/02/22/journey-coq-of-go"/>
        <updated>2024-02-22T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[In this blog post, we present our development steps to build a tool to translate Go programs to the proof system Coq.]]></summary>
        <content type="html"><![CDATA[<p>In this blog post, we present our development steps to build a tool to translate Go programs to the proof system Coq.</p>
<p>The goal is to formally verify Go programs to make them totally bug-free. It is actually possible to make a program totally bug-free, as <a href="https://en.wikipedia.org/wiki/Formal_verification" target="_blank" rel="noopener noreferrer">formal verification</a> can cover all execution cases and kinds of properties thanks to the use of mathematical methods. This corresponds to the highest level of the <a href="https://en.wikipedia.org/wiki/Evaluation_Assurance_Level" target="_blank" rel="noopener noreferrer">Evaluation Assurance Levels</a> used for critical applications, such as the space industry.</p>
<p>All the code of our work is available on GitHub at <a href="https://github.com/formal-land/coq-of-go-experiment" target="_blank" rel="noopener noreferrer">github.com/formal-land/coq-of-go-experiment</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction">Introduction<a href="https://formal.land/blog/2024/02/22/journey-coq-of-go#introduction" class="hash-link" aria-label="Direct link to Introduction" title="Direct link to Introduction">‚Äã</a></h2>
<p>We believe that there are not yet a lot of formal verification tools for Go. We can cite <a href="https://github.com/tchajed/goose" target="_blank" rel="noopener noreferrer">Goose</a>, which is working by translation from Go to the proof system Coq. We will follow a similar approach, translating the Go language to our favorite proof system Coq. In contrast to Goose, we plan to support the whole Go language, even at the expense of the simplicity of the translation.</p>
<p>For that, we target the translation of the <a href="https://pkg.go.dev/golang.org/x/tools/go/ssa" target="_blank" rel="noopener noreferrer">SSA form of Go</a> of Go instead of the <a href="https://pkg.go.dev/go/ast" target="_blank" rel="noopener noreferrer">Go AST</a>. The SSA form is a more low-level representation of Go, so we hope to capture the semantics of the whole Go language more easily. This should be at the expense of the simplicity of the generated translation, but we hope that having full language support outweighs this.</p>
<p>Go is an interesting target as:</p>
<ul>
<li>this is quite a popular language,</li>
<li>it is focusing on simplicity, with a reduced set of language features,</li>
<li>a lot of critical backend applications are written in Go, including for very large companies (Google, Netflix, Uber, Twitch, etc.).</li>
</ul>
<p>Among interesting properties that we can verify are:</p>
<ul>
<li>the absence of reachable <code>panic</code> in the code,</li>
<li>the absence of race conditions or deadlocks,</li>
<li>the backward compatibility from release to release, for parts of the code whose behavior is not supposed to change,</li>
<li>the strict application of business rules.</li>
</ul>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Contact</div><div class="admonitionContent_BuS1"><p>You can <a href="https://twitter.com/LandFoobar" target="_blank" rel="noopener noreferrer">follow us on X</a> to get our updates. We propose tools and services to make your codebase totally bug-free. Contact us at&nbsp;<a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">contact@formal.land</a> to chat! We offer a free audit to assess the feasibility of formal verification on your case.</p></div></div>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>Goal</div><div class="admonitionContent_BuS1"><p>Our company goal is to make formal verification accessible to all projects, reducing its cost to&nbsp;20% of the development cost. There should be no reason to have bugs in end-user products!</p></div></div>
<p><img decoding="async" loading="lazy" alt="Mole and Rooster" src="https://formal.land/assets/images/mole_rooster-69abedffe91c988310aef61e9bf9d2e3.webp" width="1024" height="1024" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="first-target">First target<a href="https://formal.land/blog/2024/02/22/journey-coq-of-go#first-target" class="hash-link" aria-label="Direct link to First target" title="Direct link to First target">‚Äã</a></h2>
<p>Our first target is to achieve the formal verification <em>including all the dependencies</em> of the hello world program:</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">package</span><span class="token plain"> main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"fmt"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Hello, World!"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>What we want to show about this code is that it does a single and only thing: outputting the string "Hello, World!" to the standard output. Its only dependency is the <code>fmt</code> package, but when we look at the transitive dependencies of this package:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">go list </span><span class="token parameter variable" style="color:#36acaa">-f</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'{{ .Deps }}'</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">fmt</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>we get around forty packages:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">errors</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">internal/abi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">internal/bytealg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">internal/coverage/rtcov</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">internal/cpu</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">internal/fmtsort</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">internal/goarch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">internal/godebugs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">internal/goexperiment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">internal/goos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">internal/itoa</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">internal/oserror</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">internal/poll</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">internal/race</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">internal/reflectlite</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">internal/safefilepath</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">internal/syscall/execenv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">internal/syscall/unix</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">internal/testlog</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">internal/unsafeheader</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">io</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">io/fs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">math</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">math/bits</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">reflect</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">runtime</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">runtime/internal/atomic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">runtime/internal/math</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">runtime/internal/sys</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">runtime/internal/syscall</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sort</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">strconv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sync</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sync/atomic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">syscall</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unicode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unicode/utf8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unsafe</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We will need to translate all these packages to meaningful Coq code.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-start">The start<a href="https://formal.land/blog/2024/02/22/journey-coq-of-go#the-start" class="hash-link" aria-label="Direct link to The start" title="Direct link to The start">‚Äã</a></h2>
<p>We made the <code>coq-of-go</code> tool, with everything in a single file <a href="https://github.com/formal-land/coq-of-go-experiment/blob/main/main.go" target="_blank" rel="noopener noreferrer">main.go</a> for now. We retrieve the SSA form of a Go package provided as a command line parameter (code without the error handling):</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	packageToTranslate </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Args</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	cfg </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">packages</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Config</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Mode</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> packages</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">LoadSyntax</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	initial</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> packages</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Load</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cfg</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> packageToTranslate</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token boolean" style="color:#36acaa">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pkgs </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> ssautil</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Packages</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">initial</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	pkgs</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	members </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> pkgs</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Members</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>SSA form</div><div class="admonitionContent_BuS1"><p>The <a href="https://en.wikipedia.org/wiki/Static_single-assignment_form" target="_blank" rel="noopener noreferrer">SSA form</a> of a program is generally used internally by compilers to have a simple representation to work on. The <a href="https://llvm.org/" target="_blank" rel="noopener noreferrer">LLVM</a> language is such an example. In SSA, each variable is assigned exactly once and the control flow is explicit, with jumps or conditional jumps to labels. There are no <code>for</code> loops, <code>if</code> statements, or non-primitive expressions.</p></div></div>
<p>Then we iterate over all the SSA <code>members</code>, and directly print the corresponding Coq code to the standard output. We do not use an intermediate representation or make intermediate passes. We do not even do pretty-printing (splitting lines that are too long at the right place, and introducing indentation)! This should not be necessary as the SSA code cannot nest sub-expressions or statements. We still try to print a readable Coq code, as it will be used in the proofs.</p>
<p>There are four kinds of SSA members:</p>
<ul>
<li>named constants,</li>
<li>globals,</li>
<li>types,</li>
<li>functions.</li>
</ul>
<p>Named constants and globals are similar, and are for top-level variables whose value is either known at compile-time or computed at the program's init. Types are for type definitions. We will focus on functions, as this is where the code is.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="functions">Functions<a href="https://formal.land/blog/2024/02/22/journey-coq-of-go#functions" class="hash-link" aria-label="Direct link to Functions" title="Direct link to Functions">‚Äã</a></h2>
<p>The SSA functions in Go are described by the type <a href="https://pkg.go.dev/golang.org/x/tools/go/ssa#Function" target="_blank" rel="noopener noreferrer"><code>ssa.Function</code></a>:</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> Function </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Signature </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Signature</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// source information</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Synthetic </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// provenance of synthetic function; "" for true source functions</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Pkg  </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">Package </span><span class="token comment" style="color:#999988;font-style:italic">// enclosing package; nil for shared funcs (wrappers and error.Error)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Prog </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">Program </span><span class="token comment" style="color:#999988;font-style:italic">// enclosing program</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Params    </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">Parameter  </span><span class="token comment" style="color:#999988;font-style:italic">// function parameters; for methods, includes receiver</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	FreeVars  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">FreeVar    </span><span class="token comment" style="color:#999988;font-style:italic">// free variables whose values must be supplied by closure</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Locals    </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">Alloc      </span><span class="token comment" style="color:#999988;font-style:italic">// frame-allocated variables of this function</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Blocks    </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">BasicBlock </span><span class="token comment" style="color:#999988;font-style:italic">// basic blocks of the function; nil =&gt; external</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Recover   </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">BasicBlock   </span><span class="token comment" style="color:#999988;font-style:italic">// optional; control transfers here after recovered panic</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	AnonFuncs </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">Function   </span><span class="token comment" style="color:#999988;font-style:italic">// anonymous functions directly beneath this one</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// contains filtered or unexported fields</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The main part of interest for us is&nbsp;<code>Blocks</code>. A block is a sequence of instructions, and the control flow is explicit. The last instruction of a block is a jump to another block, or a return. The first instructions of a block can be the special <code>Phi</code> instruction, which is used to merge control flow from different branches.</p>
<p>We decided to write a first version to see what the SSA code of Go looks like when printed in Coq, without thinking about generating a well-typed code. This looks like this:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">with</span><span class="token plain"> MakeUint64 </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Œ± </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list Val</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">list Val</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Thunk </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> Œ± </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Thunk </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">EvalBody </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"t0"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> Instr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">BinOp</span><span class="token plain"> x </span><span class="token string" style="color:#e3116c">"&lt;"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Val</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Lit </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Lit</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Int </span><span class="token number" style="color:#36acaa">9223372036854775808</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Instr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">If </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">Register</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token string" style="color:#e3116c">"t0"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"t1"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> Instr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Convert x </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"t2"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> Instr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ChangeType </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">Register</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token string" style="color:#e3116c">"t1"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"t3"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> Instr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">MakeInterface </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">Register</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token string" style="color:#e3116c">"t2"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Return </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">Register</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token string" style="color:#e3116c">"t3"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"t4"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> Instr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Alloc </span><span class="token comment" style="color:#999988;font-style:italic">(* complit *)</span><span class="token plain"> Alloc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token attribute attr-name" style="color:#00a4db">Local</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"*go/constant.intVal"</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"t5"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> Instr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">FieldAddr </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">Register</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token string" style="color:#e3116c">"t4"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"t6"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> Instr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Call </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">CallKind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">Function</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">newInt </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"t7"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> Instr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Call </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">CallKind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">Function</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">TODO_method </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">Register</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token string" style="color:#e3116c">"t6"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      do</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Instr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Store </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">Register</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token string" style="color:#e3116c">"t5"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">Register</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token string" style="color:#e3116c">"t7"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"t8"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> Instr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">UnOp</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"*"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">Register</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token string" style="color:#e3116c">"t4"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"t9"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> Instr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">MakeInterface </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">Register</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token string" style="color:#e3116c">"t8"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Return </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">Register</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token string" style="color:#e3116c">"t9"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Thunk </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">EvalBody </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">end</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>for a source Go code (from the <a href="https://pkg.go.dev/go/constant" target="_blank" rel="noopener noreferrer">go/constant</a> package):</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// MakeUint64 returns the [Int] value for x.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">MakeUint64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x </span><span class="token builtin">uint64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> Value </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> x </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token number" style="color:#36acaa">63</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">int64Val</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">int64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> intVal</span><span class="token punctuation" style="color:#393A34">{</span><span class="token function" style="color:#d73a49">newInt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetUint64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>There are three blocks of code, labeled with <code>0</code>, <code>1</code>, and <code>2</code>. The first block ends with a conditional jump <code>If</code> corresponding to the <code>if</code> statement in the Go code. The following blocks are corresponding to the two possible branches of the <code>if</code> statement. They both end with a <code>Return</code> instruction, corresponding to the <code>return</code> statement in the Go code. They run various primitive instructions that we have translated as we can.</p>
<p>The generated Coq code is still readable but more verbose than the original Go code. We will later develop proof techniques using simulations to enable the user to define equivalent but simpler versions of the translation. Being able to define simulations of an imperative program is also important for the proofs, as we can rewrite the code in functional style to make it easier to reason about.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="type-checking">Type-checking<a href="https://formal.land/blog/2024/02/22/journey-coq-of-go#type-checking" class="hash-link" aria-label="Direct link to Type-checking" title="Direct link to Type-checking">‚Äã</a></h2>
<p>From there, a second step is to have a generated code that type-checks, forgetting about making a code with sound semantics for now. We generate the various Coq definitions that are needed in a header of the generated code, using axioms for all the definitions. For example, for the allocations we do:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> Alloc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Inductive</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Heap</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token attribute attr-name" style="color:#00a4db">Local</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">End</span><span class="token plain"> Alloc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> Instr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Parameter</span><span class="token plain"> Alloc </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Alloc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> string </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> M Val</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The <code>Inductive</code> keyword in Coq defines a type with two constructors <code>Heap</code> and <code>Local</code>. The <code>Parameter</code> keyword defines an axiomatized definition, where we only provide the type but not the definition itself. The <code>Instr.Alloc</code> instruction takes as parameters an allocation mode <code>Alloc.t</code> and a string and returns an <code>M Val.t</code> value.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="representation-of-values">Representation of values<a href="https://formal.land/blog/2024/02/22/journey-coq-of-go#representation-of-values" class="hash-link" aria-label="Direct link to Representation of values" title="Direct link to Representation of values">‚Äã</a></h3>
<p>We make the choice to remove the types while doing the translation, as the type system of Go is probably incompatible with the one of Coq in many ways. We thus translate everything to a single type <code>Val.t</code> in Coq to represent all kinds of possible Go values. The downside of this approach is that is makes the generated code less readable and less safe, as types are useful to track the correct use of values.</p>
<p>For now, we define the&nbsp;<code>Val.t</code> type as:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> Val</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Inductive</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Lit </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Lit</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Tuple </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">End</span><span class="token plain"> Val</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>with the literals&nbsp;<code>Lit.t</code> as:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> Lit</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Inductive</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Bool </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> bool</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Int </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Float </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Rational</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Complex </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Rational</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">String</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Nil</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">End</span><span class="token plain"> Lit</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We plan to refine this type and add more cases as we improve <code>coq-of-go</code>. Structures, pointers, and closures are missing for now.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="monadic-style">Monadic style<a href="https://formal.land/blog/2024/02/22/journey-coq-of-go#monadic-style" class="hash-link" aria-label="Direct link to Monadic style" title="Direct link to Monadic style">‚Äã</a></h3>
<p>In order to represent the side-effects of the Go code, we use a <a href="https://en.wikipedia.org/wiki/Monad_(functional_programming)" target="_blank" rel="noopener noreferrer">monadic style</a>. This is a standard approach to represent side-effects like mutations, exceptions, or non-termination in a purely function language such as Coq. We choose to use:</p>
<ul>
<li>A free monad, where all the primitives are constructor of the inductive type&nbsp;<code>M</code> of the monad. This simplifies the manipulation of the monad by allowing to compute on it and by delegating the actual implementation of the monadic primitives for later.</li>
<li>A co-inductive type, to allow potentially non-terminating programs. Co-inductive types are like lazy definitions in Haskell where it is possible to make an infinite list for example, as long as only a finite number of elements are consumed.</li>
</ul>
<p>In that sense, we follow the approach in the paper&nbsp;<a href="https://cambium.inria.fr/~eyoon/paper/vir.pdf" target="_blank" rel="noopener noreferrer">Modular, Compositional, and Executable Formal Semantics for LLVM IR</a>, that is using a co-inductive free monad (interaction tree) to formalize a reasonable subset of the LLVM language that is also an SSA representation but with more low-level instructions than Go.</p>
<p>Our definition for&nbsp;<code>M</code> for now is:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">CoInductive</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Return </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Bind</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">B </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t B</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> B </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Thunk </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> EvalBody </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Z </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> t A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Arguments</span><span class="token plain"> Return </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Arguments</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Bind</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A B</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Arguments</span><span class="token plain"> Thunk </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Arguments</span><span class="token plain"> EvalBody </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">End</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> M </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We define all the functions that we translate as mutually recursive with the <code>CoFixpoint ... with ...</code> keyword of Coq. Thus, we do not have to preserve the ordering of definitions that is required by Coq or care for recursive or mutually recursive functions in Go.</p>
<p>However, we did not achieve to make the type-checker of Coq happy for our&nbsp;<code>CoFixpoint</code> as many definitions are axiomatized, and the type-checker of Coq wants their definitions to know if they produce co-inductive constructors. So, for now, we admit this step by disabling the termination checker with this flag:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token attribute attr-name" style="color:#00a4db">Local</span><span class="token plain"> Unset Guard Checking</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="next">Next<a href="https://formal.land/blog/2024/02/22/journey-coq-of-go#next" class="hash-link" aria-label="Direct link to Next" title="Direct link to Next">‚Äã</a></h2>
<p>When we translate our hello world example we get the Coq code:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">CoFixpoint</span><span class="token plain"> Main </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Œ± </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list Val</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">list Val</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Thunk </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> Œ± </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Thunk </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">EvalBody </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"t0"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> Instr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Alloc </span><span class="token comment" style="color:#999988;font-style:italic">(* varargs *)</span><span class="token plain"> Alloc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">Heap</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"*[1]any"</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"t1"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> Instr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">IndexAddr </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">Register</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token string" style="color:#e3116c">"t0"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Val</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Lit </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Lit</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Int </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"t2"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> Instr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">MakeInterface </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Val</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Lit </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Lit</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">String</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Hello, World!"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      do</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Instr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Store </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">Register</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token string" style="color:#e3116c">"t1"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">Register</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token string" style="color:#e3116c">"t2"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"t3"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> Instr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Slice </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">Register</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token string" style="color:#e3116c">"t0"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> None None </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"t4"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> Instr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Call </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">CallKind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">Function</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Println </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">Register</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token string" style="color:#e3116c">"t3"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Return </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Thunk </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">EvalBody </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">end</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"> init </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Œ± </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list Val</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">list Val</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Thunk </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> Œ± </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Thunk </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">EvalBody </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"t0"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> Instr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">UnOp</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"*"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">Register</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token string" style="color:#e3116c">"init$guard"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Instr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">If </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">Register</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token string" style="color:#e3116c">"t0"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      do</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Instr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Store </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">Register</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read </span><span class="token string" style="color:#e3116c">"init$guard"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Val</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Lit </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Lit</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Bool true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"t1"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> Instr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Call </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">CallKind</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">Function</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">init </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Instr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Jump </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Return </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Thunk </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">EvalBody </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">end</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The&nbsp;<code>init</code> function, which is automatically generated by the Go compiler to initialize global variables, does not do much here. It checks whether it was already called or not reading the&nbsp;<code>init$guard</code> variable, and if not, it calls the&nbsp;<code>fmt.init</code> function. The&nbsp;<code>Main</code> function is the one that we are interested in. It allocates a variable to store the string "Hello, World!", and then calls the&nbsp;<code>fmt.Println</code> function to print it.</p>
<p>From there, to continue the project we have two possibilities:</p>
<ol>
<li>Give actual definitions to each primitive instruction that is used in this example (for now, everything is axiomatized).</li>
<li>Translate all the transitive dependencies of the hello world program to Coq, and make sure that we can compile everything together.</li>
</ol>
<p>For the next step, we choose to follow the second possibility as we are more confident in being able to define the semantics of the instructions, which is purely done on the Coq side, than in being able to use the Go compiler's APIs to retrieve the definitions of all the dependencies and related them together.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="https://formal.land/blog/2024/02/22/journey-coq-of-go#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">‚Äã</a></h2>
<p>We have presented the beginning of our journey to translate Go programs to Coq, to build a formal verification tool for Go. The translation type-checks on the few examples we have tried but has no semantics. We will follow by handling the translation of dependencies of a package.</p>
<p>If you are interested in this project, please contact us at&nbsp;<a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">contact@formal.land</a> or go to our <a href="https://github.com/formal-land/coq-of-go-experiment" target="_blank" rel="noopener noreferrer">GitHub repository</a>.</p>]]></content>
        <category label="coq-of-go" term="coq-of-go"/>
        <category label="Go" term="Go"/>
        <category label="Coq" term="Coq"/>
        <category label="translation" term="translation"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Experiment on translation from Haskell to Coq]]></title>
        <id>https://formal.land/blog/2024/02/14/experiment-coq-of-hs</id>
        <link href="https://formal.land/blog/2024/02/14/experiment-coq-of-hs"/>
        <updated>2024-02-14T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[We present an experiment coq-of-hs that we have made on the translation of Haskell programs to the proof system Coq&nbsp;üêì. The goal is to formally verify Haskell programs to make them totally bug-free.]]></summary>
        <content type="html"><![CDATA[<p>We present an experiment <a href="https://github.com/formal-land/coq-of-hs-experiment" target="_blank" rel="noopener noreferrer">coq-of-hs</a> that we have made on the translation of <a href="https://www.haskell.org/" target="_blank" rel="noopener noreferrer">Haskell</a> programs to the proof system <a href="https://coq.inria.fr/" target="_blank" rel="noopener noreferrer">Coq&nbsp;üêì</a>. The goal is to formally verify Haskell programs to make them totally bug-free.</p>
<p>Indeed, even with the use of a strict type system, there can still be bugs for properties that cannot be expressed with types. An example of such a property is the backward compatibility of an API endpoint for the new release of a web service when there has been code refactoring. Only formal verification can cover all execution cases and kinds of properties.</p>
<p>The code of the tool is at: <a href="https://github.com/formal-land/coq-of-hs-experiment" target="_blank" rel="noopener noreferrer">github.com/formal-land/coq-of-hs-experiment</a> (AGPL license)</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Contact</div><div class="admonitionContent_BuS1"><p>We propose tools to make your codebase totally bug-free. Contact us at&nbsp;<a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">contact@formal.land</a> for more information! We offer a free audit to assess the feasibility of formal verification for your case.</p></div></div>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Info</div><div class="admonitionContent_BuS1"><p>We estimate that the cost of formal verification should be 20% of the development cost. There are no reasons to still have bugs today!</p></div></div>
<p><img decoding="async" loading="lazy" alt="Haskell Logo" src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxNyAxMiI+CgkJPHBhdGggZmlsbD0iIzQ1M2E2MiIgZD0iTSAwIDEyIEwgNCA2IEwgMCAwIEwgMyAwIEwgNyA2IEwgMyAxMiIvPgoJCTxwYXRoIGZpbGw9IiM1ZTUwODYiIGQ9Ik0gNCAxMiBMIDggNiBMIDQgMCBMIDcgMCBMIDE1IDEyIEwgMTIgMTIgTCA5LjUgOC4yNSBMIDcgMTIiLz4KCQk8cGF0aCBmaWxsPSIjOGY0ZThiIiBkPSJNIDEzLjY2IDguNSBMIDEyLjMzMyA2LjUgTCAxNyA2LjUgTCAxNyA4LjUgTSAxMS42NjYgNS41IEwgMTAuMzMzIDMuNSBMIDE3IDMuNSBMIDE3IDUuNSIvPgo8L3N2Zz4=" width="17" height="12" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="goal-of-the-experiment">Goal of the experiment<a href="https://formal.land/blog/2024/02/14/experiment-coq-of-hs#goal-of-the-experiment" class="hash-link" aria-label="Direct link to Goal of the experiment" title="Direct link to Goal of the experiment">‚Äã</a></h2>
<p>There are already some tools to formally verify Haskell programs:</p>
<ul>
<li><a href="https://github.com/plclub/hs-to-coq" target="_blank" rel="noopener noreferrer">üêì hs-to-coq</a> translation from Haskell to Coq</li>
<li><a href="https://en.wikipedia.org/wiki/Liquid_Haskell" target="_blank" rel="noopener noreferrer">üíß Liquid Haskell</a> verification using <a href="https://en.wikipedia.org/wiki/Satisfiability_modulo_theories" target="_blank" rel="noopener noreferrer">SMT solvers</a></li>
</ul>
<p>In this experiment, we want to check the feasibility of translation from Haskell to Coq:</p>
<ul>
<li>üëç covering all the language without manual configuration or code changes,</li>
<li>üëé even if this is at the cost of a more verbose and low-level translation.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="example">Example<a href="https://formal.land/blog/2024/02/14/experiment-coq-of-hs#example" class="hash-link" aria-label="Direct link to Example" title="Direct link to Example">‚Äã</a></h2>
<p>Here is an example of a Haskell function:</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token hvariable">fixObvious</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">::</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token hvariable">a</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">a</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">a</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">fixObvious</span><span class="token plain"> </span><span class="token hvariable">f</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token hvariable">f</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token hvariable">fixObvious</span><span class="token plain"> </span><span class="token hvariable">f</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>that <code>coq-of-hs</code> translates to this valid Coq code:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">CoFixpoint</span><span class="token plain"> fixObvious </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Val</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Val</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Lam </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">f </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Val</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Val</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">App f </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Val</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">App fixObvious f</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="infrastructure">Infrastructure<a href="https://formal.land/blog/2024/02/14/experiment-coq-of-hs#infrastructure" class="hash-link" aria-label="Direct link to Infrastructure" title="Direct link to Infrastructure">‚Äã</a></h2>
<p>We read the <a href="https://serokell.io/blog/haskell-to-core" target="_blank" rel="noopener noreferrer">Haskell Core</a> representation of Haskell using the GHC plugin system. Thus, we read the exact same code version as the one that is compiled down to assembly code by <a href="https://www.haskell.org/ghc/" target="_blank" rel="noopener noreferrer">GHC</a>, to take into account all compilation options.</p>
<p>Haskell Core is an intermediate representation of Haskell that is close to the lambda calculus and used by the Haskell compiler for various optimizations passes. Here are all the constructors of the&nbsp;<code>Expr</code> type of Haskell Core:</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">data</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Expr</span><span class="token plain"> </span><span class="token hvariable">b</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Var</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">Id</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Lit</span><span class="token plain">   </span><span class="token constant" style="color:#36acaa">Literal</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">App</span><span class="token plain">   </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Expr</span><span class="token plain"> </span><span class="token hvariable">b</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Arg</span><span class="token plain"> </span><span class="token hvariable">b</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Lam</span><span class="token plain">   </span><span class="token hvariable">b</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Expr</span><span class="token plain"> </span><span class="token hvariable">b</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Let</span><span class="token plain">   </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Bind</span><span class="token plain"> </span><span class="token hvariable">b</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Expr</span><span class="token plain"> </span><span class="token hvariable">b</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Case</span><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Expr</span><span class="token plain"> </span><span class="token hvariable">b</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token hvariable">b</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Type</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token constant" style="color:#36acaa">Alt</span><span class="token plain"> </span><span class="token hvariable">b</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Cast</span><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Expr</span><span class="token plain"> </span><span class="token hvariable">b</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Coercion</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Tick</span><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Tickish</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Expr</span><span class="token plain"> </span><span class="token hvariable">b</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Type</span><span class="token plain">  </span><span class="token constant" style="color:#36acaa">Type</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Coercion</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Coercion</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This paper <a href="https://repository.brynmawr.edu/cgi/viewcontent.cgi?article=1015&amp;context=compsci_pubs" target="_blank" rel="noopener noreferrer">System FC, as implemented in GHC</a> presents it as <a href="https://en.wikipedia.org/wiki/System_F" target="_blank" rel="noopener noreferrer">System F</a> plus coercions. We translate Haskell code to an untyped version of the lambda calculus in Coq, with co-induction to allow for infinite data structures:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> Val</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token attribute attr-name punctuation" style="color:#393A34">#[</span><span class="token attribute attr-name" style="color:#00a4db">bypass_check</span><span class="token attribute attr-name punctuation" style="color:#393A34">(</span><span class="token attribute attr-name" style="color:#00a4db">positivity</span><span class="token attribute attr-name punctuation" style="color:#393A34">)</span><span class="token attribute attr-name punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">CoInductive</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Lit </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Lit</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Con </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> App </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Lam </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Case</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> list </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">Case</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Impossible</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">End</span><span class="token plain"> Val</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We make the translation by induction over the Haskell Core representation, and we translate each constructor to a corresponding constructor of the Coq representation. We pretty-print the Coq code directly without using an intermediate representation. We use the <a href="https://github.com/quchen/prettyprinter" target="_blank" rel="noopener noreferrer">prettyprinter</a> package with the two main following primitives:</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token hvariable">concatNest</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">::</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token constant" style="color:#36acaa">Doc</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Doc</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">concatNest</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">group</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">.</span><span class="token plain"> </span><span class="token hvariable">nest</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">.</span><span class="token plain"> </span><span class="token hvariable">vsep</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">concatGroup</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">::</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token constant" style="color:#36acaa">Doc</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Doc</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">concatGroup</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">group</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">.</span><span class="token plain"> </span><span class="token hvariable">vsep</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>to display a sub-term with or without indentation when splitting lines that are too long. This translation works well on all the Haskell expressions that we have tested.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="missing-features">Missing features<a href="https://formal.land/blog/2024/02/14/experiment-coq-of-hs#missing-features" class="hash-link" aria-label="Direct link to Missing features" title="Direct link to Missing features">‚Äã</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="semantics">Semantics<a href="https://formal.land/blog/2024/02/14/experiment-coq-of-hs#semantics" class="hash-link" aria-label="Direct link to Semantics" title="Direct link to Semantics">‚Äã</a></h3>
<p>We have not yet defined a semantics. For now, the terms that we generate in Coq are purely descriptive. We will wait to have examples of things to verify to define semantics that are practical to use.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="type-classes">Type-classes<a href="https://formal.land/blog/2024/02/14/experiment-coq-of-hs#type-classes" class="hash-link" aria-label="Direct link to Type-classes" title="Direct link to Type-classes">‚Äã</a></h3>
<p>We have not yet translated typeclasses. The Haskell Core language hides most of the typeclasses-related code. For example, it represents instances as additional function parameters for functions that have a typeclass constraints. But we still need to declare the functions corresponding to the member of the typeclasses, what we have not done yet.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="multi-file-projects">Multi-file projects<a href="https://formal.land/blog/2024/02/14/experiment-coq-of-hs#multi-file-projects" class="hash-link" aria-label="Direct link to Multi-file projects" title="Direct link to Multi-file projects">‚Äã</a></h3>
<p>We have not yet implemented the translation of multi-file projects. We have only tested the translation of a single-file project.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="standard-library">Standard library<a href="https://formal.land/blog/2024/02/14/experiment-coq-of-hs#standard-library" class="hash-link" aria-label="Direct link to Standard library" title="Direct link to Standard library">‚Äã</a></h3>
<p>Similarly to the handling of multi-file projects, we have not yet tested the translation of projects using external libraries or translating the base library of Haskell.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="strict-positivity">Strict positivity<a href="https://formal.land/blog/2024/02/14/experiment-coq-of-hs#strict-positivity" class="hash-link" aria-label="Direct link to Strict positivity" title="Direct link to Strict positivity">‚Äã</a></h3>
<p>We had to turn off the strict positivity condition for the definition of&nbsp;<code>Val.t</code> in Coq with:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token attribute attr-name punctuation" style="color:#393A34">#[</span><span class="token attribute attr-name" style="color:#00a4db">bypass_check</span><span class="token attribute attr-name punctuation" style="color:#393A34">(</span><span class="token attribute attr-name" style="color:#00a4db">positivity</span><span class="token attribute attr-name punctuation" style="color:#393A34">)</span><span class="token attribute attr-name punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This is for to the case:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Lam </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>where&nbsp;<code>t</code> appears as a parameter of a function (negative position). We do not know if this causes any problem in practice, on values that correspond to well-typed Haskell programs.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="https://formal.land/blog/2024/02/14/experiment-coq-of-hs#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">‚Äã</a></h2>
<p>We have presented an experiment on the translation of Haskell programs to Coq. If you are interested in this project, please get in touch with us at&nbsp;<a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">contact@formal.land</a> or go to the <a href="https://github.com/formal-land/coq-of-hs-experiment" target="_blank" rel="noopener noreferrer">GitHub repository</a> of the project.</p>]]></content>
        <category label="coq-of-hs" term="coq-of-hs"/>
        <category label="Haskell" term="Haskell"/>
        <category label="Coq" term="Coq"/>
        <category label="translation" term="translation"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[The importance of formal verification]]></title>
        <id>https://formal.land/blog/2024/02/02/formal-verification-for-aleph-zero</id>
        <link href="https://formal.land/blog/2024/02/02/formal-verification-for-aleph-zero"/>
        <updated>2024-02-02T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Ensuring Flawless Software in a Flawed World]]></summary>
        <content type="html"><![CDATA[<blockquote>
<p>Ensuring Flawless Software in a Flawed World</p>
</blockquote>
<p>In this blog post, we present what formal verification is and why this is such a valuable tool to improve the security of your applications.</p>
<p><img decoding="async" loading="lazy" alt="Formal verification" src="https://formal.land/assets/images/formal_verification-776211ce14cb5aba1e0a88170d1a3c15.png" width="512" height="512" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Contact</div><div class="admonitionContent_BuS1"><p>If you want to formally verify your codebase to improve the security of your application, contact us at&nbsp;<a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">contact@formal.land</a>! We offer a free audit of your codebase to assess the feasibility of formal verification.</p></div></div>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Thanks</div><div class="admonitionContent_BuS1"><p>The current development of our tool <a href="https://github.com/formal-land/coq-of-rust" target="_blank" rel="noopener noreferrer">coq-of-rust</a>, for the formal verification of Rust code, is made possible thanks to the <a href="https://alephzero.org/" target="_blank" rel="noopener noreferrer">Aleph Zero</a>'s Foundation and its <a href="https://alephzero.org/ecosystem-funding-program" target="_blank" rel="noopener noreferrer">Ecosystem Funding Program</a>. The aim is to develop an extra safe platform to build decentralized applications with formally verified smart contracts.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-is-formal-verification">What is formal verification?<a href="https://formal.land/blog/2024/02/02/formal-verification-for-aleph-zero#what-is-formal-verification" class="hash-link" aria-label="Direct link to What is formal verification?" title="Direct link to What is formal verification?">‚Äã</a></h2>
<p>Formal verification is a set of techniques to check for the complete correctness of a program, reasoning at a symbolic level rather than executing a particular instance of the code. By symbolic reasoning, we mean following the values of the variables by tracking their names and constraints, without necessarily giving them an example value. This is what we would do in our heads to understand a code where a variable&nbsp;<code>username</code> appears, following which functions it is given to, to know where we use the user name. The concrete user name that we consider is irrelevant, although some people prefer to think with an example.</p>
<p>In formal verification, we rely on precise mathematical reasoning to make sure that there are no mistakes or missing cases. We check this reasoning with a dedicated program (<a href="https://en.wikipedia.org/wiki/Satisfiability_modulo_theories" target="_blank" rel="noopener noreferrer">SMT</a> solver, <a href="https://coq.inria.fr/" target="_blank" rel="noopener noreferrer">Coq</a> proof system, ...). Indeed, as programs grow in complexity, it could be easy to forget an&nbsp;<code>if</code> branch or an error case.</p>
<p>For example, to say that the following Rust program is valid:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> Return the maximum of </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> and </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">b</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fn get_max</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> u128</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> b</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> u128</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> u128 </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> a </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> b </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        b</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>we reason on two cases (reasoning by disjunction):</p>
<ul>
<li><code>a &gt; b</code> where&nbsp;<code>a</code> is the maximum,</li>
<li><code>a &lt;= b</code> where&nbsp;<code>b</code> is the maximum,</li>
</ul>
<p>with the values of&nbsp;<code>a</code> and&nbsp;<code>b</code> being irrelevant (symbolic). In both cases, we can conclude that&nbsp;<code>get_max</code> returns the maximum.</p>
<p>This is in contrast with testing, where we need to execute the program with all possible instances of&nbsp;<code>a</code> and&nbsp;<code>b</code> to check that the program is correct with 100% certainty. This is infeasible in this case as the type&nbsp;<code>u128</code> is too large to be tested exhaustively: there are&nbsp;<code>2^256</code> possible values for&nbsp;<code>a</code> and&nbsp;<code>b</code>, meaning <code>115792089237316195423570985008687907853269984665640564039457584007913129639936</code> possible values!</p>
<p>A program is shown correct with respect to an expected behavior, called a <em>formal specification</em>. This is expressed in a mathematical language to be non-ambiguous. For example, we can specify the behavior of the previous program as:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">FORALL (a b : u128),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  (get_max a b = a OR get_max a b = b) AND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  (get_max a b &gt;= a AND get_max a b &gt;= b)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>stating that we indeed return the maximum of&nbsp;<code>a</code> and&nbsp;<code>b</code>.</p>
<p>When a program is formally verified, we are mathematically sure it will always follow its specifications. This is a way to eliminate all bugs, as long as we have a complete specification of what it is supposed to do or not do. This corresponds to the highest level of Evaluation Assurance Level, <a href="https://en.wikipedia.org/wiki/Evaluation_Assurance_Level#EAL7:_Formally_Verified_Design_and_Tested" target="_blank" rel="noopener noreferrer">EAL7</a>. This is used for critical applications, such as space rocket software, where a single bug can be extremely expensive (the loss of a rocket!).</p>
<p>There are various formal verification tools, such as the proof system <a href="https://coq.inria.fr/" target="_blank" rel="noopener noreferrer">Coq</a>. The C compiler <a href="https://en.wikipedia.org/wiki/CompCert" target="_blank" rel="noopener noreferrer">CompCert</a> is an example of large software verified in Coq. It is proven correct, in contrast to most other C compilers that contain <a href="https://users.cs.utah.edu/~regehr/papers/pldi11-preprint.pdf" target="_blank" rel="noopener noreferrer">subtle bugs</a>. CompCert is now used by Airbus to compile C programs embedded in planes&nbsp;üõ´.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="why-is-it-such-a-useful-tool">Why is it such a useful tool?<a href="https://formal.land/blog/2024/02/02/formal-verification-for-aleph-zero#why-is-it-such-a-useful-tool" class="hash-link" aria-label="Direct link to Why is it such a useful tool?" title="Direct link to Why is it such a useful tool?">‚Äã</a></h2>
<p>Formal verification is extremely useful as it can anticipate all the bugs by exploring all possible execution cases of a program. Here is a quote from <a href="https://en.wikipedia.org/wiki/Formal_verification" target="_blank" rel="noopener noreferrer">Edsger W. Dijkstra</a>:</p>
<blockquote>
<p>Program testing can be used to show the presence of bugs, but never to show their absence!</p>
</blockquote>
<p>It offers the possibility to make software that never fails. This is often required for applications with human life at stake, such as planes or medical devices. But it can also be useful for applications where a single bug can be extremely expensive, such as financial applications.</p>
<p>Smart contracts are a good example of such applications. They are programs that are executed on a blockchain and are used to manage assets worth billions of dollars. A single bug in a smart contract can lead to the loss of all the assets managed by the contract. In the first half of 2023, some estimate that attacks on web3 platforms resulted in a loss of <a href="https://www.linkedin.com/pulse/h1-2023-global-web3-security-report-aml-analysis-crypto-regulatory/" target="_blank" rel="noopener noreferrer">$655.61 million</a>, with most of these losses due to bugs in smart contracts. These bugs could be prevented using formally verified smart contracts.</p>
<p>Finally, formal verification is useful to improve the quality of a program by enforcing the need to use:</p>
<ul>
<li>clear programming constructs,</li>
<li>an explicit specification of the behavior of the program.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="comparison-of-formal-verification-and-testing">Comparison of formal verification and testing<a href="https://formal.land/blog/2024/02/02/formal-verification-for-aleph-zero#comparison-of-formal-verification-and-testing" class="hash-link" aria-label="Direct link to Comparison of formal verification and testing" title="Direct link to Comparison of formal verification and testing">‚Äã</a></h2>
<p>Compared to testing, formal verification is more complex as:</p>
<ul>
<li>it typically takes much more time to formally verify a program than to test it on a reasonable set of inputs,</li>
<li>it requires a formal specification of the program, which is not always available,</li>
<li>it requires some specific expertise to use the formal verification tools and to write the specifications.</li>
</ul>
<p>In addition, formal verification assumes a certain model of the environment of the program, which is not always accurate. When actually executing the code, we also exercise all the dependencies (libraries, operating system, network, ...) that might cause issues at runtime.</p>
<p>However, formal verification is the only way to have an exhaustive check of the program. It verifies all corner cases, such as integer overflows, or hard-to-reproduce issues, such as concurrency bugs. We recommend combining both approaches as they do not catch the same kinds of bugs.</p>
<p>At <a href="https://formal.land/" target="_blank" rel="noopener noreferrer">Formal Land</a>, we consider it critical to lower the cost of formal verification to apply it to a larger scope of programs and prevent more bugs and attacks. We work on the formal verification of Rust with <a href="https://github.com/formal-land/coq-of-rust" target="_blank" rel="noopener noreferrer">coq-of-rust</a> and OCaml with <a href="https://github.com/formal-land/coq-of-ocaml" target="_blank" rel="noopener noreferrer">coq-of-ocaml</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="https://formal.land/blog/2024/02/02/formal-verification-for-aleph-zero#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">‚Äã</a></h2>
<p>Formal verification is a powerful tool to improve the security of your applications. It is the only way to prevent all bugs by exploring all possible executions of your programs. It complements existing testing methods. It is particularly useful for critical applications, such as smart contracts, where a single bug can be extremely expensive.</p>]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Upgrade the Rust version of coq-of-rust]]></title>
        <id>https://formal.land/blog/2024/01/18/update-coq-of-rust</id>
        <link href="https://formal.land/blog/2024/01/18/update-coq-of-rust"/>
        <updated>2024-01-18T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[We continue our work on the coq-of-rust tool to formally verify Rust programs with the Coq proof assistant. We have upgraded the Rust version that we support, simplified the translation of the traits, and are adding better support for the standard library of Rust.]]></summary>
        <content type="html"><![CDATA[<p>We continue our work on the <a href="https://github.com/formal-land/coq-of-rust" target="_blank" rel="noopener noreferrer">coq-of-rust</a> tool to formally verify Rust programs with the <a href="https://coq.inria.fr/" target="_blank" rel="noopener noreferrer">Coq proof assistant</a>. We have upgraded the Rust version that we support, simplified the translation of the traits, and are adding better support for the standard library of Rust.</p>
<p>Overall, we are now able to translate <strong>about 80%</strong> of the Rust examples from the <a href="https://doc.rust-lang.org/stable/rust-by-example/" target="_blank" rel="noopener noreferrer">Rust by Example</a> book into valid Coq files. This means we support a large subset of the Rust language.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Purchase</div><div class="admonitionContent_BuS1"><p>To formally verify your Rust codebase and improve the security of your application, email us at&nbsp;<a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">contact@formal.land</a>! Formal verification is the only way to prevent all bugs by exploring all possible executions of your programs&nbsp;üéØ.</p></div></div>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Thanks</div><div class="admonitionContent_BuS1"><p>This work and the development of <a href="https://github.com/formal-land/coq-of-rust" target="_blank" rel="noopener noreferrer">coq-of-rust</a> is made possible thanks to the <a href="https://alephzero.org/" target="_blank" rel="noopener noreferrer">Aleph Zero</a>'s Foundation, to develop an extra safe platform to build decentralized applications with formally verified smart contracts.</p></div></div>
<p><img decoding="async" loading="lazy" alt="Rust rooster" src="https://formal.land/assets/images/rooster-2cc330eba42b601293b34c5d090b6bae.png" width="512" height="512" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="upgrade-of-the-rust-version">Upgrade of the Rust version<a href="https://formal.land/blog/2024/01/18/update-coq-of-rust#upgrade-of-the-rust-version" class="hash-link" aria-label="Direct link to Upgrade of the Rust version" title="Direct link to Upgrade of the Rust version">‚Äã</a></h2>
<p>The tool&nbsp;<code>coq-of-rust</code> is tied to a particular version of the Rust compiler that we use to parse and type-check a <code>cargo</code> project. We now support the&nbsp;<code>nightly-2023-12-15</code> version of Rust, up from&nbsp;<code>nightly-2023-04-30</code>. Most of the changes were minor, but it is good to handle these regularly to have smooth upgrades. The corresponding pull request is <a href="https://github.com/formal-land/coq-of-rust/pull/445" target="_blank" rel="noopener noreferrer">coq-of-rust/pull/445</a>. We also got more <a href="https://github.com/rust-lang/rust-clippy" target="_blank" rel="noopener noreferrer">Clippy</a> warnings thanks to the new version of Rust.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="simplify-the-translation-of-traits">Simplify the translation of traits<a href="https://formal.land/blog/2024/01/18/update-coq-of-rust#simplify-the-translation-of-traits" class="hash-link" aria-label="Direct link to Simplify the translation of traits" title="Direct link to Simplify the translation of traits">‚Äã</a></h2>
<p>The traits of Rust are similar to the <a href="https://coq.inria.fr/refman/addendum/type-classes.html" target="_blank" rel="noopener noreferrer">type-classes of Coq</a>. This is how we translate traits to Coq.</p>
<p>But there are a lot of subtle differences between the two languages. The type-class inference mechanism of Coq does not work all the time on generated Rust code, even when adding a lot of code annotations. We think that the only reliable way to translate Rust traits would be to explicit the implementations inferred by the Rust compiler, but the Rust compiler currently throws away this information.</p>
<p>Instead, our new solution is to use a Coq tactic:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">(** Try first to infer the trait instance, and if unsuccessful, delegate it at</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">    proof time. *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Ltac</span><span class="token plain"> get_method method </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  exact </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pure </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">method </span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  exact </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_method method</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>that first tries to infer the trait instance for a particular method, and if it fails, delegates its definition to the user at proof time. This is a bit unsafe, as a user could provide invalid instances at proof time, by giving some custom instance definitions instead of the ones generated by&nbsp;<code>coq-of-rust</code>. So, one should be careful to only apply generated instances to fill the hole made by this tactic in case of failure. We believe this to be a reasonable assumption that we could enforce someday if needed.</p>
<p>We are also starting to remove the trait constraints on polymorphic functions (the&nbsp;<code>where</code> clauses). We start by doing it in our manual definition of the standard library of Rust. The rationale is that we can provide the actual trait instances at proof time by having the right hypothesis replicating the constraints of the&nbsp;<code>where</code> clauses. Having fewer&nbsp;<code>where</code> clauses reduces the complexity of the type inference of Coq on the generated code. There are still some cases that we need to clarify, for example, the handling of <a href="https://doc.rust-lang.org/rust-by-example/generics/assoc_items/types.html" target="_blank" rel="noopener noreferrer">associated types</a> in the absence of traits.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="handling-more-of-the-standard-library">Handling more of the standard library<a href="https://formal.land/blog/2024/01/18/update-coq-of-rust#handling-more-of-the-standard-library" class="hash-link" aria-label="Direct link to Handling more of the standard library" title="Direct link to Handling more of the standard library">‚Äã</a></h2>
<p>We have a definition of the standard library of Rust, mainly composed of axiomatized<sup><a href="https://formal.land/blog/2024/01/18/update-coq-of-rust#user-content-fn-1-a72c2c" id="user-content-fnref-1-a72c2c" data-footnote-ref="true" aria-describedby="footnote-label">1</a></sup> definitions, in these three folders:</p>
<ul>
<li><a href="https://github.com/formal-land/coq-of-rust/tree/main/CoqOfRust/alloc" target="_blank" rel="noopener noreferrer">CoqOfRust/alloc</a></li>
<li><a href="https://github.com/formal-land/coq-of-rust/tree/main/CoqOfRust/core" target="_blank" rel="noopener noreferrer">CoqOfRust/core</a></li>
<li><a href="https://github.com/formal-land/coq-of-rust/tree/main/CoqOfRust/std" target="_blank" rel="noopener noreferrer">CoqOfRust/std</a></li>
</ul>
<p>By adding more of these axioms, as well as with some small changes to the&nbsp;<code>coq-of-rust</code> tool, we are now able to successfully translate around 80% of the examples of the <a href="https://doc.rust-lang.org/stable/rust-by-example/" target="_blank" rel="noopener noreferrer">Rust by Example</a> book. There can still be some challenges on larger programs, but this showcases the good support of&nbsp;<code>coq-of-rust</code> for the Rust language.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="https://formal.land/blog/2024/01/18/update-coq-of-rust#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">‚Äã</a></h2>
<p>We are continuing to improve our tool&nbsp;<code>coq-of-rust</code> to support more of the Rust language and are making good progress. If you need to improve the security of critical applications written in Rust, contact us at&nbsp;<a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">contact@formal.land</a> to start formally verifying your code!</p>
<section data-footnotes="true" class="footnotes"><h2 class="anchor anchorWithStickyNavbar_LWe7 sr-only" id="footnote-label">Footnotes<a href="https://formal.land/blog/2024/01/18/update-coq-of-rust#footnote-label" class="hash-link" aria-label="Direct link to Footnotes" title="Direct link to Footnotes">‚Äã</a></h2>
<ol>
<li id="user-content-fn-1-a72c2c">
<p>An axiom in Coq is either a theorem whose proof is admitted, or a function/constant definition left for latter. This is the equivalent in Rust of the&nbsp;<code>todo!</code> macro. <a href="https://formal.land/blog/2024/01/18/update-coq-of-rust#user-content-fnref-1-a72c2c" data-footnote-backref="" aria-label="Back to reference 1" class="data-footnote-backref">‚Ü©</a></p>
</li>
</ol>
</section>]]></content>
        <category label="coq-of-rust" term="coq-of-rust"/>
        <category label="Rust" term="Rust"/>
        <category label="Coq" term="Coq"/>
        <category label="Aleph-Zero" term="Aleph-Zero"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Translating Rust match patterns to Coq with coq-of-rust]]></title>
        <id>https://formal.land/blog/2024/01/04/rust-translating-match</id>
        <link href="https://formal.land/blog/2024/01/04/rust-translating-match"/>
        <updated>2024-01-04T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Our tool coq-of-rust enables formal verification of ü¶Ä&nbsp;Rust code to make sure that a program has no bugs. This technique checks all possible execution paths using mathematical techniques. This is important for example to ensure the security of smart contracts written in Rust language.]]></summary>
        <content type="html"><![CDATA[<p>Our tool <a href="https://github.com/formal-land/coq-of-rust" target="_blank" rel="noopener noreferrer">coq-of-rust</a> enables <a href="https://en.wikipedia.org/wiki/Formal_verification" target="_blank" rel="noopener noreferrer">formal verification</a> of <a href="https://www.rust-lang.org/" target="_blank" rel="noopener noreferrer">ü¶Ä&nbsp;Rust</a> code to make sure that a program has no bugs. This technique checks all possible execution paths using mathematical techniques. This is important for example to ensure the security of smart contracts written in Rust language.</p>
<p>Our tool <code>coq-of-rust</code> works by translating Rust programs to the general proof system <a href="https://coq.inria.fr/" target="_blank" rel="noopener noreferrer">üêì&nbsp;Coq</a>. Here we explain how we translate<a href="https://doc.rust-lang.org/book/ch06-02-match.html" target="_blank" rel="noopener noreferrer">&nbsp;<code>match</code> patterns</a> from Rust to Coq. The specificity of Rust patterns is to be able to match values either by value or reference.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Purchase</div><div class="admonitionContent_BuS1"><p>To formally verify your Rust codebase and improve the security of your application, email us at&nbsp;<a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">contact@formal.land</a>! Formal verification is the only way to prevent all bugs by exploring all possible executions of your program.</p></div></div>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Thanks</div><div class="admonitionContent_BuS1"><p>This work and the development of <a href="https://github.com/formal-land/coq-of-rust" target="_blank" rel="noopener noreferrer">coq-of-rust</a> is made possible thanks to the <a href="https://alephzero.org/" target="_blank" rel="noopener noreferrer">Aleph Zero</a>'s Foundation, to develop an extra safe platform to build decentralized applications with formally verified smart contracts.</p></div></div>
<p><img decoding="async" loading="lazy" alt="Rust rooster" src="https://formal.land/assets/images/rust-rooster-46899f1cbd5eacd04a10ed1fbe28d497.png" width="512" height="512" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="rust-example">Rust example&nbsp;ü¶Ä<a href="https://formal.land/blog/2024/01/04/rust-translating-match#rust-example" class="hash-link" aria-label="Direct link to Rust example&nbsp;ü¶Ä" title="Direct link to Rust example&nbsp;ü¶Ä">‚Äã</a></h2>
<p>To illustrate the pattern matching in Rust, we will use the following example featuring a match by reference:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">pub</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">crate</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">is_option_equal</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">A</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    is_equal</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fn</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token class-name">A</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token class-name">A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">bool</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    lhs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Option</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">A</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rhs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token class-name">A</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">bool</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> lhs </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">None</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Some</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">ref</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">is_equal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rhs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We take a function&nbsp;<code>is_equal</code> as a parameter, operating only on references to the type&nbsp;<code>A</code>. We apply it to compare two values&nbsp;<code>lhs</code> and&nbsp;<code>rhs</code>:</p>
<ul>
<li>if&nbsp;<code>lhs</code> is&nbsp;<code>None</code>, we return&nbsp;<code>false</code>,</li>
<li>if&nbsp;<code>lhs</code> is&nbsp;<code>Some</code>, we get its value by reference and apply&nbsp;<code>is_equal</code>.</li>
</ul>
<p>When we apply the pattern:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token class-name">Some</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">ref</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>we do something interesting: we read the value of&nbsp;<code>lhs</code> to know if we are in a&nbsp;<code>Some</code> case but leave it in place and return&nbsp;<code>value</code> the reference to its content.</p>
<p>To simulate this behavior in Coq, we need to match in two steps:</p>
<ol>
<li>match the value of&nbsp;<code>lhs</code> to know if we are in a&nbsp;<code>Some</code> case or not,</li>
<li>if we are in a&nbsp;<code>Some</code> case, create the reference to the content of a&nbsp;<code>Some</code> case based on the reference to&nbsp;<code>lhs</code>.</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="coq-translation">Coq translation&nbsp;üêì<a href="https://formal.land/blog/2024/01/04/rust-translating-match#coq-translation" class="hash-link" aria-label="Direct link to Coq translation&nbsp;üêì" title="Direct link to Coq translation&nbsp;üêì">‚Äã</a></h2>
<p>The Coq translation that our tool <a href="https://github.com/formal-land/coq-of-rust" target="_blank" rel="noopener noreferrer">coq-of-rust</a> generates is the following:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> is_option_equal</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">is_equal </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ref A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ref A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> M bool</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lhs </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> core</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">option</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Option</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rhs </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ref A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M bool</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> is_equal </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc is_equal </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> lhs </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc lhs </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> rhs </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc rhs </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Val bool</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    match_operator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      lhs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> Œ≥ </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read Œ≥ </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> core</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">option</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Option</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">None </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">break_match</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">end</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          M </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Val bool</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> Œ≥ </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read Œ≥ </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> core</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">option</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Option</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Some </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> Œ≥</span><span class="token number" style="color:#36acaa">0_0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> Œ≥</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"Some.0"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> value </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">borrow Œ≥</span><span class="token number" style="color:#36acaa">0_0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ref A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ref A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> M bool</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read is_equal </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ref A </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read value </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ref A </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read rhs </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> bool</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">call </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Œ±</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc Œ±</span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">break_match</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">end</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          M </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Val bool</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read Œ±</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We run the&nbsp;<code>match_operator</code> on&nbsp;<code>lhs</code> and the two branches of the&nbsp;<code>match</code>. This operator is of type:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> match_operator </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A B </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">scrutinee </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">arms </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">A </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> M B</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    M B </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It takes a&nbsp;<code>scrutinee</code> value to match as a parameter, and runs a sequence of functions&nbsp;<code>arms</code> on it. Each function&nbsp;<code>arms</code> takes the value of the&nbsp;<code>scrutinee</code> and returns a monadic value&nbsp;<code>M B</code>. This monadic value can either be a success value if the pattern matches, or a special failure value if the pattern does not match. We evaluate the branches until one succeeds.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="none-branch"><code>None</code> branch<a href="https://formal.land/blog/2024/01/04/rust-translating-match#none-branch" class="hash-link" aria-label="Direct link to none-branch" title="Direct link to none-branch">‚Äã</a></h3>
<p>The&nbsp;<code>None</code> branch is the simplest one. We read the value at the address given by&nbsp;<code>lhs</code> (we represent each Rust variable by its address) and match it with the&nbsp;<code>None</code> constructor:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> Œ≥ </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read Œ≥ </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> core</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">option</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Option</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">None </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">break_match</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">end</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  M </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Val bool</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If it matches, we return&nbsp;<code>false</code>. If it does not, we return the special value&nbsp;<code>M.break_match</code> to indicate that the pattern does not match.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="some-branch"><code>Some</code> branch<a href="https://formal.land/blog/2024/01/04/rust-translating-match#some-branch" class="hash-link" aria-label="Direct link to some-branch" title="Direct link to some-branch">‚Äã</a></h3>
<p>In the&nbsp;<code>Some</code> branch, we first also read the value at the address given by&nbsp;<code>lhs</code> and match it with the&nbsp;<code>Some</code> constructor:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> Œ≥ </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read Œ≥ </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> core</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">option</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Option</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Some </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> Œ≥</span><span class="token number" style="color:#36acaa">0_0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> Œ≥</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"Some.0"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> value </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">borrow Œ≥</span><span class="token number" style="color:#36acaa">0_0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ref A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ref A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> M bool</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read is_equal </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ref A </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read value </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ref A </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read rhs </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> bool</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">call </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Œ±</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc Œ±</span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">break_match</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">end</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  M </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Val bool</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If we are in that case, we create the value:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> Œ≥</span><span class="token number" style="color:#36acaa">0_0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> Œ≥</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"Some.0"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>with the address of the first field of the&nbsp;<code>Some</code> constructor, relative to the address of&nbsp;<code>lhs</code> given in&nbsp;<code>Œ≥</code>. We define the operator&nbsp;<code>.["Some.0"]</code> when we define the option type and generate such definitions for all user-defined enum types.</p>
<p>We then encapsulate the address&nbsp;<code>Œ≥0_0</code> in a proper Rust reference:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> value </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">borrow Œ≥</span><span class="token number" style="color:#36acaa">0_0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>of type&nbsp;<code>ref A</code> in the original Rust code. Finally, we call the function&nbsp;<code>is_equal</code> on the two references&nbsp;<code>value</code> and&nbsp;<code>rhs</code>, with some boilerplate code to read and allocate the variables.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="general-translation">General translation<a href="https://formal.land/blog/2024/01/04/rust-translating-match#general-translation" class="hash-link" aria-label="Direct link to General translation" title="Direct link to General translation">‚Äã</a></h2>
<p>We generalize this translation to all patterns by:</p>
<ul>
<li>flattening all the or patterns <code>|</code> so that only patterns with a single choice remain,</li>
<li>evaluating each match branch in order with the&nbsp;<code>match_operator</code> operator,</li>
<li>in each branch, evaluating the inner patterns in order. This evaluation might fail at any point if the pattern does not match. In this case, we return the special value&nbsp;<code>M.break_match</code> and continue with the next branch.</li>
</ul>
<p>At least one branch should succeed as the Rust compiler checks that all cases are covered. We still have a special value&nbsp;<code>M.impossible</code> in Coq for the case where no patterns match and satisfy the type checker.</p>
<p>We distinguish and handle the following kind of patterns (and all their combinations):</p>
<ul>
<li>wild patterns&nbsp;<code>_</code>,</li>
<li>binding patterns&nbsp;<code>(ref) name</code> or&nbsp;<code>(ref) name as pattern</code> (the&nbsp;<code>ref</code> keyword is optional),</li>
<li>struct patterns&nbsp;<code>Name { field1: pattern1, ... }</code> or&nbsp;<code>Name(pattern1, ...)</code></li>
<li>tuple patterns&nbsp;<code>(pattern1, ...)</code>,</li>
<li>literal patterns&nbsp;<code>12</code>, <code>true</code>, ...,</li>
<li>slice patterns&nbsp;<code>[first, second, tail @ ..]</code>,</li>
<li>dereference patterns&nbsp;<code>&amp;pattern</code>.</li>
</ul>
<p>This was enough to cover all of our examples. The Rust compiler can also automatically add some&nbsp;<code>ref</code> patterns when matching on references. We do not need to handle this case as this is automatically done by the Rust compiler during its compilation to the intermediate&nbsp;<a href="https://rustc-dev-guide.rust-lang.org/thir.html" target="_blank" rel="noopener noreferrer">THIR</a> representation, and e directly read the THIR code.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="https://formal.land/blog/2024/01/04/rust-translating-match#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">‚Äã</a></h2>
<p>In this blog post, we have presented how we translate Rust patterns to the proof system Coq. The difficult part is handling the&nbsp;<code>ref</code> patterns, which we do by matching in two steps: matching on the values and then computing the addresses of the sub-fields.</p>
<p>If you have Rust smart contracts or programs to verify, feel free to email us at&nbsp;<a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">contact@formal.land</a>. We will be happy to help!</p>]]></content>
        <category label="coq-of-rust" term="coq-of-rust"/>
        <category label="Rust" term="Rust"/>
        <category label="Coq" term="Coq"/>
        <category label="Aleph-Zero" term="Aleph-Zero"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Verifying an ERC-20 smart contract in Rust]]></title>
        <id>https://formal.land/blog/2023/12/13/rust-verify-erc-20-smart-contract</id>
        <link href="https://formal.land/blog/2023/12/13/rust-verify-erc-20-smart-contract"/>
        <updated>2023-12-13T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Our tool coq-of-rust enables formal verification of ü¶Ä&nbsp;Rust code to make sure that a program has no bugs given a precise specification. We work by translating Rust programs to the general proof system üêì&nbsp;Coq.]]></summary>
        <content type="html"><![CDATA[<p>Our tool <a href="https://github.com/formal-land/coq-of-rust" target="_blank" rel="noopener noreferrer">coq-of-rust</a> enables formal verification of <a href="https://www.rust-lang.org/" target="_blank" rel="noopener noreferrer">ü¶Ä&nbsp;Rust</a> code to make sure that a program has no bugs given a precise specification. We work by translating Rust programs to the general proof system <a href="https://coq.inria.fr/" target="_blank" rel="noopener noreferrer">üêì&nbsp;Coq</a>.</p>
<p>Here, we show how we formally verify an <a href="https://github.com/paritytech/ink/blob/master/integration-tests/erc20/lib.rs" target="_blank" rel="noopener noreferrer">ERC-20 smart contract</a> written in Rust for the <a href="https://alephzero.org/" target="_blank" rel="noopener noreferrer">Aleph Zero</a> blockchain. <a href="https://en.wikipedia.org/wiki/Ethereum#ERC20" target="_blank" rel="noopener noreferrer">ERC-20</a> smart contracts are used to create new kinds of tokens in an existing blockchain. Examples are stablecoins such as the <a href="https://tether.to/" target="_blank" rel="noopener noreferrer">üí≤USDT</a>.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Purchase</div><div class="admonitionContent_BuS1"><p>To formally verify your Rust codebase and improve the security of your application, email us at&nbsp;<a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">contact@formal.land</a>! Formal verification is the only way to prevent all bugs by exploring all possible executions of your program.</p></div></div>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Thanks</div><div class="admonitionContent_BuS1"><p>This work and the development of <a href="https://github.com/formal-land/coq-of-rust" target="_blank" rel="noopener noreferrer">coq-of-rust</a> is made possible thanks to the <a href="https://alephzero.org/" target="_blank" rel="noopener noreferrer">Aleph Zero</a>'s Foundation, to develop an extra safe platform to build decentralized applications with formally verified smart contracts.</p></div></div>
<p><img decoding="async" loading="lazy" alt="Rooster verifying" src="https://formal.land/assets/images/rooster-verifying-63b330c8faca80da781fcaf008f79dbe.png" width="512" height="512" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="smart-contract-code">Smart contract code&nbsp;ü¶Ä<a href="https://formal.land/blog/2023/12/13/rust-verify-erc-20-smart-contract#smart-contract-code" class="hash-link" aria-label="Direct link to Smart contract code&nbsp;ü¶Ä" title="Direct link to Smart contract code&nbsp;ü¶Ä">‚Äã</a></h2>
<p>Here is the Rust code of the smart contract that we want to verify:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token attribute attr-name" style="color:#00a4db">#[ink::contract]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">mod</span><span class="token plain"> </span><span class="token module-declaration namespace" style="opacity:0.7">erc20</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">use</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">ink</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token namespace" style="opacity:0.7">storage</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token class-name">Mapping</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token attribute attr-name" style="color:#00a4db">#[ink(storage)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token attribute attr-name" style="color:#00a4db">#[derive(Default)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token type-definition class-name">Erc20</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        total_supply</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Balance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        balances</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Mapping</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">AccountId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Balance</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        allowances</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Mapping</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">AccountId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">AccountId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Balance</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token attribute attr-name" style="color:#00a4db">#[ink(event)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token type-definition class-name">Transfer</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token attribute attr-name" style="color:#00a4db">#[ink(event)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token type-definition class-name">Approval</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token attribute attr-name" style="color:#00a4db">#[derive(Debug, PartialEq, Eq)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token attribute attr-name" style="color:#00a4db">#[ink::scale_derive(Encode, Decode, TypeInfo)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">enum</span><span class="token plain"> </span><span class="token type-definition class-name">Error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token type-definition class-name">Result</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">T</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">core</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token namespace" style="opacity:0.7">result</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token class-name">Result</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Error</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">impl</span><span class="token plain"> </span><span class="token class-name">Erc20</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token attribute attr-name" style="color:#00a4db">#[ink(constructor)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">new</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">total_supply</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Balance</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Self</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> balances </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Mapping</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">default</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> caller </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Self</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">env</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">caller</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            balances</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">insert</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">caller</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">total_supply</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">Self</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">env</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">emit_event</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Transfer</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                from</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">None</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                to</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Some</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">caller</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> total_supply</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">Self</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                total_supply</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                balances</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                allowances</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Default</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">default</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token attribute attr-name" style="color:#00a4db">#[ink(message)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">total_supply</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">Balance</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">total_supply</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token attribute attr-name" style="color:#00a4db">#[ink(message)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">balance_of</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> owner</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">AccountId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">Balance</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">balance_of_impl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">owner</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token attribute attr-name" style="color:#00a4db">#[inline]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">balance_of_impl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> owner</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token class-name">AccountId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">Balance</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">balances</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">owner</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">unwrap_or_default</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token attribute attr-name" style="color:#00a4db">#[ink(message)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">allowance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> owner</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">AccountId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> spender</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">AccountId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">Balance</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">allowance_impl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">owner</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">spender</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token attribute attr-name" style="color:#00a4db">#[inline]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">allowance_impl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> owner</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token class-name">AccountId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> spender</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token class-name">AccountId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">Balance</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">allowances</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">owner</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> spender</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">unwrap_or_default</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token attribute attr-name" style="color:#00a4db">#[ink(message)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">transfer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> to</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">AccountId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Balance</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">Result</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> from </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">env</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">caller</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">transfer_from_to</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">from</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">to</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token attribute attr-name" style="color:#00a4db">#[ink(message)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">approve</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> spender</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">AccountId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Balance</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">Result</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> owner </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">env</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">caller</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">allowances</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">insert</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">owner</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">spender</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">env</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">emit_event</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Approval</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                owner</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                spender</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                value</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">Ok</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token attribute attr-name" style="color:#00a4db">#[ink(message)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">transfer_from</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            from</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">AccountId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            to</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">AccountId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Balance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">Result</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> caller </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">env</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">caller</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> allowance </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">allowance_impl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">from</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">caller</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> allowance </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> value </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token class-name">Err</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Error</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">InsufficientAllowance</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">transfer_from_to</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">from</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">to</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">?</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// We checked that allowance &gt;= value</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token attribute attr-name" style="color:#00a4db">#[allow(clippy::arithmetic_side_effects)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">allowances</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">insert</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">from</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">caller</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">allowance </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">Ok</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">transfer_from_to</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            from</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token class-name">AccountId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            to</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token class-name">AccountId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Balance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">Result</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> from_balance </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">balance_of_impl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">from</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> from_balance </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> value </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token class-name">Err</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Error</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">InsufficientBalance</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// We checked that from_balance &gt;= value</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token attribute attr-name" style="color:#00a4db">#[allow(clippy::arithmetic_side_effects)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">balances</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">insert</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">from</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">from_balance </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> to_balance </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">balance_of_impl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">to</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">balances</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">insert</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">to</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">to_balance</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">checked_add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">unwrap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">env</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">emit_event</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Transfer</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                from</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Some</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">from</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                to</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Some</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">to</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                value</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">Ok</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This whole code is rather short and contains no loops, which will simplify our verification process. It uses a lot of macros, such as <code>#[ink(message)]</code>, that are specific to the <a href="https://use.ink/" target="_blank" rel="noopener noreferrer">ink!</a> language for smart contracts, built on top of Rust. To verify this smart contract, we removed all the macros and added a mock of the dependencies, such as <code>ink::storage::Mapping</code> to get a map data structure.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-coq-translation">The Coq translation&nbsp;üêì<a href="https://formal.land/blog/2023/12/13/rust-verify-erc-20-smart-contract#the-coq-translation" class="hash-link" aria-label="Direct link to The Coq translation&nbsp;üêì" title="Direct link to The Coq translation&nbsp;üêì">‚Äã</a></h2>
<p>By running our tool <a href="https://github.com/formal-land/coq-of-rust" target="_blank" rel="noopener noreferrer">coq-of-rust</a> we automatically obtain the corresponding Coq code for the contract <a href="https://github.com/formal-land/coq-of-rust/blob/main/CoqOfRust/examples/default/examples/ink_contracts/erc20.v" target="_blank" rel="noopener noreferrer">erc20.v</a>. Here is an extract for the <code>transfer</code> function:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">(*</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">    fn transfer(&amp;mut self, to: AccountId, value: Balance) -&gt; Result&lt;()&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">        let from = self.env().caller();</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">        self.transfer_from_to(&amp;from, &amp;to, value)</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">*)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> transfer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> mut_ref ltac</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">to </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AccountId</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ltac</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Balance</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M ltac</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Result unit</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> self </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Val </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mut_ref ltac</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc self </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> to </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Val erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AccountId</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc to </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> value </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Val ltac</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Balance</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc value </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> from </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Val erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AccountId</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> mut_ref erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read self </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Env</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">call </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"env"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">borrow </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">deref Œ±</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Val erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Env</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc Œ±</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AccountId</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">call </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Env</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"caller"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">borrow Œ±</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc Œ±</span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> mut_ref erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read self </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> u128</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read value </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> core</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t unit erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Error</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">call</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"transfer_from_to"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">borrow from</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">borrow to</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Val </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">core</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t unit erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Error</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc Œ±</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read Œ±</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>More details of the translation are given in previous blog posts, but basically:</p>
<ul>
<li>we make explicit all memory and implicit operations (like borrowing and dereferencing),</li>
<li>we apply a monadic translation to chain the primitive operations with <code>let*</code>.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="proof-strategy">Proof strategy<a href="https://formal.land/blog/2023/12/13/rust-verify-erc-20-smart-contract#proof-strategy" class="hash-link" aria-label="Direct link to Proof strategy" title="Direct link to Proof strategy">‚Äã</a></h2>
<p><img decoding="async" loading="lazy" alt="Proof strategy" src="https://formal.land/assets/images/proof-strategy-4de97ecb8d2dd42177d8ec15a76a5e02.png" width="512" height="512" class="img_ev3q"></p>
<p>We verify the code in two steps:</p>
<ol>
<li>Show that a simpler, purely functional Coq code can simulate all the smart contract code.</li>
<li>Show that the simulation is correct.</li>
</ol>
<p>That way, we can eliminate all the memory-related operations by showing the equivalence with a simulation. Then, we can focus on the functional code, which is more straightforward to reason about. We can cite another project, <a href="https://github.com/AeneasVerif/aeneas" target="_blank" rel="noopener noreferrer">Aeneas</a>, which proposes to do the first step (removing memory operations) automatically.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="simulations">Simulations<a href="https://formal.land/blog/2023/12/13/rust-verify-erc-20-smart-contract#simulations" class="hash-link" aria-label="Direct link to Simulations" title="Direct link to Simulations">‚Äã</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="simulation-code">Simulation code<a href="https://formal.land/blog/2023/12/13/rust-verify-erc-20-smart-contract#simulation-code" class="hash-link" aria-label="Direct link to Simulation code" title="Direct link to Simulation code">‚Äã</a></h3>
<p>We will work on the example of the <code>transfer</code> function. We define the simulations in <a href="https://github.com/formal-land/coq-of-rust/blob/main/CoqOfRust/examples/default/examples/ink_contracts/Simulations/erc20.v" target="_blank" rel="noopener noreferrer">Simulations/erc20.v</a>. For the <code>transfer</code> function this is:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> transfer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">env </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Env</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">to </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AccountId</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ltac</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Balance</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MS</span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> State</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t ltac</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Result unit</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  transfer_from_to </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Env</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">caller env</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> to value</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The function <code>transfer</code> is a wrapper around <code>transfer_from_to</code>, using the smart contract caller as the <code>from</code> account. The monad <code>MS?</code> combines the state and error effect. The state is given by the <code>State.t</code> type:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> State</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> list erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">End</span><span class="token plain"> State</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It combines the state of the contract (type <code>Self</code> in the Rust code) and a list of events to represent the logs. The errors of the monad include panic errors, as well as control flow primitives such as <code>return</code> or <code>break</code> that we implement with exceptions.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="equivalence-statement">Equivalence statement<a href="https://formal.land/blog/2023/12/13/rust-verify-erc-20-smart-contract#equivalence-statement" class="hash-link" aria-label="Direct link to Equivalence statement" title="Direct link to Equivalence statement">‚Äã</a></h3>
<p>We write all our proofs in <a href="https://github.com/formal-land/coq-of-rust/blob/main/CoqOfRust/examples/default/examples/ink_contracts/Proofs/erc20.v" target="_blank" rel="noopener noreferrer">Proofs/erc20.v</a>. The lemma stating that the simulation is equivalent to the original code is:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Lemma</span><span class="token plain"> run_transfer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">env </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Env</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">storage </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">to </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AccountId</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ltac</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Balance</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">H_storage </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Valid</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t storage</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">H_value </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Integer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Valid</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> state </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> State</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">of_storage storage </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> self </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> Ref</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mut_ref Address</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">storage </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> simulation </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    lift_simulation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Simulations</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">transfer env to value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> storage </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> Environment</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">of_env env</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> state </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Impl_erc20_Erc20_t_2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">transfer self to value ‚áì</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    simulation</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">Output</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> simulation</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">Output</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The main predicate is:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> env</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> state </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> translated_code ‚áì result </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> final_state </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This predicate defines our semantics, explaining how to evaluate a translated Rust code in an environment <code>env</code> and a state <code>state</code>, to obtain a result <code>result</code> and a final state <code>final_state</code>. We use an environment in addition to a state to initialize various globals and other information related to the execution context. For example, here, we use the environment to store the <code>caller</code> of the contract and the pointer to the list of logs.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="semantics">Semantics<a href="https://formal.land/blog/2023/12/13/rust-verify-erc-20-smart-contract#semantics" class="hash-link" aria-label="Direct link to Semantics" title="Direct link to Semantics">‚Äã</a></h3>
<p>We define our monad for the translated code <code>M A</code> in a style by continuation:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Inductive</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Pure </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t A</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> CallPrimitive </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">B </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Primitive</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t B </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">B </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t A</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Cast </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">B1 B2 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> B1 </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">B2 </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t A</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Impossible </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t A</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Arguments</span><span class="token plain"> Pure </span><span class="token punctuation" style="color:#393A34">{</span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Arguments</span><span class="token plain"> CallPrimitive </span><span class="token punctuation" style="color:#393A34">{</span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Arguments</span><span class="token plain"> Cast </span><span class="token punctuation" style="color:#393A34">{</span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Arguments</span><span class="token plain"> Impossible </span><span class="token punctuation" style="color:#393A34">{</span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>For now, we use the primitives to access the memory and the environment:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Primitive</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Inductive</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> StateAlloc </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Ref</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> StateRead </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Address A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Address </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t A</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> StateWrite </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Address A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Address </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> A </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t unit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> EnvRead </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t A</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">End</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Primitive</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>For each of our monad constructs, we add a case to our evaluation predicate that we will describe:</p>
<ul>
<li><code>Pure</code> The result is the value itself, and the state is unchanged:<!-- -->
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Pure </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> env</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> state</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> LowM</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pure result ‚áì result </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> state</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li><code>Cast</code> The evaluation is only possible when <code>B1</code> and <code>B2</code> are the same type <code>B</code>:<!-- -->
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Cast </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">B </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">state </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> State</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> B</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> B </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> LowM A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> env</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> state </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> k v ‚áì result </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> state</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> env</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> state </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> LowM</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Cast v k ‚áì result </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> state</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<!-- -->In this case, we return the result of the continuation <code>k</code> of the cast. We do not change the state in the cast.</li>
<li>We read the state using the primitive <code>State.read</code>, checking that the <code>address</code> is indeed allocated (it returns <code>None</code> otherwise). Note that the type of <code>v</code> depends on its address. We directly allocate values with their original type, to avoid serializations/deserializations to represent the state.<!-- -->
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">|</span><span class="token plain"> CallPrimitiveStateRead</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">address </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Address</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> State</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_Set address</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">state </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> State</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> State</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_Set address </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> LowM A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  State</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read address state </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Some v </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> env</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> state </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> k v ‚áì result </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> state</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> env</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> state </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LowM</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CallPrimitive </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">Primitive</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StateRead address</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> k ‚áì result</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> state</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>Similarly, we write into the state with <code>State.alloc_write</code>, that only succeeds for allocated addresses:<!-- -->
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">|</span><span class="token plain"> CallPrimitiveStateWrite</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">address </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Address</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> State</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_Set address</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">state state_inter </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> State</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> unit </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> LowM A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  State</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc_write address state v </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Some state_inter </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> env</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> state_inter </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> k tt ‚áì result </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> state</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> env</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> state </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LowM</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CallPrimitive </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">Primitive</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StateWrite address v</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> k ‚áì result</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> state</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>To allocate a new value in memory, we have to make a choice depending on whether we want this value to be writable or not. For immutable values, we do not create a new address and instead say that the address is the value itself:<!-- -->
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">|</span><span class="token plain"> CallPrimitiveStateAllocNone </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">B </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">state </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> State</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> B</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Ref B </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> LowM A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> env</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> state </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> k </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Ref</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Imm v</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> ‚áì result </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> state</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> env</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> state </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LowM</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CallPrimitive </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">Primitive</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StateAlloc v</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> k ‚áì result</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> state</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<!-- -->If we later attempt to update this value, it will not be possible to define a semantics and we will be stuck. It is up to the user to correctly anticipate if a value will be updated or not to define the semantics. For values that might be updated, we use:<!-- -->
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">|</span><span class="token plain"> CallPrimitiveStateAllocSome</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">address </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Address</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> State</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_Set address</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">state </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> State</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Ref </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">State</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_Set address</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> LowM A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> r </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Ref</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">MutRef </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">A </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> State</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_Set address</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">B </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> State</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_Set address</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      address </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> full_v </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> full_v</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> v _full_v </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> v</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  State</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read address state </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> None </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  State</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc_write address state v </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Some state</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> env</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> state </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> k r ‚áì result </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> state</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> env</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> state </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LowM</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CallPrimitive </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">Primitive</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StateAlloc v</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> k ‚áì result</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> state</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<!-- -->We need to provide an address not already allocated: <code>State.read</code> should return <code>None</code>. At this point, we can make any choice of unallocated address in order to simplify the proofs later.</li>
<li>Finally, we read the whole environment with:<!-- -->
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">|</span><span class="token plain"> CallPrimitiveEnvRead</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">state </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> State</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Env </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> LowM A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> env</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> state </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> k env ‚áì result </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> state</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> env</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> state </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LowM</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CallPrimitive </span><span class="token keyword" style="color:#00009f">Primitive</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">EnvRead k ‚áì result</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> state</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="semantics-remarks">Semantics remarks<a href="https://formal.land/blog/2023/12/13/rust-verify-erc-20-smart-contract#semantics-remarks" class="hash-link" aria-label="Direct link to Semantics remarks" title="Direct link to Semantics remarks">‚Äã</a></h3>
<p>We can make a few remarks about our semantics:</p>
<ul>
<li>There are no cases for <code>M.Impossible</code> as this primitive corresponds to impossible branches in the code.</li>
<li>The semantics is not computable, in the sense that we cannot define a function <code>run</code> to evaluate a monadic program in a certain environment and state. Indeed, the user needs to make a choice during the allocation of new values, to know if we allocate the value as immutable or mutable, and with which address. The <code>M.Cast</code> operator is also not computable, as we cannot decide if two types are equal.</li>
<li>We can choose the type that we use for the <code>State</code>, as well as the primitives <code>State.read</code> and <code>State.alloc_write</code>, as long as they verify well-formedness properties. For example, reading after a write at the same address should return the written value. One should choose a <code>State</code> that simplifies its proofs the most. To verify the smart contract, we have taken a record with two fields:<!-- -->
<ol>
<li>the storage of the contract (the <code>Self</code> type in Rust),</li>
<li>the list of events logged by the contract.</li>
</ol>
</li>
<li>Even if the monad is in continuation-passing style, we add a primitive <code>M.Call</code> corresponding to a bind, to explicit the points in the code where we call user-defined functions. This is not necessary but helpful to track things in the proofs. Otherwise, the monadic bind is defined as a fixpoint with:<!-- -->
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Fixpoint</span><span class="token plain"> bind </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A B </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e1 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">f </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t B</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t B </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> e1 </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Pure v </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> f v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> CallPrimitive primitive k </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CallPrimitive primitive </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> v </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> bind </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k v</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> f</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Cast v k </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Cast v </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> v</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> bind </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k v</span><span class="token operator" style="color:#393A34">'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> f</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Impossible </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> Impossible</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">end</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>To handle the panic and <code>return</code>/<code>break</code> exceptions, we wrap our monad into an error monad:<!-- -->
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> M </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  LowM </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">A </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> Exception</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<!-- -->where <code>LowM</code> is the monad without errors as defined above and <code>Exception.t</code> is:<!-- -->
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> Exception</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Inductive</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">(** exceptions for Rust's `return` *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Return </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">(** exceptions for Rust's `continue` *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Continue </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">(** exceptions for Rust's `break` *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Break </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Panic </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Coq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Strings</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">String</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">string </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">End</span><span class="token plain"> Exception</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="proof-of-equivalence">Proof of equivalence<a href="https://formal.land/blog/2023/12/13/rust-verify-erc-20-smart-contract#proof-of-equivalence" class="hash-link" aria-label="Direct link to Proof of equivalence" title="Direct link to Proof of equivalence">‚Äã</a></h3>
<p>To prove that the equivalence between the simulation and the original code holds, we proceed by induction on the monadic code. This corresponds to symbolically evaluating the monadic code, in the proof mode of Coq, applying the primitives of the semantics predicate at each step. We use the following tactic to automate this work:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">run_symbolic</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We manually handle the following cases:</p>
<ul>
<li>branching (<code>if</code> or <code>match</code>),</li>
<li>external function calls: generally, we apply an existing equivalence proof for a call to another function instead of doing the symbolic evaluation of the function,</li>
<li>memory allocations: we need to choose the type of allocation (mutable or immutable) and the address of the allocation for mutable ones.</li>
</ul>
<p>Here is the proof for the <code>transfer</code> function:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Proof</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  unfold erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Impl_erc20_Erc20_t_2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">transfer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Simulations</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">transfer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    lift_simulation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Opaque</span><span class="token plain"> erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">transfer_from_to</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  run_symbolic</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  eapply Run</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Call</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">apply</span><span class="token plain"> run_env</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  run_symbolic</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  eapply Run</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Call</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">apply</span><span class="token plain"> Env</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">run_caller</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  run_symbolic</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  eapply Run</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Call</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    now </span><span class="token keyword" style="color:#00009f">apply</span><span class="token plain"> run_transfer_from_to</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  unfold lift_simulation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  destruct erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">transfer_from_to </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token operator" style="color:#393A34">?</span><span class="token plain">storage </span><span class="token operator" style="color:#393A34">?</span><span class="token plain">logs</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> run_symbolic</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Transparent</span><span class="token plain"> erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">transfer_from_to</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Qed</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="proofs">Proofs<a href="https://formal.land/blog/2023/12/13/rust-verify-erc-20-smart-contract#proofs" class="hash-link" aria-label="Direct link to Proofs" title="Direct link to Proofs">‚Äã</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="handling-of-integers">Handling of integers<a href="https://formal.land/blog/2023/12/13/rust-verify-erc-20-smart-contract#handling-of-integers" class="hash-link" aria-label="Direct link to Handling of integers" title="Direct link to Handling of integers">‚Äã</a></h3>
<p>We distinguish the various types of integers used in Rust:</p>
<ul>
<li>unsigned ones: <code>u8</code>, <code>u16</code>, <code>u32</code>, <code>u64</code>, <code>u128</code>, <code>usize</code>,</li>
<li>signed ones: <code>i8</code>, <code>i16</code>, <code>i32</code>, <code>i64</code>, <code>i128</code>, <code>isize</code>.</li>
</ul>
<p>We define a separate type for each of them, that is to say, a wrapper around the <code>Z</code> type of unbounded integers from Coq:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> u8</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Inductive</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> Make </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">z </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">End</span><span class="token plain"> u8</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>To enforce the bounds, we define a validity predicate for each type:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> Valid</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Integer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">C A</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Prop</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Integer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">min </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> Integer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">to_Z v </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> Integer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">max</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">End</span><span class="token plain"> Valid</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>All integer types are of the class <code>Integer.C</code> with a <code>min</code>, <code>max</code>, and <code>to_Z</code> functions. We do not embed this predicate with the integer type (<a href="https://en.wikipedia.org/wiki/Refinement_type" target="_blank" rel="noopener noreferrer">refinement type</a>) to avoid mixing proofs and code. We pay a cost by having to handle the values and the validity proofs separately.</p>
<p>Depending on the configuration mode of Rust, integer operations can overflow or panic. We have several implementations of the arithmetic operations, depending on the mode:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">BinOp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">(** Operators with panic, in the monad. *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> Panic</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> add </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Integer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">C A</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v1 v2 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M A </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">(* ... *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> sub </span><span class="token comment" style="color:#999988;font-style:italic">(* ... *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">End</span><span class="token plain"> Panic</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">(** Operators with overflow, outside of the monad as</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">      there cannot be any errors. *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> Wrap</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> add </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Integer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">C A</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v1 v2 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">(* ... *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> sub </span><span class="token comment" style="color:#999988;font-style:italic">(* ... *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">End</span><span class="token plain"> Wrap</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">End</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">BinOp</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We also have additional operators, useful for the definition of simulations:</p>
<ul>
<li>optimistic operators, operating on <code>Z</code> without checking the bounds of the result (for cases where we can prove that the result is never out of bounds),</li>
<li>operators returning in the option monad, to handle the case where the result is out of bounds.</li>
</ul>
<p>Note that the comparison operators (<code>=</code>, <code>&lt;</code>, ...) never panic or overflow. In the context of these smart contracts, the arithmetic operators are panicking in case of overflow.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="definition-of-messages">Definition of messages<a href="https://formal.land/blog/2023/12/13/rust-verify-erc-20-smart-contract#definition-of-messages" class="hash-link" aria-label="Direct link to Definition of messages" title="Direct link to Definition of messages">‚Äã</a></h3>
<p>We can call the smart contract with three read primitives (<code>total_supply</code>, <code>balance_of</code>, <code>allowance</code>) and three write primitives (<code>transfer</code>, <code>approve</code>, <code>transfer_from</code>). We define two message types to formalize these access points. This will later allow us to express properties over all possible read and write messages:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> ReadMessage</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">(** The type parameter is the type of result of the call. *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Inductive</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> total_supply </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    t ltac</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Balance</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> balance_of</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">owner </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AccountId</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    t ltac</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Balance</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> allowance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">owner </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AccountId</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">spender </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AccountId</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    t ltac</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Balance</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">End</span><span class="token plain"> ReadMessage</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> WriteMessage</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Inductive</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> transfer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">to </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AccountId</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ltac</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Balance</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> approve</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">spender </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AccountId</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ltac</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Balance</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> transfer_from</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">from </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AccountId</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">to </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AccountId</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ltac</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Balance</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    t</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">End</span><span class="token plain"> WriteMessage</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="no-panics-on-read-messages">No panics on read messages<a href="https://formal.land/blog/2023/12/13/rust-verify-erc-20-smart-contract#no-panics-on-read-messages" class="hash-link" aria-label="Direct link to No panics on read messages" title="Direct link to No panics on read messages">‚Äã</a></h3>
<p>We show that for all possible read messages, the smart contract does not panic:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Lemma</span><span class="token plain"> read_message_no_panic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">env </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Env</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">message </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ReadMessage</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t ltac</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Balance</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">storage </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> state </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> State</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">of_storage storage </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">exists</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> Environment</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">of_env env</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> state </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ReadMessage</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dispatch message ‚áì</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">(* [inl] means success (no panics) *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    inl result</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> state </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This is done by symbolic evaluation of the simulations:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Proof</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  destruct message</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> simpl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> eexists</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">apply</span><span class="token plain"> run_total_supply</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> eexists</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">apply</span><span class="token plain"> run_balance_of</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> eexists</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">apply</span><span class="token plain"> run_allowance</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Qed</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="invariants">Invariants<a href="https://formal.land/blog/2023/12/13/rust-verify-erc-20-smart-contract#invariants" class="hash-link" aria-label="Direct link to Invariants" title="Direct link to Invariants">‚Äã</a></h3>
<p>The data structure of the storage of the smart contract is as follows:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token type-definition class-name">Erc20</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    total_supply</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Balance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    balances</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Mapping</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">AccountId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Balance</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    allowances</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Mapping</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">AccountId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">AccountId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Balance</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>An invariant is that the total supply is always equal to the sum of all the balances in the mapping <code>Mapping&lt;AccountId, Balance&gt;</code>. We define this invariant in Coq as:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> sum_of_money </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">storage </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Z </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Lib</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Mapping</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sum Integer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">to_Z storage</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">balances</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> Valid</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">storage </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Prop</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Integer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">to_Z storage</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">total_supply</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sum_of_money storage</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">End</span><span class="token plain"> Valid</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We show that this invariant holds for any output of the write messages, given that it holds for the input storage:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Lemma</span><span class="token plain"> write_dispatch_is_valid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">env </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Env</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">storage </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">write_message </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> WriteMessage</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">H_storage </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Valid</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t storage</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">H_write_message </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> WriteMessage</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Valid</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t write_message</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> state </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> State</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">of_storage storage </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">'</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">result</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">storage</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    WriteMessage</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">simulation_dispatch env write_message </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">storage</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> result </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> inl </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> Erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Valid</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t storage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> True</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">end</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We assume that the initial storage is valid with the hypothesis:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">H_storage </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Valid</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t storage</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We show the property in the case without panics with:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> result </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> inl </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>When the smart contract panics (integer overflow), the storage is discarded anyways, and it might actually by invalid. For example, in the <code>transfer_from_to</code> function we have:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">balances</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">insert</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">from</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> from_balance </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> to_balance </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">balance_of_impl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">to</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">balances</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">insert</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">to</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> to_balance </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>So if there is a panic during the addition&nbsp;<code>+</code>, like an overflow, the final storage can have the <code>from</code> account modified but not the <code>to</code> account. So here, the balance sum is no longer equal to the total supply.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="total-supply-is-constant">Total supply is constant<a href="https://formal.land/blog/2023/12/13/rust-verify-erc-20-smart-contract#total-supply-is-constant" class="hash-link" aria-label="Direct link to Total supply is constant" title="Direct link to Total supply is constant">‚Äã</a></h3>
<p>We show that the total supply is also a constant, meaning that no calls to the smart contract can modify its value. The statement is the following:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Lemma</span><span class="token plain"> write_dispatch_is_constant</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">env </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Env</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">storage </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">write_message </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> WriteMessage</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> state </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> State</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">of_storage storage </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">'</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">result</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">storage</span><span class="token operator" style="color:#393A34">'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    WriteMessage</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">simulation_dispatch env write_message </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">storage</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> result </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> inl </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    storage</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">total_supply</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    storage</span><span class="token operator" style="color:#393A34">'</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">total_supply</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> True</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">end</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It says that for any initial <code>storage</code> and <code>write_message</code> sent to the smart contract, if we return a result without panicking (<code>inl _</code>), then the total supply in the final storage <code>storage'</code> is equal to the initial one. We verify this fact by symbolic evaluation of all the branches of the simulation. There are no difficulties in this proof as the code never modifies the <code>total_supply</code>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="action-from-the-logs">Action from the logs<a href="https://formal.land/blog/2023/12/13/rust-verify-erc-20-smart-contract#action-from-the-logs" class="hash-link" aria-label="Direct link to Action from the logs" title="Direct link to Action from the logs">‚Äã</a></h3>
<p>We infer the action of the smart contract on the storage from its logs. This characterizes exactly what we modifications we can deduce on the storage from the logs. We define an action as a function from the storage to a set of possible new storages, given the knowledge of the logs of the contract:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> Action</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Type</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Prop</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">End</span><span class="token plain"> Action</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The main statement is the following:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Lemma</span><span class="token plain"> retrieve_action_from_logs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">env </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Env</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">storage </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">write_message </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> WriteMessage</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">events </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> list erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    WriteMessage</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">simulation_dispatch env write_message </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">storage</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">inl </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Ok tt</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">storage</span><span class="token operator" style="color:#393A34">'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> events</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    action_of_events events storage storage</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> True</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">end</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This relates the final storage <code>storage'</code> to the initial storage <code>storage</code> using the logs <code>events</code> when there are no panics. We define the <code>action_of_events</code> predicate as the successive application of the <code>action_of_event</code> predicate, which is defined as:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> action_of_event </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">event </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Action</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">fun</span><span class="token plain"> storage storage</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> event </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Transfer </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Transfer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Build_t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">option</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Option</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Some from</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">option</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Option</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Some to</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">(* In case of transfer event, we do not know how the allowances are</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">       updated. *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">exists</span><span class="token plain"> allowances</span><span class="token operator" style="color:#393A34">'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    storage</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    storage </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">balances </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> balances_of_transfer storage from to value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">|</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">allowances </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> allowances</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">|</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Transfer </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Transfer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Build_t </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> False</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Approval </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Approval</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Build_t owner spender value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    storage</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    storage </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">|</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">allowances </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Lib</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Mapping</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">insert </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">owner</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> spender</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          storage</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">allowances</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">|</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">end</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>When the <code>event</code> in the logs is of kind <code>erc20.Event.Transfer</code>, the resulting storage has:</p>
<ul>
<li>the <code>balances</code> updated according to the function <code>balances_of_transfer</code>;</li>
<li>the <code>allowances</code> updated to an unknown value <code>allowances'</code>.</li>
</ul>
<p>When the <code>event</code> in the logs is of kind <code>erc20.Event.Approval</code>, the resulting storage has:</p>
<ul>
<li>the <code>allowances</code> updated calling <code>Lib.Mapping.insert</code> on <code>(owner, spender)</code>;</li>
<li>the <code>balances</code> unchanged.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="approve-only-on-caller">Approve only on caller<a href="https://formal.land/blog/2023/12/13/rust-verify-erc-20-smart-contract#approve-only-on-caller" class="hash-link" aria-label="Direct link to Approve only on caller" title="Direct link to Approve only on caller">‚Äã</a></h3>
<p>We added one last proof to say that when the <code>approve</code> function succeeds, it only modifies the allowance of the caller:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Lemma</span><span class="token plain"> approve_only_changes_owner_allowance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">env </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Env</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">storage </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">spender </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AccountId</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ltac</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Balance</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">'</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">result</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">storage</span><span class="token operator" style="color:#393A34">'</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Simulations</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">approve env spender value </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">storage</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> result </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> inl </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Ok tt</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">forall</span><span class="token plain"> owner spender</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Integer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">to_Z </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Simulations</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">allowance storage</span><span class="token operator" style="color:#393A34">'</span><span class="token plain"> owner spender</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Integer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">to_Z </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Simulations</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">allowance storage owner spender</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    owner </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Simulations</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Env</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">caller env</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> True</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">end</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If an allowance changes after the call to <code>approve</code>, then the owner of the allowance is the caller of the smart contract. This is done by symbolic evaluation of the simulation.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="https://formal.land/blog/2023/12/13/rust-verify-erc-20-smart-contract#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">‚Äã</a></h2>
<p>In this example, we have shown how we formally verify the ERC-20 smart contract written in Rust for the <a href="https://alephzero.org/" target="_blank" rel="noopener noreferrer">Aleph Zero</a> project. Formally verifying smart contracts is extremely important as they can hold a lot of money, and a single bug can prove fatal as recent attacks continue to show: <a href="https://www.ccn.com/education/crypto-hacks-2023-full-list-of-scams-and-exploits-as-millions-go-missing/" target="_blank" rel="noopener noreferrer">List of crypto hacks in 2023</a>.</p>
<p>If you have Rust smart contracts to verify, feel free to email us at&nbsp;<a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">contact@formal.land</a>. We will be happy to help!</p>]]></content>
        <category label="Aleph-Zero" term="Aleph-Zero"/>
        <category label="coq-of-rust" term="coq-of-rust"/>
        <category label="Rust" term="Rust"/>
        <category label="Coq" term="Coq"/>
        <category label="ERC-20" term="ERC-20"/>
        <category label="ink!" term="ink!"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Translation of function bodies from Rust to Coq]]></title>
        <id>https://formal.land/blog/2023/11/26/rust-function-body</id>
        <link href="https://formal.land/blog/2023/11/26/rust-function-body"/>
        <updated>2023-11-26T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Our tool coq-of-rust enables formal verification of ü¶Ä&nbsp;Rust code, to make sure that a program has no bugs given a precise specification. We work by translating Rust programs to the general proof system üêì&nbsp;Coq.]]></summary>
        <content type="html"><![CDATA[<p>Our tool <a href="https://github.com/formal-land/coq-of-rust" target="_blank" rel="noopener noreferrer">coq-of-rust</a> enables formal verification of <a href="https://www.rust-lang.org/" target="_blank" rel="noopener noreferrer">ü¶Ä&nbsp;Rust</a> code, to make sure that a program has no bugs given a precise specification. We work by translating Rust programs to the general proof system <a href="https://coq.inria.fr/" target="_blank" rel="noopener noreferrer">üêì&nbsp;Coq</a>.</p>
<p>Here, we present how we translate function bodies from Rust to Coq in an example. We also show some of the optimizations we made to reduce the size of the translation.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Purchase</div><div class="admonitionContent_BuS1"><p>If you need to formally verify your Rust codebase to improve the security of your application, email us at&nbsp;<a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">contact@formal.land</a>!</p></div></div>
<p><img decoding="async" loading="lazy" alt="Rust and Coq" src="https://formal.land/assets/images/rust_and_coq-e644a4a1dfd171b8b97366213a50a080.png" width="512" height="512" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="translating-a-function-body">Translating a function body<a href="https://formal.land/blog/2023/11/26/rust-function-body#translating-a-function-body" class="hash-link" aria-label="Direct link to Translating a function body" title="Direct link to Translating a function body">‚Äã</a></h2>
<p>We take the following Rust example as input:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// fn balance_of_impl(&amp;self, owner: &amp;AccountId) -&gt; Balance { ... }</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">balance_of</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> owner</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">AccountId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">Balance</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">balance_of_impl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">owner</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Here is the corresponding Coq code that <code>coq-of-rust</code> generates <em>without optimizations</em>:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> balance_of</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ref ltac</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">owner </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AccountId</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M ltac</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Balance</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> self </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Val </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ref ltac</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc self </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> owner </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Val erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AccountId</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc owner </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ref erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read self </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Val erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> deref Œ±</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ref erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> borrow Œ±</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Val </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ref erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc Œ±</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">4</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ref erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read Œ±</span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ref erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AccountId</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> borrow owner </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">6</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Val </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ref erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AccountId</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc Œ±</span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">7</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ref erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AccountId</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read Œ±</span><span class="token number" style="color:#36acaa">6</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Val erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AccountId</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> deref Œ±</span><span class="token number" style="color:#36acaa">7</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">9</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ref erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AccountId</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> borrow Œ±</span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">10</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Val </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ref erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AccountId</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc Œ±</span><span class="token number" style="color:#36acaa">9</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">11</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ref erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AccountId</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read Œ±</span><span class="token number" style="color:#36acaa">10</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">12</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> u128</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"balance_of_impl"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">4</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">11</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">13</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Val u128</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc Œ±</span><span class="token number" style="color:#36acaa">12</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read Œ±</span><span class="token number" style="color:#36acaa">13</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This code is much more verbose than the original Rust code as we make all pointer manipulations explicit. We will see just after how to simplify it. We start with the function declaration:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> balance_of</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ref ltac</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">owner </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AccountId</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M ltac</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Balance</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>that repeats the parameters in the Rust source. Note that the final result is wrapped into the monad type <code>M</code>. This is a monad representing all the side-effects used in Rust programs (state, panic, non-termination, ...). Then, we allocate all the function parameters:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> self </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Val </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ref ltac</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc self </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> owner </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Val erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AccountId</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc owner </span><span class="token keyword" style="color:#00009f">in</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This ensures that both <code>self</code> and <code>owner</code> have an address in memory, in case we borrow them later. This allocation is also fresh, so we cannot access the address of the values from the caller by mistake. We use the monadic let <code>let*</code> as allocations can modify the memory state.</p>
<p>Then we start by the body of the function itself. We do all the necessary pointer manipulations to compute the parameters <code>self</code> and <code>&amp;owner</code> of the function <code>balance_of_impl</code>. These representations are directly taken from the abstract syntax tree of the Rust compiler (using the <a href="https://rustc-dev-guide.rust-lang.org/thir.html" target="_blank" rel="noopener noreferrer">THIR</a> version).</p>
<p>For example, for the first parameter <code>self</code>, named <code>Œ±4</code> in this translation, we do:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ref erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read self </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Val erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> deref Œ±</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ref erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> borrow Œ±</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Val </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ref erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc Œ±</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">4</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ref erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read Œ±</span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We combine the operators:</p>
<ul>
<li><code>M.read</code>: to get a value of type <code>A</code> from a value with an address <code>M.Val</code>,</li>
<li><code>deref</code>: to get the value with an address <code>M.Val A</code> pointed by a reference <code>ref A</code>,</li>
<li><code>borrow</code>: to get the reference <code>ref A</code> to a value with an address <code>M.Val A</code>,</li>
<li><code>M.alloc</code>: to allocate a new value <code>A</code> in memory, returning a value with address <code>M.Val A</code>.</li>
</ul>
<p>We do the same to compute the second parameter <code>&amp;owner</code> of <code>balance_of_impl</code> with:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ref erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AccountId</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> borrow owner </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">6</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Val </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ref erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AccountId</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc Œ±</span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">7</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ref erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AccountId</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read Œ±</span><span class="token number" style="color:#36acaa">6</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Val erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AccountId</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> deref Œ±</span><span class="token number" style="color:#36acaa">7</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">9</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ref erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AccountId</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> borrow Œ±</span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">10</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Val </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ref erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AccountId</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc Œ±</span><span class="token number" style="color:#36acaa">9</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">11</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ref erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AccountId</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read Œ±</span><span class="token number" style="color:#36acaa">10</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Finally, we call the <code>balance_of_impl</code> function and return the result:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">12</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> u128</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"balance_of_impl"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">4</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">11</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">13</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Val u128</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc Œ±</span><span class="token number" style="color:#36acaa">12</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read Œ±</span><span class="token number" style="color:#36acaa">13</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We do not keep the address of the result, as it will be allocated again by the caller function.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="optimizations">Optimizations<a href="https://formal.land/blog/2023/11/26/rust-function-body#optimizations" class="hash-link" aria-label="Direct link to Optimizations" title="Direct link to Optimizations">‚Äã</a></h2>
<p>Some operations can always be removed, namely:</p>
<ul>
<li><code>M.read (M.alloc v) ==&gt; v</code>: we do not need to allocate and give an address to a value if it will be immediately read,</li>
<li><code>deref (borrow v) ==&gt; v</code> and <code>borrow (deref v) ==&gt; v</code>: the borrowing and dereferencing operators are doing the opposite, so they cancel each other. We need to be careful of the mutability status of the borrowing and dereferencing.</li>
</ul>
<p>Applying these simple simplification rules, we get the following slimed-down translation:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> balance_of</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ref ltac</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">owner </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AccountId</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M ltac</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Balance</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> self </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Val </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ref ltac</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc self </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> owner </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Val erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AccountId</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alloc owner </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ref erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> M</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read self </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ref erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AccountId</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> borrow owner </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Erc20</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"balance_of_impl"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This is much shorter and easier to verify!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="https://formal.land/blog/2023/11/26/rust-function-body#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">‚Äã</a></h2>
<p>We have illustrated in an example how we translate a simple function from Rust to Coq. In this example, we saw how the pointer operations are made explicit in the abstract syntax tree of Rust, and how we simplify them for the frequent cases.</p>
<p>If you have any comments or suggestions, feel free to email us at&nbsp;<a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">contact@formal.land</a>. In future posts, we will go into more detail about the verification process itself.</p>]]></content>
        <category label="coq-of-rust" term="coq-of-rust"/>
        <category label="Rust" term="Rust"/>
        <category label="Coq" term="Coq"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Optimizing Rust translation to Coq with THIR and bundled traits]]></title>
        <id>https://formal.land/blog/2023/11/08/rust-thir-and-bundled-traits</id>
        <link href="https://formal.land/blog/2023/11/08/rust-thir-and-bundled-traits"/>
        <updated>2023-11-08T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[We continued our work on coq-of-rust, a tool to formally verify Rust programs using the proof system Coq&nbsp;üêì. This tool translates Rust programs to an equivalent Coq program, which can then be verified using Coq's proof assistant. It opens the door to building mathematically proven bug-free Rust programs.]]></summary>
        <content type="html"><![CDATA[<p>We continued our work on <a href="https://github.com/formal-land/coq-of-rust" target="_blank" rel="noopener noreferrer">coq-of-rust</a>, a tool to formally verify <a href="https://www.rust-lang.org/" target="_blank" rel="noopener noreferrer">Rust</a> programs using the proof system <a href="https://coq.inria.fr/" target="_blank" rel="noopener noreferrer">Coq&nbsp;üêì</a>. This tool translates Rust programs to an equivalent Coq program, which can then be verified using Coq's proof assistant. It opens the door to building mathematically proven bug-free Rust programs.</p>
<p>We present two main improvements we made to <code>coq-of-rust</code>:</p>
<ul>
<li>Using the THIR intermediate language of Rust to have more information during the translation to Coq.</li>
<li>Bundling the type-classes representing the traits of Rust to have faster type-checking in Coq.</li>
</ul>
<p><img decoding="async" loading="lazy" alt="Rust and Coq" src="https://formal.land/assets/images/rust_and_coq-24841df3c1f402ea1ff783770d999040.png" width="512" height="512" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="thir-intermediate-language">THIR intermediate language<a href="https://formal.land/blog/2023/11/08/rust-thir-and-bundled-traits#thir-intermediate-language" class="hash-link" aria-label="Direct link to THIR intermediate language" title="Direct link to THIR intermediate language">‚Äã</a></h2>
<p>To translate Rust programs to Coq, we plug into the compiler of Rust, which operates on a series of intermediate languages:</p>
<ul>
<li>source code (<code>.rs</code> files);</li>
<li>abstract syntax tree (AST): immediately after parsing;</li>
<li><a href="https://rustc-dev-guide.rust-lang.org/hir.html" target="_blank" rel="noopener noreferrer">High-Level Intermediate Representation</a> (HIR): after macro expansion, with name resolution and close to the AST;</li>
<li><a href="https://rustc-dev-guide.rust-lang.org/thir.html" target="_blank" rel="noopener noreferrer">Typed High-Level Intermediate Representation</a> (THIR): after the type-checking;</li>
<li><a href="https://rustc-dev-guide.rust-lang.org/mir/index.html" target="_blank" rel="noopener noreferrer">Mid-level Intermediate Representation</a> (MIR): low-level representation based on a <a href="https://en.wikipedia.org/wiki/Control-flow_graph" target="_blank" rel="noopener noreferrer">control-flow graph</a>, inlining traits and polymorphic functions, and with <a href="https://doc.rust-lang.org/book/ch04-02-references-and-borrowing.html" target="_blank" rel="noopener noreferrer">borrow checking</a>;</li>
<li>machine code (assembly, LLVM IR, ...).</li>
</ul>
<p>We were previously using the HIR language to start our translation to Coq, because it is not too low-level and close to what the user has originally in the <code>.rs</code> file. This helps relate the generated Coq code to the original Rust code.</p>
<p>However, at the level of HIR, there is still a lot of implicit information. For example, Rust has <a href="https://users.rust-lang.org/t/automatic-dereferencing/53828" target="_blank" rel="noopener noreferrer">automatic dereferencing rules</a> that are not yet explicit in HIR. In order not to make any mistakes during our translation to Coq, we prefer to use the next representation, THIR, that makes explicit such rules.</p>
<p>In addition, the THIR representation shows when a method call is from a trait (and which trait) or from a standalone <code>impl</code> block. Given that we still have trouble translating the traits with <a href="https://coq.inria.fr/doc/V8.18.0/refman/addendum/type-classes.html" target="_blank" rel="noopener noreferrer">type-classes</a> that are inferrable by Coq, this helps a lot.</p>
<p>A downside of the THIR representation is that it is much more verbose. For example, here is a formatting function generated from HIR:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> fmt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">‚Ñã </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> State</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Trait</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ref Self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">f </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> mut_ref core</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Formatter</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M core</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Result </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> format_argument</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"new_display"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr_of self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"radius"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    format_arguments</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"new_v1"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr_of </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Circle of radius "</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr_of </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  f</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"write_fmt"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This is the kind of functions generated by the <code>#[derive(Debug)]</code> macro of Rust, to implement a formatting function on a type. Here is the version translated from THIR, with explicit borrowing and dereferencing:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> fmt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">‚Ñã </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> State</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Trait</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ref Self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">f </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> mut_ref core</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Formatter</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M ltac</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">core</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> deref f core</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Formatter </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> borrow_mut Œ±</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> core</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Formatter </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> borrow </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> mk_str </span><span class="token string" style="color:#e3116c">"Circle of radius "</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">list </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ref str</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> deref Œ±</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">list </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ref str</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">4</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> borrow Œ±</span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">list </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ref str</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> pointer_coercion </span><span class="token string" style="color:#e3116c">"Unsize"</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">4</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">6</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> deref self converting_to_string</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Circle </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">7</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"radius"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> borrow Œ±</span><span class="token number" style="color:#36acaa">7</span><span class="token plain"> i32 </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">9</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> deref Œ±</span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> i32 </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">10</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> borrow Œ±</span><span class="token number" style="color:#36acaa">9</span><span class="token plain"> i32 </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">11</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> core</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">rt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Argument</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"new_display"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">10</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">12</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> borrow </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">11</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">list core</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">rt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Argument</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">13</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> deref Œ±</span><span class="token number" style="color:#36acaa">12</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">list core</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">rt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Argument</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">14</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> borrow Œ±</span><span class="token number" style="color:#36acaa">13</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">list core</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">rt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Argument</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">15</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> pointer_coercion </span><span class="token string" style="color:#e3116c">"Unsize"</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">14</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">16</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> core</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">Arguments</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"new_v1"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">15</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  core</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Formatter</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"write_fmt"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">16</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We went from a function having two intermediate variables to seventeen intermediate variables. This code is much more verbose, but it is also more explicit. In particular, it details when the:</p>
<ul>
<li>borrowing (going from a value of type <code>T</code> to <code>&amp;T</code>), and the</li>
<li>dereferencing (going from a value of type <code>&amp;T</code> to <code>T</code>)</li>
</ul>
<p>occur. It also shows that the method&nbsp;<code>write_fmt</code> is a method from the implementation of the type <code>core.fmt.Formatter</code>, generating:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">core</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Formatter</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"write_fmt"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">16</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>instead of:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">f</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"write_fmt"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="bundled-traits">Bundled traits<a href="https://formal.land/blog/2023/11/08/rust-thir-and-bundled-traits#bundled-traits" class="hash-link" aria-label="Direct link to Bundled traits" title="Direct link to Bundled traits">‚Äã</a></h2>
<p>Some Rust codebases can have a lot of traits. For example in <a href="https://github.com/paritytech/ink/blob/ccb38d2c3ac27523fe3108f2bb7bffbbe908cdb7/crates/env/src/types.rs#L120" target="_blank" rel="noopener noreferrer">paritytech/ink/crates/env/src/types.rs</a> the trait&nbsp;<code>Environment</code> references more than forty other traits:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">trait</span><span class="token plain"> </span><span class="token type-definition class-name">Environment</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Clone</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">MAX_EVENT_TOPICS</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">usize</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token type-definition class-name">AccountId</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token lifetime-annotation symbol" style="color:#36acaa">'static</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">scale</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token class-name">Codec</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token class-name">CodecAsType</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token class-name">Clone</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token class-name">PartialEq</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token type-definition class-name">Balance</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token lifetime-annotation symbol" style="color:#36acaa">'static</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">scale</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token class-name">Codec</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token class-name">CodecAsType</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We first used an unbundled approach to represent this trait by a type-class in Coq, as it felt more natural:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> Environment</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Class</span><span class="token plain"> Trait </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Self </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Clone</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Trait Self</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">AccountId </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">scale</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Codec</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Trait AccountId</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">CodecAsType AccountId</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">Clone AccountId</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">PartialEq AccountId</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>However, the backquote operator generated too many implicit arguments, and the type-checker of Coq was very slow. We then switched to a bundled approach, as advocated in this blog post: <a href="https://www.ralfj.de/blog/2019/05/15/typeclasses-exponential-blowup.html" target="_blank" rel="noopener noreferrer">Exponential blowup when using unbundled typeclasses to model algebraic hierarchies</a>. The Coq code for this trait now looks like this:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> Environment</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Class</span><span class="token plain"> Trait </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">‚Ñã </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> State</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Trait</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Self </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Type</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ‚Ñã_0 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Clone</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Trait Self</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MAX_EVENT_TOPICS </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> usize</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AccountId </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ‚Ñí_0 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> parity_scale_codec</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">codec</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Codec</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Trait AccountId</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ‚Ñí_1 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ink_env</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CodecAsType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Trait AccountId</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ‚Ñí_2 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> core</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">clone</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Clone</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Trait AccountId</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ‚Ñí_3 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      core</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cmp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PartialEq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Trait AccountId</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Rhs </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> core</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cmp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PartialEq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Default</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Rhs AccountId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Balance </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ‚Ñí_8 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> parity_scale_codec</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">codec</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Codec</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Trait Balance</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ‚Ñí_9 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ink_env</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CodecAsType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Trait Balance</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We use the notation&nbsp;<code>::</code> for fields that are trait instances. With this approach, traits have types as parameters but no other traits.</p>
<p>The type-checking is now much faster, and in particular, we avoid some cases with exponential blowup or non-terminating type-checking. But this is not a perfect solution as we still have cases where the instance inference does not terminate or fails with hard-to-understand error messages.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="https://formal.land/blog/2023/11/08/rust-thir-and-bundled-traits#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">‚Äã</a></h2>
<p>We have illustrated here some improvements we recently made to our <a href="https://github.com/formal-land/coq-of-rust" target="_blank" rel="noopener noreferrer">coq-of-rust</a> translator for two key areas:</p>
<ul>
<li>the translation of traits;</li>
<li>the translation of the implicit borrowing and dereferencing, that can occur every time we call a function.</li>
</ul>
<p>These improvements will allow us to formally verify some more complex Rust codebases. In particular, we are applying <code>coq-of-rust</code> to verify smart contracts written for the <a href="https://use.ink/" target="_blank" rel="noopener noreferrer">ink!</a> platform, that is a subset of Rust.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Contact</div><div class="admonitionContent_BuS1"><p>If you have comments, similar experiences to share, or wish to formally verify your codebase to improve the security of your application, contact us at&nbsp;<a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">contact@formal.land</a>!</p></div></div>]]></content>
        <author>
            <name>Guillaume Claret</name>
        </author>
        <category label="coq-of-rust" term="coq-of-rust"/>
        <category label="Rust" term="Rust"/>
        <category label="Coq" term="Coq"/>
        <category label="trait" term="trait"/>
        <category label="THIR" term="THIR"/>
        <category label="HIR" term="HIR"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Trait representation in Coq]]></title>
        <id>https://formal.land/blog/2023/08/25/trait-representation-in-coq</id>
        <link href="https://formal.land/blog/2023/08/25/trait-representation-in-coq"/>
        <updated>2023-08-25T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[In our project coq-of-rust we translate programs written in Rust to equivalent programs in the language of the proof system Coq&nbsp;üêì, which will later allow us to formally verify them.]]></summary>
        <content type="html"><![CDATA[<p>In our project <a href="https://github.com/formal-land/coq-of-rust" target="_blank" rel="noopener noreferrer">coq-of-rust</a> we translate programs written in <a href="https://www.rust-lang.org/" target="_blank" rel="noopener noreferrer">Rust</a> to equivalent programs in the language of the proof system <a href="https://coq.inria.fr/" target="_blank" rel="noopener noreferrer">Coq&nbsp;üêì</a>, which will later allow us to formally verify them.
Both Coq and Rust have many unique features, and there are many differences between them, so in the process of translation we need to treat the case of each language construction separately.
In this post, we discuss how we translate the most complicated one: <a href="https://doc.rust-lang.org/book/ch10-02-traits.html" target="_blank" rel="noopener noreferrer">traits</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-traits-in-rust">ü¶Ä Traits in Rust<a href="https://formal.land/blog/2023/08/25/trait-representation-in-coq#-traits-in-rust" class="hash-link" aria-label="Direct link to ü¶Ä Traits in Rust" title="Direct link to ü¶Ä Traits in Rust">‚Äã</a></h2>
<p>Trait is the way to define a shared behaviour for a group of types in Rust.
To define a trait we have to specify a list of signatures of the methods we want to be implemented for the types implementing our trait.
We can also create a generic definition of a trait with the same syntax as in every Rust definition.
Optionally, we can add a default implementation to any method or extend the list with associated types.
Traits can also extend a behaviour of one or more other traits, in which case, to implement a trait for a type we would have to implement all its supertraits first.</p>
<p>Consider the following example (adapted from the <a href="https://doc.rust-lang.org/book/" target="_blank" rel="noopener noreferrer">Rust Book</a>):</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token type-definition class-name">Sheep</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    naked</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">bool</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token lifetime-annotation symbol" style="color:#36acaa">'static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">str</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">trait</span><span class="token plain"> </span><span class="token type-definition class-name">Animal</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Associated function signature; `Self` refers to the implementor type.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">new</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token lifetime-annotation symbol" style="color:#36acaa">'static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">str</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Self</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Method signatures; these will return a string.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">name</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token lifetime-annotation symbol" style="color:#36acaa">'static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">str</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">noise</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token lifetime-annotation symbol" style="color:#36acaa">'static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">str</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Traits can provide default method definitions.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">talk</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token macro property" style="color:#36acaa">println!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"{} says {}"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">name</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">noise</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">impl</span><span class="token plain"> </span><span class="token class-name">Sheep</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">is_naked</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">bool</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">naked</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Implement the `Animal` trait for `Sheep`.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">impl</span><span class="token plain"> </span><span class="token class-name">Animal</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token class-name">Sheep</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// `Self` is the implementor type: `Sheep`.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">new</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token lifetime-annotation symbol" style="color:#36acaa">'static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">str</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">Sheep</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Sheep</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            naked</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">name</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token lifetime-annotation symbol" style="color:#36acaa">'static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">str</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">noise</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token lifetime-annotation symbol" style="color:#36acaa">'static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">str</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">is_naked</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">"baaaaah?"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">"baaaaah!"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Default trait methods can be overridden.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">talk</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// For example, we can add some quiet contemplation.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token macro property" style="color:#36acaa">println!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"{} pauses briefly... {}"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">noise</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">impl</span><span class="token plain"> </span><span class="token class-name">Sheep</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">shear</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">is_naked</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// Implementor methods can use the implementor's trait methods.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token macro property" style="color:#36acaa">println!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"{} is already naked..."</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">name</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token macro property" style="color:#36acaa">println!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"{} gets a haircut!"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">naked </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Type annotation is necessary in this case.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> dolly </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Animal</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">new</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Dolly"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Sheep</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dolly</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">talk</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dolly</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">shear</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dolly</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">talk</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We have a type <code>Sheep</code>, a trait <code>Animal</code>, and an implementation of <code>Animal</code> for <code>Sheep</code>.
As we can see in <code>main</code>, after a trait is implemented for a type, we can use the methods of the trait like normal methods of the type.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="our-translation">Our translation<a href="https://formal.land/blog/2023/08/25/trait-representation-in-coq#our-translation" class="hash-link" aria-label="Direct link to Our translation" title="Direct link to Our translation">‚Äã</a></h2>
<p>Rust notion of trait is very similar to the concept of <a href="https://en.wikipedia.org/wiki/Type_class" target="_blank" rel="noopener noreferrer">typeclasses</a> in <a href="https://en.wikipedia.org/wiki/Functional_programming" target="_blank" rel="noopener noreferrer">functional programming</a>.
Typeclasses are also present in Coq, so translation of this construction is quite straightforward.</p>
<p>For a given trait we create a typeclass with fields being just translated signatures of the methods of the trait.
To allow for the use of method syntax, we also define instances of <code>Notation.Dot</code> for every method name of the trait.
We also add a parameter of type <code>Set</code> for every type parameter of the trait and translate trait bounds of the types into equivalent typeclass parameters.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="translation-of-associated-types">Translation of associated types<a href="https://formal.land/blog/2023/08/25/trait-representation-in-coq#translation-of-associated-types" class="hash-link" aria-label="Direct link to Translation of associated types" title="Direct link to Translation of associated types">‚Äã</a></h2>
<p>Associated types are a bit harder than methods to translate, because it is possible to use <code>::</code> notation to access them.
For that purpose, we created another typeclass in <code>Notation</code> module:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Class</span><span class="token plain"> DoubleColonType </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Kind </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Type</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">type </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Kind</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Type</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  double_colon_type </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>with a notation:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Notation</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"e1 ::type[ e2 ]"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">Notation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">double_colon_type e1 e2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">at</span><span class="token plain"> level </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>For every associated type, we create a parameter and a field of the typeclass resulting from the trait translation, and below, we create an instance of <code>Notation.DoubleColonType</code>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-example-in-coq">The example in Coq<a href="https://formal.land/blog/2023/08/25/trait-representation-in-coq#the-example-in-coq" class="hash-link" aria-label="Direct link to The example in Coq" title="Direct link to The example in Coq">‚Äã</a></h2>
<p>Here is our Coq translation of the example code above:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">(* Generated by coq-of-rust *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Require</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Import</span><span class="token plain"> CoqOfRust</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CoqOfRust</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> Sheep</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Unset </span><span class="token keyword" style="color:#00009f">Primitive</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Projections</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Record</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    naked </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> bool</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ref str</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token attribute attr-name" style="color:#00a4db">Global</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Primitive</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Projections</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token attribute attr-name" style="color:#00a4db">Global</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Instance</span><span class="token plain"> Get_naked </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Notation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Dot </span><span class="token string" style="color:#e3116c">"naked"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">Notation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dot </span><span class="token operator" style="color:#393A34">'</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Build_t x0 </span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> x0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token attribute attr-name" style="color:#00a4db">Global</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Instance</span><span class="token plain"> Get_name </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Notation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Dot </span><span class="token string" style="color:#e3116c">"name"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">Notation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dot </span><span class="token operator" style="color:#393A34">'</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Build_t </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> x1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> x1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">End</span><span class="token plain"> Sheep</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> Sheep </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">@</span><span class="token plain">Sheep</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> Animal</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Class</span><span class="token plain"> Trait </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Self </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    new </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">H </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> State</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Trait</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ref str</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">M </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">H </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> H</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> Self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">H </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> State</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Trait</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ref Self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">M </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">H </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> H</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ref str</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    noise </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">H </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> State</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Trait</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ref Self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">M </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">H </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> H</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ref str</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token attribute attr-name" style="color:#00a4db">Global</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Instance</span><span class="token plain"> Method_new </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">H </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> State</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Trait</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`(</span><span class="token plain">Trait</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Notation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Dot </span><span class="token string" style="color:#e3116c">"new"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">Notation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dot </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> new</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token attribute attr-name" style="color:#00a4db">Global</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Instance</span><span class="token plain"> Method_name </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">H </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> State</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Trait</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`(</span><span class="token plain">Trait</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Notation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Dot </span><span class="token string" style="color:#e3116c">"name"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">Notation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dot </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> name</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token attribute attr-name" style="color:#00a4db">Global</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Instance</span><span class="token plain"> Method_noise </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">H </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> State</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Trait</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`(</span><span class="token plain">Trait</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Notation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Dot </span><span class="token string" style="color:#e3116c">"noise"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">Notation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dot </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> noise</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token attribute attr-name" style="color:#00a4db">Global</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Instance</span><span class="token plain"> Method_talk </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">H </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> State</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Trait</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">`(</span><span class="token plain">Trait</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Notation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Dot </span><span class="token string" style="color:#e3116c">"talk"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">Notation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dot </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ref Self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"name"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> format_argument</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"new_display"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr_of Œ±</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"noise"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> format_argument</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"new_display"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr_of Œ±</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">4</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            format_arguments</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"new_v1"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr_of </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">""</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">" says "</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr_of </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          std</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">stdio</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_print Œ±</span><span class="token number" style="color:#36acaa">4</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Pure tt </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Pure tt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">H </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> H</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> unit</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">End</span><span class="token plain"> Animal</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> Impl_traits_Sheep</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> Self </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> traits</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Sheep</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> is_naked </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">H </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> State</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Trait</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ref Self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">H </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> H</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> bool </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Pure self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"naked"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token attribute attr-name" style="color:#00a4db">Global</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Instance</span><span class="token plain"> Method_is_naked </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">H </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> State</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Trait</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">Notation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Dot </span><span class="token string" style="color:#e3116c">"is_naked"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">Notation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dot </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> is_naked</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">End</span><span class="token plain"> Impl_traits_Sheep</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> Impl_traits_Animal_for_traits_Sheep</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> Self </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> traits</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Sheep</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> new</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">H </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> State</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Trait</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ref str</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">H </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> H</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> traits</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Sheep </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Pure </span><span class="token punct punctuation" style="color:#393A34">{|</span><span class="token plain"> traits</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Sheep</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">name </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> name</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> traits</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Sheep</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">naked </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token attribute attr-name" style="color:#00a4db">Global</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Instance</span><span class="token plain"> AssociatedFunction_new </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">H </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> State</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Trait</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">Notation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DoubleColon Self </span><span class="token string" style="color:#e3116c">"new"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">Notation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">double_colon </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> new</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> name </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">H </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> State</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Trait</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ref Self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">H </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> H</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ref str</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Pure self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"name"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token attribute attr-name" style="color:#00a4db">Global</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Instance</span><span class="token plain"> Method_name </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">H </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> State</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Trait</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Notation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Dot </span><span class="token string" style="color:#e3116c">"name"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">Notation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dot </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> name</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> noise</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">H </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> State</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Trait</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ref Self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">H </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> H</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ref str</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"is_naked"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Œ±</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> bool</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Pure </span><span class="token string" style="color:#e3116c">"baaaaah?"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Pure </span><span class="token string" style="color:#e3116c">"baaaaah!"</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token attribute attr-name" style="color:#00a4db">Global</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Instance</span><span class="token plain"> Method_noise </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">H </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> State</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Trait</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Notation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Dot </span><span class="token string" style="color:#e3116c">"noise"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">Notation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dot </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> noise</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> talk </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">H </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> State</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Trait</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ref Self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">H </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> H</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> unit </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> format_argument</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"new_display"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr_of self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"name"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"noise"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> format_argument</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"new_display"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr_of Œ±</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          format_arguments</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"new_v1"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr_of </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">""</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">" pauses briefly... "</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr_of </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        std</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">stdio</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_print Œ±</span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Pure tt </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Pure tt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token attribute attr-name" style="color:#00a4db">Global</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Instance</span><span class="token plain"> Method_talk </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">H </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> State</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Trait</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Notation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Dot </span><span class="token string" style="color:#e3116c">"talk"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">Notation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dot </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> talk</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token attribute attr-name" style="color:#00a4db">Global</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Instance</span><span class="token plain"> I </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> traits</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Animal</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Trait Self </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    traits</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Animal</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">new </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">H </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> State</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Trait</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> new</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    traits</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Animal</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">name </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">H </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> State</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Trait</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> name</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    traits</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Animal</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">noise </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">H </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> State</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Trait</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> noise</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">End</span><span class="token plain"> Impl_traits_Animal_for_traits_Sheep</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> Impl_traits_Sheep_3</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> Self </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> traits</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Sheep</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> shear </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">H </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> State</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Trait</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> mut_ref Self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">H </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> H</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> unit </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"is_naked"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Œ±</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> bool</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"name"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> format_argument</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"new_display"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr_of Œ±</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            format_arguments</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"new_v1"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr_of </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">""</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">" is already naked...</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr_of </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          std</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">stdio</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_print Œ±</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Pure tt </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Pure tt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> format_argument</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"new_display"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr_of self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"name"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            format_arguments</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"new_v1"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr_of </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">""</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">" gets a haircut!</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr_of </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          std</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">stdio</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_print Œ±</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Pure tt </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> assign self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"naked"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> true </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Pure tt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token attribute attr-name" style="color:#00a4db">Global</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Instance</span><span class="token plain"> Method_shear </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">H </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> State</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Trait</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Notation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Dot </span><span class="token string" style="color:#e3116c">"shear"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">Notation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dot </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> shear</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">End</span><span class="token plain"> Impl_traits_Sheep_3</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">(* #[allow(dead_code)] - function was ignored by the compiler *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> main </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">H </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> State</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Trait</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">H </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> H</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> unit </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> dolly </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> Œ±</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> traits</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Animal</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">new </span><span class="token string" style="color:#e3116c">"Dolly"</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Pure </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Œ±</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> traits</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Sheep</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> dolly</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"talk"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> dolly</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"shear"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> dolly</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"talk"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Pure tt</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>As we can see, the trait <code>Animal</code> is translated to a module <code>Animal</code>. Every time we want to refer to the trait we use the name <code>Trait</code> or <code>Animal.Trait</code>, depending on whether we do it inside or outside its module.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="https://formal.land/blog/2023/08/25/trait-representation-in-coq#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">‚Äã</a></h2>
<p>Traits are similar enough to Coq classes to make the translation relatively intuitive.
The only hard case is a translation of associated types, for which we need a special notation.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Contact</div><div class="admonitionContent_BuS1"><p>If you have a Rust codebase that you wish to formally verify, or need advice in your work, contact us at&nbsp;<a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">contact@formal.land</a>. We will be happy to set up a call with you.</p></div></div>]]></content>
        <author>
            <name>Bart≈Çomiej Kr√≥likowski</name>
        </author>
        <category label="coq-of-rust" term="coq-of-rust"/>
        <category label="Rust" term="Rust"/>
        <category label="Coq" term="Coq"/>
        <category label="trait" term="trait"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Monad for side effects in Rust]]></title>
        <id>https://formal.land/blog/2023/05/28/monad-for-side-effects-in-rust</id>
        <link href="https://formal.land/blog/2023/05/28/monad-for-side-effects-in-rust"/>
        <updated>2023-05-28T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[To formally verify Rust programs, we are building coq-of-rust, a translator from Rust&nbsp;ü¶Ä code to the proof system Coq&nbsp;üêì. We generate Coq code that is as similar as possible to the original Rust code, so that the user can easily understand the generated code and write proofs about it. In this blog post, we explain how we are representing side effects in Coq.]]></summary>
        <content type="html"><![CDATA[<p>To formally verify Rust programs, we are building <a href="https://github.com/formal-land/coq-of-rust" target="_blank" rel="noopener noreferrer">coq-of-rust</a>, a translator from Rust&nbsp;ü¶Ä code to the proof system <a href="https://coq.inria.fr/" target="_blank" rel="noopener noreferrer">Coq&nbsp;üêì</a>. We generate Coq code that is as similar as possible to the original Rust code, so that the user can easily understand the generated code and write proofs about it. In this blog post, we explain how we are representing side effects in Coq.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-side-effects-in-rust">ü¶Ä Side effects in Rust<a href="https://formal.land/blog/2023/05/28/monad-for-side-effects-in-rust#-side-effects-in-rust" class="hash-link" aria-label="Direct link to ü¶Ä Side effects in Rust" title="Direct link to ü¶Ä Side effects in Rust">‚Äã</a></h2>
<p>In programming, <a href="https://en.wikipedia.org/wiki/Side_effect_(computer_science)" target="_blank" rel="noopener noreferrer">side effects</a> are all what is not representable by pure functions (mathematical functions, functions that always return the same output for given input parameters). In Rust there are various kinds of side effects:</p>
<ul>
<li>errors (the <a href="https://doc.rust-lang.org/core/macro.panic.html" target="_blank" rel="noopener noreferrer">panic!</a> macro) that propagate and do appear in the return type of functions,</li>
<li>non-termination, with some potentially non-terminating loops (never returning a result is considered as a side-effect),</li>
<li>control-flow, with the <code>break</code>, <code>continue</code>, <code>return</code> keywords, that can jump to a different part of the code,</li>
<li>memory allocations and memory mutations,</li>
<li>I/O, with for example the <a href="https://doc.rust-lang.org/std/macro.println.html" target="_blank" rel="noopener noreferrer">println!</a> macro, that prints a message to the standard output,</li>
<li>concurrency, with the <a href="https://doc.rust-lang.org/std/thread/fn.spawn.html" target="_blank" rel="noopener noreferrer">thread::spawn</a> function, that creates a new thread.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-coq-a-purely-functional-language">üêì Coq, a purely functional language<a href="https://formal.land/blog/2023/05/28/monad-for-side-effects-in-rust#-coq-a-purely-functional-language" class="hash-link" aria-label="Direct link to üêì Coq, a purely functional language" title="Direct link to üêì Coq, a purely functional language">‚Äã</a></h2>
<p>Like most proof systems, Coq is a purely functional language. This means we need to find an encoding for the side effects. The reason for most proof systems to forbid side effects is to be logically consistent. Otherwise, it would be easy to write a proof of <code>False</code> by writing a term that does not terminate for example.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="monads-in-coq">üîÆ&nbsp;Monads in Coq<a href="https://formal.land/blog/2023/05/28/monad-for-side-effects-in-rust#monads-in-coq" class="hash-link" aria-label="Direct link to üîÆ&nbsp;Monads in Coq" title="Direct link to üîÆ&nbsp;Monads in Coq">‚Äã</a></h2>
<p>Monads are a common way to represent side effects in a functional language. A monad is a type constructor <code>M</code>:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> M </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>representing computations returning values of type <code>A</code>. As an example we can take the error monad of computations that can fail with an error message, using the <a href="https://doc.rust-lang.org/std/result/enum.Result.html" target="_blank" rel="noopener noreferrer">Result</a> type like in Rust:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> M </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Result A string</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It must have two operators, <code>Pure</code> and <code>Bind</code>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-pure-operator">The <code>Pure</code> operator<a href="https://formal.land/blog/2023/05/28/monad-for-side-effects-in-rust#the-pure-operator" class="hash-link" aria-label="Direct link to the-pure-operator" title="Direct link to the-pure-operator">‚Äã</a></h3>
<p>The <code>Pure</code> operator has type:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> Pure </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M A </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It lifts a pure value <code>v</code> into the monad. For our error monad, the <code>Pure</code> operator is:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> Pure </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M A </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Ok v</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-bind-operator">The <code>Bind</code> operator<a href="https://formal.land/blog/2023/05/28/monad-for-side-effects-in-rust#the-bind-operator" class="hash-link" aria-label="Direct link to the-bind-operator" title="Direct link to the-bind-operator">‚Äã</a></h3>
<p>The <code>Bind</code> operator has type:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Bind</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A B </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e1 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">f </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> M B</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M B </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It sequences two computations <code>e1</code> with <code>f</code>, where <code>f</code> is a function that takes the result of <code>e1</code> as input and returns a new computation. We also note the <code>Bind</code> operator:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">let</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> x </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> e1 </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">e2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>assuming that <code>f</code> is a function that takes <code>x</code> as input and returns <code>e2</code>. Requiring this operator for all monads shows that sequencing computations is a very fundamental operation for side effects.</p>
<p>For our error monad, the <code>Bind</code> operator is:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Bind</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A B </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e1 </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">f </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> M B</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M B </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> e1 </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Ok v </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> f v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Err msg </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> Err msg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">end</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-state-exceptions-non-termination-control-flow">üöß State, exceptions, non-termination, control-flow<a href="https://formal.land/blog/2023/05/28/monad-for-side-effects-in-rust#-state-exceptions-non-termination-control-flow" class="hash-link" aria-label="Direct link to üöß State, exceptions, non-termination, control-flow" title="Direct link to üöß State, exceptions, non-termination, control-flow">‚Äã</a></h2>
<p>We use a single monad to represent all the side effects that interest us in Rust. This monad is called&nbsp;<code>M</code> and is defined as follows:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> RawMonad </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">State</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Trait</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> Exception</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Inductive</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">R </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Return </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> R </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t R</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Continue </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t R</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Break </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> t R</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> Panic </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> A </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> t R</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Arguments</span><span class="token plain"> Return </span><span class="token punctuation" style="color:#393A34">{</span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Arguments</span><span class="token plain"> Continue </span><span class="token punctuation" style="color:#393A34">{</span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Arguments</span><span class="token plain"> Break </span><span class="token punctuation" style="color:#393A34">{</span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Arguments</span><span class="token plain"> Panic </span><span class="token punctuation" style="color:#393A34">{</span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">End</span><span class="token plain"> Exception</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> Exception </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> Exception</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> Monad </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">State</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Trait</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">R A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  nat </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> State </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> RawMonad </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">A </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> Exception R</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> State</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> M </span><span class="token punctuation" style="color:#393A34">`{</span><span class="token plain">State</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Trait</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Monad Empty_set A</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We assume the definition of some <code>RawMonad</code> for memory handling that we will describe in a later post. Our monad&nbsp;<code>M</code> is a particular case of the monad&nbsp;<code>Monad</code> with <code>R = Empty_set</code>. It is a combination four monads:</p>
<ol>
<li>The <code>RawMonad</code>.</li>
<li>A state monad, that takes a <code>State</code> as input and a return an updated state as output. The trait <code>State.Trait</code> provides read/write operations on the <code>State</code> type.</li>
<li>An error monad with errors of type <code>Exception R</code>. There errors include the <code>Return</code>, <code>Continue</code>, <code>Break</code> and <code>Panic</code> constructors. The <code>Return</code> constructor is used to return a value from a function. The <code>Continue</code> constructor is used to continue the execution of a loop. The <code>Break</code> constructor is used to break the execution of a loop. The <code>Panic</code> constructor is used to panic with an error message. We implement all these operations as exceptions, even if only <code>Panic</code> is really an error, as they behave in the same way: interrupting the execution of the current sub-expression to bubble up to a certain level.</li>
<li>A fuel monad for non-termination, with the additional <code>nat</code> parameter.</li>
</ol>
<p>The parameter <code>R</code> of the type constructor <code>Monad</code> is used to represent the type of values that can be returned in the body of a function. It is the same as the return type of the function. So for a function returning a value of type <code>A</code>, we define its body in <code>Monad A A</code>. Then, we wrap it in an operator:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> catch_return </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">A </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Monad A A</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> M A </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>that catches the <code>Return</code> exceptions and returns the value.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="https://formal.land/blog/2023/05/28/monad-for-side-effects-in-rust#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">‚Äã</a></h2>
<p>We will see in the next post how we define the <code>RawMonad</code> to handle the Rust state of a program and memory allocation.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Contact</div><div class="admonitionContent_BuS1"><p>If you have a Rust codebase that you wish to formally verify, or need advice in your work, contact us at&nbsp;<a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">contact@formal.land</a>. We will be happy to set up a call with you.</p></div></div>]]></content>
        <category label="coq-of-rust" term="coq-of-rust"/>
        <category label="Rust" term="Rust"/>
        <category label="Coq" term="Coq"/>
        <category label="monad" term="monad"/>
        <category label="side effects" term="side effects"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Representation of Rust methods in Coq]]></title>
        <id>https://formal.land/blog/2023/04/26/representation-of-rust-methods-in-coq</id>
        <link href="https://formal.land/blog/2023/04/26/representation-of-rust-methods-in-coq"/>
        <updated>2023-04-26T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[With our project coq-of-rust we aim to translate high-level Rust code to similar-looking Coq code, to formally verify Rust programs. One of the important constructs in the Rust language is the method syntax. In this post, we present our technique to translate Rust methods using type-classes in Coq.]]></summary>
        <content type="html"><![CDATA[<p>With our project <a href="https://github.com/formal-land/coq-of-rust" target="_blank" rel="noopener noreferrer">coq-of-rust</a> we aim to translate high-level Rust code to similar-looking <a href="https://coq.inria.fr/" target="_blank" rel="noopener noreferrer">Coq</a> code, to <a href="https://en.wikipedia.org/wiki/Formal_verification" target="_blank" rel="noopener noreferrer">formally verify</a> Rust programs. One of the important constructs in the Rust language is the <a href="https://doc.rust-lang.org/book/ch05-03-method-syntax.html" target="_blank" rel="noopener noreferrer">method syntax</a>. In this post, we present our technique to translate Rust methods using type-classes in Coq.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="rust-code-to-translate">Rust Code To Translate<a href="https://formal.land/blog/2023/04/26/representation-of-rust-methods-in-coq#rust-code-to-translate" class="hash-link" aria-label="Direct link to Rust Code To Translate" title="Direct link to Rust Code To Translate">‚Äã</a></h2>
<p>Consider the following Rust example, which contains a method (adapted from the <a href="https://doc.rust-lang.org/book/" target="_blank" rel="noopener noreferrer">Rust Book</a>):</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token type-definition class-name">Rectangle</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    width</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u32</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    height</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u32</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">impl</span><span class="token plain"> </span><span class="token class-name">Rectangle</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Here "area" is a method</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">area</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u32</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">width </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">height</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> rect1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Rectangle</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        width</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        height</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">50</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token macro property" style="color:#36acaa">println!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">"The area of the rectangle is {} square pixels."</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// We are calling this method there</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rect1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">area</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The Rust compiler can find the implementation of the <code>.area()</code> method call because it knows that the type of <code>rect1</code> is <code>Rectangle</code>. There could be other <code>area</code> methods defined for different types, and the code would still compile calling the <code>area</code> method of <code>Rectangle</code>.</p>
<p>Coq has no direct equivalent for calling a function based on its name and type.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="our-translation">Our Translation<a href="https://formal.land/blog/2023/04/26/representation-of-rust-methods-in-coq#our-translation" class="hash-link" aria-label="Direct link to Our Translation" title="Direct link to Our Translation">‚Äã</a></h2>
<p>Here is our Coq translation of the code above:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">(* Generated by coq-of-rust *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Require</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Import</span><span class="token plain"> CoqOfRust</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CoqOfRust</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Import</span><span class="token plain"> Root</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">std</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">prelude</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">rust_2015</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> Rectangle</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token number" style="color:#36acaa">7</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">   </span><span class="token keyword" style="color:#00009f">Record</span><span class="token plain"> t </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">     width </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> u32</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">     height </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> u32</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">   </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">11</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">12</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">   </span><span class="token attribute attr-name" style="color:#00a4db">Global</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Instance</span><span class="token plain"> Get_width </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Notation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Dot </span><span class="token string" style="color:#e3116c">"width"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">13</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">     </span><span class="token keyword" style="color:#00009f">Notation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dot </span><span class="token operator" style="color:#393A34">'</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Build_t x0 </span><span class="token keyword" style="color:#00009f">_</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> x0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">14</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">   </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">15</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">   </span><span class="token attribute attr-name" style="color:#00a4db">Global</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Instance</span><span class="token plain"> Get_height </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Notation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Dot </span><span class="token string" style="color:#e3116c">"height"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">16</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">     </span><span class="token keyword" style="color:#00009f">Notation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dot </span><span class="token operator" style="color:#393A34">'</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Build_t </span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> x1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> x1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">17</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">   </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">18</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">End</span><span class="token plain"> Rectangle</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">19</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> Rectangle </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> Rectangle</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">20</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">21</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> ImplRectangle</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">22</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">   </span><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> Self </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> Rectangle</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">23</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">24</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">   </span><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> area </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ref Self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> u32 </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">25</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">     self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"width"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"mul"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"height"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">26</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">27</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">   </span><span class="token attribute attr-name" style="color:#00a4db">Global</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Instance</span><span class="token plain"> Method_area </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Notation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Dot </span><span class="token string" style="color:#e3116c">"area"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">28</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">     </span><span class="token keyword" style="color:#00009f">Notation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dot </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> area</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">29</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">   </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">30</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">End</span><span class="token plain"> ImplRectangle</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">31</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">32</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> main </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">_</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> unit</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> unit </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">33</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">   </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> rect1 </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punct punctuation" style="color:#393A34">{|</span><span class="token plain"> Rectangle</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">width </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> Rectangle</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">height </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">50</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">34</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">   _crate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_print</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">35</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">     </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_crate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">Arguments</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"new_v1"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">36</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">       </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"The area of the rectangle is "</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">" square pixels.\n"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">37</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">       </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> _crate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ArgumentV1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"new_display"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> rect1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"area"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">38</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">   tt </span><span class="token punctuation" style="color:#393A34">;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">39</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">   tt</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>On line <code>24</code> we define the <code>area</code> function. On line <code>27</code> we declare that <code>area</code> is a method. On line <code>37</code> we call the <code>area</code> method on <code>rect1</code> with:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rect1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"area"</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>which closely resembles the source Rust code:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rect1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">area</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Coq can automatically find the code of the <code>area</code> method to call.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="how-it-works">How It Works<a href="https://formal.land/blog/2023/04/26/representation-of-rust-methods-in-coq#how-it-works" class="hash-link" aria-label="Direct link to How It Works" title="Direct link to How It Works">‚Äã</a></h2>
<p>The code:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rect1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"area"</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>is actually a notation for:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Notation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dot </span><span class="token string" style="color:#e3116c">"area"</span><span class="token plain"> rect1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Then we leverage the inference mechanism of type-classes in Coq to find the code of the <code>area</code> method:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Notation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">(** A class to represent the notation [e1.e2]. This is mainly used to call</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">      methods, or access to named or indexed fields of structures.</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">      The kind is either a string or an integer. *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Class</span><span class="token plain"> Dot </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Kind </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Kind</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">T </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dot </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> T</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Arguments</span><span class="token plain"> dot </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Kind</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> name </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">T Dot</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">End</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Notation</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The <code>Dot</code> class has three parameters: <code>Kind</code>, <code>name</code>, and <code>T</code>. <code>Kind</code> is the type of the name of the method (generally a string but it could be an integer in rare cases), <code>name</code> is the name of the method, and <code>T</code> is the type of the method. The <code>dot</code> field of the class is the code of the method.</p>
<p>When we define the class instance:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">27</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">   </span><span class="token attribute attr-name" style="color:#00a4db">Global</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Instance</span><span class="token plain"> Method_area </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Notation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Dot </span><span class="token string" style="color:#e3116c">"area"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">28</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">     </span><span class="token keyword" style="color:#00009f">Notation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dot </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> area</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">29</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">   </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>we instantiate the class <code>Notation.Dot</code> with three parameters:</p>
<ul>
<li><code>Kind</code> (inferred) is <code>string</code> because the name of the method is a string,</li>
<li><code>name</code> is <code>"area"</code> because the name of the method is <code>area</code>,</li>
<li><code>T</code> (inferred) is <code>ref Rectangle -&gt; u32</code> because the method is declared as <code>fn area(&amp;self) -&gt; u32</code>.</li>
</ul>
<p>Then we define the <code>dot</code> field of the class instance to be the <code>area</code> function.</p>
<p>When we call:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Notation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dot </span><span class="token string" style="color:#e3116c">"area"</span><span class="token plain"> rect1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Coq will automatically find the class instance <code>Method_area</code> because the type of <code>rect1</code> is <code>Rectangle</code> and the name of the method is <code>"area"</code>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="other-use-cases">Other Use Cases<a href="https://formal.land/blog/2023/04/26/representation-of-rust-methods-in-coq#other-use-cases" class="hash-link" aria-label="Direct link to Other Use Cases" title="Direct link to Other Use Cases">‚Äã</a></h2>
<p>The <code>Dot</code> class is also used to access to named or indexed fields of structures or traits. We use a similar mechanism for associated functions. For example, the Rust code:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> rect1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Rectangle</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">square</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>is translated to:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> rect1 </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> Rectangle</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"square"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>with a type-class for the <code>type::[name]</code> notation as follows:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Module</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Notation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">(** A class to represent associated functions (the notation [e1::e2]). The</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">      kind might be [Set] for functions associated to a type,</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">      or [Set -&gt; Set] for functions associated to a trait. *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Class</span><span class="token plain"> DoubleColon </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Kind </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Type</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">type </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Kind</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">T </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Set</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">Set</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    double_colon </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> T</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Arguments</span><span class="token plain"> double_colon </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Kind</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> type name </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">T DoubleColon</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">End</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Notation</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="in-conclusion">In Conclusion<a href="https://formal.land/blog/2023/04/26/representation-of-rust-methods-in-coq#in-conclusion" class="hash-link" aria-label="Direct link to In Conclusion" title="Direct link to In Conclusion">‚Äã</a></h2>
<p>The type-classes mechanism of Coq appears flexible enough to represent our current use cases involving methods and associated functions. It remains to be seen whether this approach will suffice for future use cases.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Contact</div><div class="admonitionContent_BuS1"><p>If you have a Rust codebase that you wish to formally verify, or need advice in your work, contact us at&nbsp;<a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">contact@formal.land</a>. We will be happy to set up a call with you.</p></div></div>]]></content>
        <category label="coq-of-rust" term="coq-of-rust"/>
        <category label="Rust" term="Rust"/>
        <category label="Coq" term="Coq"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Current formal verification efforts üí™]]></title>
        <id>https://formal.land/blog/2023/01/24/current-verification-efforts</id>
        <link href="https://formal.land/blog/2023/01/24/current-verification-efforts"/>
        <updated>2023-01-24T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[We are diversifying ourselves to apply formal verification on 3Ô∏è‚É£ new languages with Solidity, Rust, and TypeScript. In this article we describe our approach. For these three languages, we translate the code to the proof system üêì&nbsp;Coq. We generate the cleanest&nbsp;üßº possible output to simplify the formal verification&nbsp;üìê effort that comes after.]]></summary>
        <content type="html"><![CDATA[<p>We are diversifying ourselves to apply <a href="https://en.wikipedia.org/wiki/Formal_verification" target="_blank" rel="noopener noreferrer">formal verification</a> on 3Ô∏è‚É£ new languages with <strong>Solidity</strong>, <strong>Rust</strong>, and <strong>TypeScript</strong>. In this article we describe our approach. For these three languages, we translate the code to the proof system <a href="https://coq.inria.fr/" target="_blank" rel="noopener noreferrer">üêì&nbsp;Coq</a>. We generate the cleanest&nbsp;üßº possible output to simplify the formal verification&nbsp;üìê effort that comes after.</p>
<blockquote>
<p>Formal verification is a way to ensure that a program follows its specification in&nbsp;üíØ% of cases thanks to the use of mathematical methods. It removes far more bugs and security issues than testing, and is necessary to deliver software of the highest quality&nbsp;üíé.</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="Ô∏è-general-plan">üó∫Ô∏è General plan<a href="https://formal.land/blog/2023/01/24/current-verification-efforts#%EF%B8%8F-general-plan" class="hash-link" aria-label="Direct link to üó∫Ô∏è General plan" title="Direct link to üó∫Ô∏è General plan">‚Äã</a></h2>
<p>To apply formal verification to real-sized applications, we need to handle thousands of lines of code in a seamless way. We rely on the proof system Coq to write our proofs, as it has a mature ecosystem, and automated (SMT) and interactive ways to write proofs. To keep the proofs simple, we must find an efficient way to convert an existing and evolving codebase to Coq.</p>
<p>For example, given the following TypeScript example:</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">checkIfEnoughCredits</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">user</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> User</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> credits</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">boolean</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">user</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">isAdmin</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> credits </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> credits </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1000</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>we want to generate the corresponding Coq code in an automated way:</p>
<div class="language-coq codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-coq codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">Definition</span><span class="token plain"> checkIfEnoughCredits </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">user </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> User</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">credits </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> bool </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> user</span><span class="token punctuation" style="color:#393A34">.(</span><span class="token plain">User</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">isAdmin</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    credits </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    credits </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1000</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This is the exact equivalent written using the Coq syntax, where we check the <code>credits</code> condition depending on the user's status. This is the <code>checkIfEnoughCredits</code> definition a Coq developer would directly write, in an idiomatic way.</p>
<p>We make some hypothesis on the input code. In TypeScript we assume the code does not contain mutations, which is often the case to simplify asynchronous code. In Rust we have other hypothesis as making safe mutations is one of the keys features of the language and a frequent pattern. For each language we look for a correct subset to work on, to support common use cases and still generate a clean&nbsp;Coq code.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-solidity">üá∏ Solidity<a href="https://formal.land/blog/2023/01/24/current-verification-efforts#-solidity" class="hash-link" aria-label="Direct link to üá∏ Solidity" title="Direct link to üá∏ Solidity">‚Äã</a></h2>
<p>‚û°Ô∏è <a href="https://formal.land/docs/verification/solidity">Project page</a> ‚¨ÖÔ∏è</p>
<p>The <a href="https://soliditylang.org/" target="_blank" rel="noopener noreferrer">Solidity language</a> is the main language to write smart contracts on the <a href="https://ethereum.org/" target="_blank" rel="noopener noreferrer">Ethereum</a> blockchain. As smart contracts cannot be easily updated and handle a large amount of money, it is critical to formally verify them to prevent bugs.</p>
<p>Our strategy is to develop a translator <a href="https://gitlab.com/formal-land/coq-of-solidity" target="_blank" rel="noopener noreferrer">coq-of-solidity</a> from Solidity to Coq. We are using an implementation of an <a href="https://en.wikipedia.org/wiki/Ethereum#ERC20" target="_blank" rel="noopener noreferrer">ERC-20</a> smart contract as an example to guide our translation. Two top difficulties in the translation of Solidity programs are:</p>
<ul>
<li>the use of object-oriented programming with inheritance on classes,</li>
<li>the use of mutations and errors, that need to be handled in a monad.</li>
</ul>
<p>We are still trying various approach to handle these difficulties and generate a clean Coq output for most cases.</p>
<p>In addition to our work on Solidity, we are looking at the <a href="https://ethereum.org/en/developers/docs/evm/" target="_blank" rel="noopener noreferrer">EVM code</a> that is the assembly language of Ethereum. It has the advantage of being more stable and with a simpler semantics than Solidity. However, it is not as expressive and programs in EVM are much harder to read. We have a prototype of translator from EVM to Coq named <a href="https://gitlab.com/formal-land/ethereum-vm-to-coq" target="_blank" rel="noopener noreferrer">ethereum-vm-to-coq</a>. An interesting goal will be to connect the translation of Solidity and of EVM in Coq to show that they have the same semantics on a given smart contract.</p>
<p>Note that EVM is the target language of many verification project on Ethereum such as <a href="https://www.certora.com/" target="_blank" rel="noopener noreferrer">Certora</a> or static analyzers. We prefer to target Solidity as it is more expressive and the generated code in Coq will thus be easier to verify.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-rust">ü¶Ä Rust<a href="https://formal.land/blog/2023/01/24/current-verification-efforts#-rust" class="hash-link" aria-label="Direct link to ü¶Ä Rust" title="Direct link to ü¶Ä Rust">‚Äã</a></h2>
<p>‚û°Ô∏è <a href="https://formal.land/docs/verification/rust">Project page</a> ‚¨ÖÔ∏è</p>
<p>The <a href="https://www.rust-lang.org/" target="_blank" rel="noopener noreferrer">Rust language</a> is a modern systems programming language that is gaining popularity. It is a safe language that prevents many common errors such as buffer overflows or use-after-free. It is also a language that is used to write low-level code, such as drivers or operating systems. As such, it is critical to formally verify Rust programs to prevent bugs.</p>
<p>We work in collaboration with the team developing the <a href="https://github.com/AeneasVerif" target="_blank" rel="noopener noreferrer">Aeneas</a> project, with people from Inria and Microsoft. The aim is to translate Rust code with mutations to a purely functional form in Coq (without mutations) to simplify the verification effort and avoid the need of separation logic. The idea of this translation is explained in the <a href="https://dl.acm.org/doi/abs/10.1145/3547647" target="_blank" rel="noopener noreferrer">Aeneas paper</a>.</p>
<p>There are two steps in the translation:</p>
<ol>
<li><strong>From <a href="https://rustc-dev-guide.rust-lang.org/mir/index.html" target="_blank" rel="noopener noreferrer">MIR</a> (low-level intermediate form of Rust) to LLBC.</strong> This is a custom language for the project that contains all the information of MIR but is better suited for analysis. For example, instead of using a control-flow graph it uses control structures and an abstract syntax tree. This step is implemented in Rust.</li>
<li><strong>From LLBC to Coq.</strong> This is the heart of the project and is implemented in OCaml. This is where the translation from mutations to a purely functional form occurs.</li>
</ol>
<p>For now we are focusing on adding new features to LLBC and improving the user experience: better error messages, generation of an output with holes for unhandled Rust features.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-typescript">üåê TypeScript<a href="https://formal.land/blog/2023/01/24/current-verification-efforts#-typescript" class="hash-link" aria-label="Direct link to üåê TypeScript" title="Direct link to üåê TypeScript">‚Äã</a></h2>
<p>‚û°Ô∏è <a href="https://formal.land/docs/verification/typescript">Project page</a> ‚¨ÖÔ∏è</p>
<p>We have a <a href="https://formal-land.github.io/coq-of-js/" target="_blank" rel="noopener noreferrer">üìΩÔ∏è&nbsp;demo project</a> to showcase the translation of a purely functional subset of JavaScript to Coq. We handle functions and basic data types such as records, enums and discriminated unions. We are now porting the code to TypeScript in <a href="https://github.com/formal-land/coq-of-ts" target="_blank" rel="noopener noreferrer">coq-of-ts</a>. We prefer to work on TypeScript rather than JavaScript as type information are useful to guide the translation, and avoid the need of additional annotations on the source code.</p>
<p>Our next target will be to make <code>coq-of-ts</code> usable on real-life project example.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Social media</div><div class="admonitionContent_BuS1"><p>Follow us on Twitter at <a href="https://twitter.com/LandFoobar" target="_blank" rel="noopener noreferrer">Twitter</a> üê¶ and <a href="https://t.me/formal_land" target="_blank" rel="noopener noreferrer">Telegram</a> to get the latest news about our projects. If you think our work is interesting, please share it with your friends and colleagues. üôè</p></div></div>]]></content>
        <category label="coq-of-ocaml" term="coq-of-ocaml"/>
        <category label="OCaml" term="OCaml"/>
        <category label="Solidity" term="Solidity"/>
        <category label="Rust" term="Rust"/>
        <category label="TypeScript" term="TypeScript"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Latest blog posts on our formal verification effort on Tezos]]></title>
        <id>https://formal.land/blog/2022/12/13/latest-blog-posts-on-tezos</id>
        <link href="https://formal.land/blog/2022/12/13/latest-blog-posts-on-tezos"/>
        <updated>2022-12-13T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Here we recall some blog articles that we have written since this summer, on the formal verification of the protocol of Tezos. For this project, we are verifying a code base of around 100,000 lines of OCaml code. We automatically convert the OCaml code to the proof system Coq using the converter coq-of-ocaml. We then apply various proof techniques to make sure that the protocol of Tezos does not contain bugs.]]></summary>
        <content type="html"><![CDATA[<p>Here we recall some blog articles that we have written since this summer, on the <a href="https://formal-land.gitlab.io/coq-tezos-of-ocaml/" target="_blank" rel="noopener noreferrer">formal verification of the protocol of Tezos</a>. For this project, we are verifying a code base of around 100,000 lines of OCaml code. We automatically convert the OCaml code to the proof system Coq using the converter <a href="https://github.com/formal-land/coq-of-ocaml" target="_blank" rel="noopener noreferrer">coq-of-ocaml</a>. We then apply various proof techniques to make sure that the protocol of Tezos does not contain bugs.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="blog-articles-">Blog articles üìù<a href="https://formal.land/blog/2022/12/13/latest-blog-posts-on-tezos#blog-articles-" class="hash-link" aria-label="Direct link to Blog articles üìù" title="Direct link to Blog articles üìù">‚Äã</a></h2>
<p>Here is the list of articles about the work we have done since this summer. We believe that some of this work is very unique and specific to Tezos.</p>
<ul>
<li><a href="https://formal-land.gitlab.io/coq-tezos-of-ocaml/blog/2022/12/12/internal-errors-step-by-step/" target="_blank" rel="noopener noreferrer">The error monad, internal errors and validity predicates, step-by-step</a> by <em>Pierre Vial</em>: a detailed explanation of what we are doing to verify the absence of unexpected errors in the whole code base;</li>
<li><a href="https://formal-land.gitlab.io/coq-tezos-of-ocaml/blog/2022/10/18/absence-of-internal-errors/" target="_blank" rel="noopener noreferrer">Absence of internal errors</a> by <em>Guillaume Claret</em>: the current state of our proofs to verify the absence of unexpected errors;</li>
<li><a href="https://formal-land.gitlab.io/coq-tezos-of-ocaml/blog/2022/10/03/verifying-the-skip-list-inductive-predicates/" target="_blank" rel="noopener noreferrer">Skip-list verification. Using inductive predicates</a> by <em>Bart≈Çomiej Kr√≥likowski</em> and <em>Natalie Klaus</em>: a presentation of our verification effort on the skip-list algorithm implementation (part 2);</li>
<li><a href="https://formal-land.gitlab.io/coq-tezos-of-ocaml/blog/2022/10/03/verifying-the-skip-list/" target="_blank" rel="noopener noreferrer">Verifying the skip-list</a> by <em>Natalie Klaus</em> and <em>Bart≈Çomiej Kr√≥likowski</em>: a presentation of our verification effort on the skip-list algorithm implementation (part 1);</li>
<li><a href="https://formal-land.gitlab.io/coq-tezos-of-ocaml/blog/2022/08/15/verify-json-data-encoding/" target="_blank" rel="noopener noreferrer">Verifying json-data-encoding</a> by <em>Tait van Strien</em>: our work to verify an external library used by the Tezos protocol, to safely serialize data to JSON values;</li>
<li><a href="https://formal-land.gitlab.io/coq-tezos-of-ocaml/blog/2022/07/19/fixing-proofs/" target="_blank" rel="noopener noreferrer">Fixing reused proofs</a> by <em>Bart≈Çomiej Kr√≥likowski</em>: a presentation, with examples, of the work we do to maintain existing proofs and specifications as the code evolves;</li>
<li><a href="https://formal-land.gitlab.io/coq-tezos-of-ocaml/blog/2022/06/07/formal-verification-of-property-based-tests/" target="_blank" rel="noopener noreferrer">Formal verification of property based tests</a> by <em>Guillaume Claret</em>: the principle and status of our work to formally verify the generalized case of property-based tests;</li>
<li><a href="https://formal-land.gitlab.io/coq-tezos-of-ocaml/blog/2022/06/02/plan-backward-compatibility" target="_blank" rel="noopener noreferrer">Plan for backward compatibility verification</a> by <em>Guillaume Claret</em>: an explanation of the strategy we use to show that two successive versions of the Tezos protocol are fully backward compatible.</li>
</ul>
<p>To follow more of our activity, feel free to register on our <a href="https://twitter.com/LandFoobar" target="_blank" rel="noopener noreferrer">Twitter account üê¶</a>! If you need services or advices to formally verify your code base, you can drop us an <a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">email üìß</a>!</p>]]></content>
        <category label="coq-tezos-of-ocaml" term="coq-tezos-of-ocaml"/>
        <category label="Tezos" term="Tezos"/>
        <category label="coq-of-ocaml" term="coq-of-ocaml"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Upgrade coq-of-ocaml to OCaml 4.14]]></title>
        <id>https://formal.land/blog/2022/06/23/upgrade-coq-of-ocaml-4.14</id>
        <link href="https://formal.land/blog/2022/06/23/upgrade-coq-of-ocaml-4.14"/>
        <updated>2022-06-23T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[In an effort to support the latest version of the protocol of Tezos we upgraded coq-of-ocaml to add compatibility with OCaml 4.14. The result is available in the branch ocaml-4.14. We describe here how we made this upgrade.]]></summary>
        <content type="html"><![CDATA[<p>In an effort to support the latest version of the <a href="https://gitlab.com/tezos/tezos/-/tree/master/src/proto_alpha/lib_protocol" target="_blank" rel="noopener noreferrer">protocol of Tezos</a> we upgraded <a href="https://github.com/formal-land/coq-of-ocaml" target="_blank" rel="noopener noreferrer"><code>coq-of-ocaml</code></a> to add compatibility with OCaml 4.14. The result is available in the branch <a href="https://github.com/formal-land/coq-of-ocaml/pull/217" target="_blank" rel="noopener noreferrer"><code>ocaml-4.14</code></a>. We describe here how we made this upgrade.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="usage-of-merlin">Usage of Merlin<a href="https://formal.land/blog/2022/06/23/upgrade-coq-of-ocaml-4.14#usage-of-merlin" class="hash-link" aria-label="Direct link to Usage of Merlin" title="Direct link to Usage of Merlin">‚Äã</a></h2>
<p>In <code>coq-of-ocaml</code> we are using <a href="https://github.com/ocaml/merlin" target="_blank" rel="noopener noreferrer">Merlin</a> to get the typed <a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree" target="_blank" rel="noopener noreferrer">abstract syntax tree</a> of OCaml files. We see the AST through the <a href="https://docs.mirage.io/ocaml/Typedtree/index.html" target="_blank" rel="noopener noreferrer">Typedtree</a> interface, together with an access to all the definitions of the current compilation environment. Merlin computes the current environment by understanding how an OCaml project is configured and connecting to the <a href="https://dune.build/" target="_blank" rel="noopener noreferrer">dune</a> build system. The environment is mandatory for certain transformations in <code>coq-of-ocaml</code>, like:</p>
<ul>
<li>finding a canonical name for module types;</li>
<li>propagating phantom types.</li>
</ul>
<p>In order to use Merlin as a library (rather than as a daemon), we vendor the <a href="https://github.com/rgrinberg/merlin/tree/lsp" target="_blank" rel="noopener noreferrer">LSP version</a> of <a href="https://github.com/rgrinberg" target="_blank" rel="noopener noreferrer">rgrinberg</a> in the folder <a href="https://github.com/formal-land/coq-of-ocaml/tree/master/vendor" target="_blank" rel="noopener noreferrer"><code>vendor/</code></a>. This vendored version works with no extra configurations.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="upgrade">Upgrade<a href="https://formal.land/blog/2022/06/23/upgrade-coq-of-ocaml-4.14#upgrade" class="hash-link" aria-label="Direct link to Upgrade" title="Direct link to Upgrade">‚Äã</a></h2>
<p>When a new version of OCaml is out, we upgrade our vendored version of Merlin to a compatible one. Then we do the necessary changes to <code>coq-of-ocaml</code>, as the interface of the AST generally evolves with small changes. For OCaml 4.14, the main change was some types becoming abstract such as <code>Types.type_expr</code>. To access to the fields of these types, we now need to use a specific getter and do changes such as:</p>
<div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token inserted-sign inserted prefix inserted" style="color:#36acaa">+</span><span class="token inserted-sign inserted line" style="color:#36acaa">    match typ.desc with</span><br></span><span class="token-line" style="color:#393A34"><span class="token inserted-sign inserted line" style="color:#36acaa"></span><span class="token deleted-sign deleted prefix deleted" style="color:#d73a49">-</span><span class="token deleted-sign deleted line" style="color:#d73a49">    match Types.get_desc typ with</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This made some patterns in <code>match</code> expressions more complex, but otherwise the changes were very minimal. We ran all the unit-tests of <code>coq-of-ocaml</code> after the upgrade and they were still valid.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="git-submodule-or-copy--paste">Git submodule or copy &amp; paste?<a href="https://formal.land/blog/2022/06/23/upgrade-coq-of-ocaml-4.14#git-submodule-or-copy--paste" class="hash-link" aria-label="Direct link to Git submodule or copy &amp; paste?" title="Direct link to Git submodule or copy &amp; paste?">‚Äã</a></h2>
<p>To vendor Merlin we have two possibilities:</p>
<ol>
<li>Using a <a href="https://git-scm.com/book/en/v2/Git-Tools-Submodules" target="_blank" rel="noopener noreferrer">Git submodule</a>.</li>
<li>Doing a copy &amp; paste of the code.</li>
</ol>
<p>The first possibility is more efficient in terms of space, but there are a few disadvantages:</p>
<ul>
<li>we cannot make small modifications if needed;</li>
<li>the archives generated by Github do not contain the code of the submodules (see this <a href="https://github.com/dear-github/dear-github/issues/214" target="_blank" rel="noopener noreferrer">issue</a>)</li>
<li>if a commit in the repository for the submodule disappears, then the submodule is unusable.</li>
</ul>
<p>The last reason forced us to do a copy &amp; paste for OCaml 4.14. We now have to be cautious not to commit the generate <code>.ml</code> file for the OCaml parser.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="next">Next<a href="https://formal.land/blog/2022/06/23/upgrade-coq-of-ocaml-4.14#next" class="hash-link" aria-label="Direct link to Next" title="Direct link to Next">‚Äã</a></h2>
<p>The next change will be doing the upgrade to OCaml 5. There should be much more changes, and in particular a new way of handling the effects. We do not know yet if it will be possible to translate the effect handlers to Coq in a nice way.</p>]]></content>
        <category label="coq-of-ocaml" term="coq-of-ocaml"/>
        <category label="ocaml" term="ocaml"/>
        <category label="4.14" term="4.14"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Status update on the verification of Tezos]]></title>
        <id>https://formal.land/blog/2022/06/15/status update-tezos</id>
        <link href="https://formal.land/blog/2022/06/15/status update-tezos"/>
        <updated>2022-06-15T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Here we give an update on our verification effort on the protocol of Tezos. We add the marks:]]></summary>
        <content type="html"><![CDATA[<p>Here we give an update on our <a href="https://formal-land.gitlab.io/coq-tezos-of-ocaml/" target="_blank" rel="noopener noreferrer">verification effort</a> on the protocol of Tezos. We add the marks:</p>
<ul>
<li>‚úÖ for "rather done"</li>
<li>üåä for "partially done"</li>
<li>‚ùå for "most is yet to do"</li>
</ul>
<p>On the website of project, we also automatically generates pages such as <a href="https://formal-land.gitlab.io/coq-tezos-of-ocaml/docs/status/compare/" target="_blank" rel="noopener noreferrer">Compare</a> to follow the status of the tasks.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="maintenance-of-the-translation-">Maintenance of the translation ‚úÖ<a href="https://formal.land/blog/2022/06/15/status%20update-tezos#maintenance-of-the-translation-" class="hash-link" aria-label="Direct link to Maintenance of the translation ‚úÖ" title="Direct link to Maintenance of the translation ‚úÖ">‚Äã</a></h2>
<p>We were able to maintain most of the translation from OCaml to Coq of the protocol of Tezos using <a href="https://github.com/formal-land/coq-of-ocaml" target="_blank" rel="noopener noreferrer">coq-of-ocaml</a>, including all the translation of the Michelson interpreter. There was an increase in the size of the OCaml code base in recent months, due to new features added in Tezos like the <a href="https://research-development.nomadic-labs.com/tezos-is-scaling.html" target="_blank" rel="noopener noreferrer">rollups</a>. Here are the numbers of lines of code (<code>.ml</code> and <code>.mli</code> files) for the various protocol versions:</p>
<ul>
<li>protocol H: <code>51147</code></li>
<li>protocol I: <code>59535</code></li>
<li>protocol J: <code>83271</code> (increase mainly due to the rollups)</li>
<li>protocol Alpha (development version of K): <code>90716</code></li>
</ul>
<p>We still translate most of the protocol code up to version J. We stayed on version J for a while as we wanted to add as many proofs as possible before doing a proof of backward compatibility between J and K. We are currently updating the translation to support the protocol version Alpha, preparing for the translation of K.</p>
<p>For protocol J, we needed to add a <a href="https://gitlab.com/nomadic-labs/coq-tezos-of-ocaml/-/blob/master/blacklist.txt" target="_blank" rel="noopener noreferrer">blacklist.txt</a> of files that we do not support. Indeed, we need to add new changes to <code>coq-of-ocaml</code> to support these or do hard-to-maintain changes to <a href="https://gitlab.com/tezos/tezos/-/merge_requests/3303" target="_blank" rel="noopener noreferrer">our fork</a> of the Tezos protocol. We plan to complete the translation and remove this black-list for the protocol J soon (in a week or two).</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="size-of-the-proofs-">Size of the proofs ‚úÖ<a href="https://formal.land/blog/2022/06/15/status%20update-tezos#size-of-the-proofs-" class="hash-link" aria-label="Direct link to Size of the proofs ‚úÖ" title="Direct link to Size of the proofs ‚úÖ">‚Äã</a></h2>
<p>One of our plans is to have a reasonable quantity of proofs, to cover a reasonable quantity of code and properties from the protocol. We believe we have a good quantity of proofs now, as we have more than 50,000 lines of Coq code (for an OCaml codebase of 80,000 lines).</p>
<p>In addition to our main targets, we verify many "smaller" properties, such as:</p>
<ul>
<li>conversion functions are inverses (when there are two <code>to_int</code> and <code>of_int</code> functions in a file, we show that they are inverses);</li>
<li>the <code>compare</code> functions, to order elements, are well defined (see our blog post <a href="https://formal-land.gitlab.io/coq-tezos-of-ocaml/blog/2022/04/04/verifying-the-compare-functions" target="_blank" rel="noopener noreferrer">Verifying the compare functions of OCaml</a>);</li>
<li>invariants are preserved. For example, <a href="https://formal-land.gitlab.io/coq-tezos-of-ocaml/docs/proofs/carbonated_map#Make.update_is_valid" target="_blank" rel="noopener noreferrer">here</a> we show that updating a carbonated map preserves the property of having a size field actually equal to the number of elements.</li>
</ul>
<p>We should note that the size of Coq proofs tends to grow faster than the size of the verified code. We have no coverage metrics to know how much of the code is covered by these proofs.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="data-encodings-">Data-encodings üåä<a href="https://formal.land/blog/2022/06/15/status%20update-tezos#data-encodings-" class="hash-link" aria-label="Direct link to Data-encodings üåä" title="Direct link to Data-encodings üåä">‚Äã</a></h2>
<p>The <a href="https://gitlab.com/nomadic-labs/data-encoding" target="_blank" rel="noopener noreferrer">data-encoding</a> library is a set of combinators to write serialization/de-serialization functions. We verify that the encodings defined for each protocol data type are bijective. The good thing we have is a semi-automated tactic to verify the use of the <code>data-encoding</code> primitives. We detail this approach in our blog post <a href="https://formal-land.gitlab.io/coq-tezos-of-ocaml/blog/2021/11/22/data-encoding-automation" target="_blank" rel="noopener noreferrer">Automation of <code>data_encoding</code> proofs</a>. We can verify most of the encoding functions that we encounter. From there, we also express the <strong>invariant</strong> associated with each data type, which the encodings generally check at runtime. The invariants are then the domain of definition of the encodings.</p>
<p>However, we have a hole: we do not verify the <code>data-encoding</code> library itself. Thus the <a href="https://formal-land.gitlab.io/coq-tezos-of-ocaml/docs/environment/proofs/data_encoding" target="_blank" rel="noopener noreferrer">axioms we made</a> on the data-encoding primitives may have approximations. And indeed, we missed one issue in the development code of the protocol. This is thus a new high-priority target to verify the <code>data-encoding</code> library itself. One of the challenges for the proof is the use of side-effects (references and exceptions) in this library.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="property-based-tests-">Property-based tests üåä<a href="https://formal.land/blog/2022/06/15/status%20update-tezos#property-based-tests-" class="hash-link" aria-label="Direct link to Property-based tests üåä" title="Direct link to Property-based tests üåä">‚Äã</a></h2>
<p>The property-based tests on the protocol are located in <a href="https://gitlab.com/tezos/tezos/-/tree/master/src/proto_alpha/lib_protocol/test/pbt" target="_blank" rel="noopener noreferrer"><code>src/proto_alpha/lib_protocol/test/pbt</code></a>. These tests are composed of:</p>
<ul>
<li>a generator, generating random inputs of a certain shape;</li>
<li>a property function, a boolean function taking a generated input and supposed to always answer <code>true</code>.</li>
</ul>
<p>We translated a part of these tests to Coq, to convert them to theorems and have specifications extracted from the code. The result of this work is summarized in this blog post: <a href="https://formal-land.gitlab.io/coq-tezos-of-ocaml/blog/2022/06/07/formal-verification-of-property-based-tests" target="_blank" rel="noopener noreferrer">Formal verification of property based tests</a>. We have fully translated and verified four test files over a total of twelve. We are continuing the work of translations and proofs.</p>
<p>However, we found that for some of the files the proofs were taking a long time to write compared to the gains in safety. Indeed, the statements made in the tests are sometimes too complex when translated into general theorems. For example, for <a href="https://gitlab.com/tezos/tezos/-/blob/master/src/proto_alpha/lib_protocol/test/pbt/test_carbonated_map.ml" target="_blank" rel="noopener noreferrer">test_carbonated_map.ml</a> we have to deal with:</p>
<ul>
<li>gas exhaustion (seemingly impossible in the tests);</li>
<li>data structures of size greater than <code>max_int</code> (impossible in practice).</li>
</ul>
<p>All of that complicate the proofs for little gain in safety. So I would say that not all the property-based tests have a nice and useful translation to Coq. We should still note that for some of the tests, like with saturation arithmetic, we have proofs that work well. For these, we rely on the automated linear arithmetic tactic <a href="https://coq.inria.fr/refman/addendum/micromega.html" target="_blank" rel="noopener noreferrer"><code>lia</code></a> of Coq to verify properties over integer overflows.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="storage-system-">Storage system üåä<a href="https://formal.land/blog/2022/06/15/status%20update-tezos#storage-system-" class="hash-link" aria-label="Direct link to Storage system üåä" title="Direct link to Storage system üåä">‚Äã</a></h2>
<p>By "storage system" we understand the whole set of functors defined in <a href="https://gitlab.com/tezos/tezos/-/blob/master/src/proto_alpha/lib_protocol/storage_functors.ml" target="_blank" rel="noopener noreferrer"><code>storage_functors.ml</code></a> and how we apply them to define the protocol storage in <a href="https://gitlab.com/tezos/tezos/-/blob/master/src/proto_alpha/lib_protocol/storage_functors.ml" target="_blank" rel="noopener noreferrer"><code>storage.ml</code></a>. These functors create sub-storages with signatures such as:</p>
<div class="language-ocaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ocaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">module</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> Non_iterable_indexed_data_storage </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sig</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> context </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">value</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> mem </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> context </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> key </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> bool Lwt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> get </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> context </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> key </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">value</span><span class="token plain"> tzresult Lwt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> find </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> context </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> key </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">value</span><span class="token plain"> option tzresult Lwt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> update </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> context </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> key </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">value</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> Raw_context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t tzresult Lwt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> init </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> context </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> key </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">value</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> Raw_context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t tzresult Lwt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> add </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> context </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> key </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">value</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> Raw_context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Lwt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> add_or_remove </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> context </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> key </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">value</span><span class="token plain"> option </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> Raw_context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Lwt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> remove_existing </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> context </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> key </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> Raw_context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t tzresult Lwt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> remove </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> context </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> key </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> Raw_context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t Lwt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This <code>Non_iterable_indexed_data_storage</code> API looks like the API of an OCaml's <a href="https://v2.ocaml.org/api/Map.Make.html" target="_blank" rel="noopener noreferrer">Map</a>. As a result, our goal for the storage is to show that is can be simulated by standard OCaml data structures such as sets and maps. This is a key step to unlock further reasoning about code using the storage.</p>
<p>Unfortunately, we were not able to verify the whole storage system yet. Among the difficulties are that:</p>
<ul>
<li>there are many layers in the definition of the storage;</li>
<li>the storage functors use a lot of abstractions, and sometimes it is unclear how to specify them in the general case.</li>
</ul>
<p>Still, we have verified some of the functors as seen in <a href="https://formal-land.gitlab.io/coq-tezos-of-ocaml/docs/proofs/storage_functors" target="_blank" rel="noopener noreferrer"><code>Proofs/Storage_functors.v</code></a> and specified the <code>storage.ml</code> file in <a href="https://formal-land.gitlab.io/coq-tezos-of-ocaml/docs/storage" target="_blank" rel="noopener noreferrer"><code>Proos/Storage.v</code></a>. We believe in having the correct specifications for all of the storage abstractions now. We plan to complete all these proofs later.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="michelson">Michelson<a href="https://formal.land/blog/2022/06/15/status%20update-tezos#michelson" class="hash-link" aria-label="Direct link to Michelson" title="Direct link to Michelson">‚Äã</a></h2>
<p>The verification of the Michelson interpreter is what occupied most of our time. By considering the OCaml files whose name starts by <code>script_</code>, the size of the Michelson interpreter is around 20,000 lines of OCaml code.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="simulations-">Simulations üåä<a href="https://formal.land/blog/2022/06/15/status%20update-tezos#simulations-" class="hash-link" aria-label="Direct link to Simulations üåä" title="Direct link to Simulations üåä">‚Äã</a></h3>
<p>The interpreter relies heavily on <a href="https://v2.ocaml.org/manual/gadts.html" target="_blank" rel="noopener noreferrer">GADTs</a> in OCaml. Because these do not translate nicely in Coq, we need to write simulations in dependent types of the interpreter functions, and prove them correct in Coq. We describe this process in our <a href="https://formal-land.gitlab.io/coq-tezos-of-ocaml/docs/guides/michelson" target="_blank" rel="noopener noreferrer">Michelson Guide</a>.</p>
<p>The main difficulties we encountered are:</p>
<ul>
<li>the number of simulations to write (covering the 20,000 lines of OCaml);</li>
<li>the execution time of the proof of correctness of the simulations. This is due to the large size of the inductive types describing the Michelson AST, and the use of dependent types generating large proof terms. For example, there are around 30 cases for the types and 150 for the instructions node in the AST.</li>
</ul>
<p>When writing the simulations, we are also verifying the termination of all the functions and the absence of reachable <code>assert false</code>. We have defined the simulation of many functions, but are still missing important ones such as <a href="https://formal-land.gitlab.io/coq-tezos-of-ocaml/docs/script_ir_translator/#parse_instr_aux" target="_blank" rel="noopener noreferrer"><code>parse_instr_aux</code></a> to parse Michelson programs.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="mi-cho-coq-">Mi-Cho-Coq üåä<a href="https://formal.land/blog/2022/06/15/status%20update-tezos#mi-cho-coq-" class="hash-link" aria-label="Direct link to Mi-Cho-Coq üåä" title="Direct link to Mi-Cho-Coq üåä">‚Äã</a></h3>
<p>We have a project to verify that the <a href="https://gitlab.com/nomadic-labs/mi-cho-coq" target="_blank" rel="noopener noreferrer">Mi-Cho-Coq</a> framework, used to formally verify smart contracts written in Michelson, is compatible with the implementation of the Michelson interpreter in OCaml. We have a partial proof of compatibility in <a href="https://formal-land.gitlab.io/coq-tezos-of-ocaml/docs/simulations/micho_to_dep" target="_blank" rel="noopener noreferrer">Micho_to_dep.v</a>. We still need to complete this proof, especially to handle instructions with loops. Our goal is to show a complete inclusion of the semantics of Mi-Cho-Coq into the semantics of the implementation.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="parseunparse-">Parse/unparse ‚ùå<a href="https://formal.land/blog/2022/06/15/status%20update-tezos#parseunparse-" class="hash-link" aria-label="Direct link to Parse/unparse ‚ùå" title="Direct link to Parse/unparse ‚ùå">‚Äã</a></h3>
<p>We wanted to verify that the various parsing and unparsing functions over Michelson are inverses. These functions exist for:</p>
<ul>
<li>comparable types</li>
<li>types</li>
<li>comparable data</li>
<li>data</li>
</ul>
<p>Because we are still focused on writing, verifying or updating the simulations, we are still not done for this task.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="https://formal.land/blog/2022/06/15/status%20update-tezos#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">‚Äã</a></h2>
<p>We have many ongoing projects but few fully completed tasks. We will focus more on having terminated proofs.</p>]]></content>
        <category label="tezos" term="tezos"/>
        <category label="coq-of-ocaml" term="coq-of-ocaml"/>
        <category label="coq" term="coq"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Make Tezos the first formally verified cryptocurrency]]></title>
        <id>https://formal.land/blog/2022/02/02/make-tezos-a-formally-verified-crypto</id>
        <link href="https://formal.land/blog/2022/02/02/make-tezos-a-formally-verified-crypto"/>
        <updated>2022-02-02T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Elephants]]></summary>
        <content type="html"><![CDATA[<p><img decoding="async" loading="lazy" alt="Elephants" src="https://formal.land/assets/images/elephants-elmira-gokoryan-b8a3155720b2c012f6a486e791eb4ad4.webp" width="1200" height="900" class="img_ev3q"></p>
<p>Our primary goal at <a href="https://formal.land/" target="_blank" rel="noopener noreferrer">Formal&nbsp;Land&nbsp;üå≤</a> is to make <a href="https://tezos.com/" target="_blank" rel="noopener noreferrer">Tezos</a> the first crypto-currency with a formally verified implementation. With <a href="https://en.wikipedia.org/wiki/Formal_verification" target="_blank" rel="noopener noreferrer">formal verification</a>, thanks to mathematical methods, we can check that a program behaves as expected for all possible inputs. Formal verification goes beyond what testing can do, as testing can only handle a finite amount of cases. That is critical as cryptocurrencies hold a large amount of money (around $3B for Tezos today). The current result of our verification project is available on <a href="https://formal-land.gitlab.io/coq-tezos-of-ocaml/" target="_blank" rel="noopener noreferrer">nomadic-labs.gitlab.io/coq-tezos-of-ocaml</a>. Formal verification is also key to allowing Tezos to evolve constantly in a safe and backward compatible manner.</p>
<p>We proceed in two steps:</p>
<ol>
<li>we translate the code of Tezos, written in <a href="https://ocaml.org/" target="_blank" rel="noopener noreferrer">OCaml</a>, to the proof language <a href="https://coq.inria.fr/" target="_blank" rel="noopener noreferrer">Coq</a> using the translator <a href="https://github.com/foobar-land/coq-of-ocaml" target="_blank" rel="noopener noreferrer">coq-of-ocaml</a>;</li>
<li>we write our specifications and proofs in the Coq language.</li>
</ol>
<p>We believe this is one of the most efficient ways to proceed, as we can work on an almost unmodified version of the codebase and use the full power of the mature proof system Coq. The code of Tezos is composed of around:</p>
<ul>
<li>50,000 lines for the protocol (the kernel of Tezos), and</li>
<li>200,000 lines for the shell (everything else, including the peer-to-peer layer and the storage backend).</li>
</ul>
<p>We are currently focusing on verifying the protocol for the following modules.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="data-encoding">Data-encoding<a href="https://formal.land/blog/2022/02/02/make-tezos-a-formally-verified-crypto#data-encoding" class="hash-link" aria-label="Direct link to Data-encoding" title="Direct link to Data-encoding">‚Äã</a></h2>
<p>The <a href="https://gitlab.com/nomadic-labs/data-encoding" target="_blank" rel="noopener noreferrer">data-encoding</a> library offers serialization and deserialization to binary and JSON formats. It is used in various parts of the Tezos protocol, especially on all the data types ending up in the storage system. In practice, many encodings are defined in the OCaml files named <code>*_repr.ml</code>. We verify that the <code>data-encoding</code> library is correctly used to define the encodings. We check that converting a value to binary format and from binary returns the initial value. We explicit the domain of validity of such conversions. This verification work generally reveals and propagates invariants about the data structures of the protocol. As an invariant example, all the account amounts should always be positive. Having these invariants will be helpful for the verification of higher-level layers of the protocol.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="michelson-smart-contracts">Michelson smart contracts<a href="https://formal.land/blog/2022/02/02/make-tezos-a-formally-verified-crypto#michelson-smart-contracts" class="hash-link" aria-label="Direct link to Michelson smart contracts" title="Direct link to Michelson smart contracts">‚Äã</a></h2>
<p>The smart contract language of Tezos is <a href="https://tezos.gitlab.io/active/michelson.html" target="_blank" rel="noopener noreferrer">Michelson</a>. The interpreter and type-checker of smart contracts is one of the most complex and critical parts of the protocol. We are verifying two things about this code:</p>
<ul>
<li>The equivalence of the interpreter and the Coq semantics for Michelson defined in the project <a href="https://gitlab.com/nomadic-labs/mi-cho-coq" target="_blank" rel="noopener noreferrer">Mi-Cho-Coq</a>. Thanks to this equivalence, we can make sure that the formal verification of smart contracts is sound for the current version of the protocol.</li>
<li>The compatibility of the parsing and unparsing functions for the Michelson types and values. The parsing functions take care of the type-checking and do a lot of sanity checks on Michelson expressions with appropriate error messages. Showing that the parsing and unparsing functions are inverses is important for security reasons. The Michelson values are always unparsed at the end of a smart contract execution to be stored on disk.</li>
</ul>
<p>To do these proofs, we also give a new semantics of Michelson, expressed using dependent types rather than <a href="https://ocaml.org/manual/gadts-tutorial.html" target="_blank" rel="noopener noreferrer">GADTs</a> in the OCaml implementation.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="storage-system">Storage system<a href="https://formal.land/blog/2022/02/02/make-tezos-a-formally-verified-crypto#storage-system" class="hash-link" aria-label="Direct link to Storage system" title="Direct link to Storage system">‚Äã</a></h2>
<p>Cryptocurrencies typically take a lot of space on disk (in the hundreds of gigabytes). In Tezos, we use the key-value database <a href="https://irmin.org/" target="_blank" rel="noopener noreferrer">Irmin</a>. The protocol provides a lot of <a href="https://gitlab.com/tezos/tezos/-/blob/master/src/proto_alpha/lib_protocol/storage_functors.ml" target="_blank" rel="noopener noreferrer">abstractions</a> over this database to expose higher-level interfaces with set and map-like APIs. We verify that these abstractions are valid doing a proof by simulation, where we show that the whole system is equivalent to an <a href="https://en.wikipedia.org/wiki/In-memory_database" target="_blank" rel="noopener noreferrer">in-memory database</a> using simpler data structures. Thanks to this simulation, we will be able to reason about code using the storage as if we were using the simpler in-memory version.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="in-addition">In addition<a href="https://formal.land/blog/2022/02/02/make-tezos-a-formally-verified-crypto#in-addition" class="hash-link" aria-label="Direct link to In addition" title="Direct link to In addition">‚Äã</a></h2>
<p>We also plan to verify:</p>
<ul>
<li>The implementation of the <code>data-encoding</code> library itself. This code is challenging for formal verification as it contains many imperative features. Another specificity of this library is that it sits outside of the protocol of Tezos, and we might need to adapt <code>coq-of-ocaml</code> to support it.</li>
<li>The <a href="https://gitlab.com/tezos/tezos/-/tree/master/src/proto_alpha/lib_protocol/test/pbt" target="_blank" rel="noopener noreferrer">property-based tests of the protocol</a>. These tests are written as boolean functions (or functions raising exceptions), which must return <code>true</code> on any possible inputs. We will verify them in the general case by importing their definitions to Coq and verifying with mathematical proofs that they are always correct.</li>
</ul>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Contact</div><div class="admonitionContent_BuS1"><p>For any questions or remarks, contact us on üëâ&nbsp;<a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">contact@formal.land</a>&nbsp;üëà.</p></div></div>]]></content>
        <category label="tezos" term="tezos"/>
        <category label="coq-of-ocaml" term="coq-of-ocaml"/>
        <category label="coq" term="coq"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[New blog posts and Meetup talk]]></title>
        <id>https://formal.land/blog/2021/11/12/new-blog-posts-and-meetup-talk</id>
        <link href="https://formal.land/blog/2021/11/12/new-blog-posts-and-meetup-talk"/>
        <updated>2021-11-12T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Recently, we added two new blog posts about the verification of the crypto-currency Tezos:]]></summary>
        <content type="html"><![CDATA[<p>Recently, we added two new blog posts about the verification of the crypto-currency <a href="https://tezos.com/" target="_blank" rel="noopener noreferrer">Tezos</a>:</p>
<ul>
<li><a href="https://formal-land.gitlab.io/coq-tezos-of-ocaml/blog/2021/11/01/verify-michelson-types-mi-cho-coq/" target="_blank" rel="noopener noreferrer">Verify the Michelson types of Mi-Cho-Coq</a> to compare the types defined in the Tezos code for the <a href="http://tezos.gitlab.io/active/michelson.html" target="_blank" rel="noopener noreferrer">Michelson</a> interpreter and in the <a href="https://gitlab.com/nomadic-labs/mi-cho-coq" target="_blank" rel="noopener noreferrer">Mi-Cho-Coq library</a> to verify smart contracts;</li>
<li><a href="https://formal-land.gitlab.io/coq-tezos-of-ocaml/blog/2021/11/08/translate-tenderbake/" target="_blank" rel="noopener noreferrer">Translate the Tenderbake's code to Coq</a> to explain how we translated the recent changes in Tezos to the Coq using <a href="https://github.com/foobar-land/coq-of-ocaml" target="_blank" rel="noopener noreferrer">coq-of-ocaml</a>. In particular we translated the code of the new <a href="https://research-development.nomadic-labs.com/a-look-ahead-to-tenderbake.html" target="_blank" rel="noopener noreferrer">Tenderbake</a> consensus algorithm.</li>
</ul>
<p>We also talked at the <a href="https://www.meetup.com/LambdaLille/events/281374644/" target="_blank" rel="noopener noreferrer">Lambda Lille Meetup</a> (in French) to present our work on <code>coq-of-ocaml</code> for Tezos. A video on the <a href="https://www.youtube.com/channel/UC-hC7y_ilQBq0QCa9xDu1iA" target="_blank" rel="noopener noreferrer">Youtube channel</a> of the Meetup should be available shortly. We thanks the organizers for hosting the talk.</p>]]></content>
        <category label="tezos" term="tezos"/>
        <category label="mi-cho-coq" term="mi-cho-coq"/>
        <category label="coq-of-ocaml" term="coq-of-ocaml"/>
        <category label="meetup" term="meetup"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Verification of the use of data-encoding]]></title>
        <id>https://formal.land/blog/2021/10/27/verification-data-encoding</id>
        <link href="https://formal.land/blog/2021/10/27/verification-data-encoding"/>
        <updated>2021-10-27T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[We added a blog post about the verification of the use of data-encodings in the protocol of Tezos. Currently, we work on the verification of Tezos and publish our blog articles there. We use coq-of-ocaml to translate the OCaml code to Coq and do our verification effort.]]></summary>
        <content type="html"><![CDATA[<p>We added a blog post about the <a href="https://formal-land.gitlab.io/coq-tezos-of-ocaml/blog/2021/10/20/data-encoding-usage" target="_blank" rel="noopener noreferrer">verification of the use of data-encodings</a> in the protocol of Tezos. Currently, we work on the verification of Tezos and publish our blog articles there. We use <a href="https://foobar-land.github.io/coq-of-ocaml/" target="_blank" rel="noopener noreferrer">coq-of-ocaml</a> to translate the OCaml code to Coq and do our verification effort.</p>]]></content>
        <category label="data-encoding" term="data-encoding"/>
    </entry>
</feed>