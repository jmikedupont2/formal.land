<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.14">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Formal Land RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Formal Land Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-MQLHF4EV4J"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-MQLHF4EV4J",{anonymize_ip:!0})</script><title data-react-helmet="true">Optimizing Rust translation to Coq with THIR and bundled traits | Formal Land</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:image" content="https://formal.land/img/land-512.png"><meta data-react-helmet="true" name="twitter:image" content="https://formal.land/img/land-512.png"><meta data-react-helmet="true" property="og:url" content="https://formal.land/blog/2023/11/08/rust-thir-and-bundled-traits"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><meta data-react-helmet="true" property="og:title" content="Optimizing Rust translation to Coq with THIR and bundled traits | Formal Land"><meta data-react-helmet="true" name="description" content="We continued our work on coq-of-rust, a tool to formally verify Rust programs using the proof system Coq&amp;nbsp;üêì. This tool translates Rust programs to an equivalent Coq program, which can then be verified using Coq&#x27;s proof assistant. It opens the door to building mathematically proven bug-free Rust programs."><meta data-react-helmet="true" property="og:description" content="We continued our work on coq-of-rust, a tool to formally verify Rust programs using the proof system Coq&amp;nbsp;üêì. This tool translates Rust programs to an equivalent Coq program, which can then be verified using Coq&#x27;s proof assistant. It opens the door to building mathematically proven bug-free Rust programs."><meta data-react-helmet="true" property="og:type" content="article"><meta data-react-helmet="true" property="article:published_time" content="2023-11-08T00:00:00.000Z"><meta data-react-helmet="true" property="article:tag" content="coq-of-rust,Rust,Coq,trait,THIR,HIR"><link data-react-helmet="true" rel="icon" href="/img/land-512.png"><link data-react-helmet="true" rel="canonical" href="https://formal.land/blog/2023/11/08/rust-thir-and-bundled-traits"><link data-react-helmet="true" rel="alternate" href="https://formal.land/blog/2023/11/08/rust-thir-and-bundled-traits" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://formal.land/blog/2023/11/08/rust-thir-and-bundled-traits" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.20dc303f.css">
<link rel="preload" href="/assets/js/runtime~main.b15903ae.js" as="script">
<link rel="preload" href="/assets/js/main.eb2a146d.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><div class="announcementBar_3WsW" style="background-color:#fafbfc;color:#091E42" role="banner"><div class="announcementBarContent_3EUC">For formal verification services, email us at <a href="mailto:&#099;&#111;&#110;&#116;&#097;&#099;&#116;&#064;formal&#046;&#108;&#097;&#110;&#100;">&#099;&#111;&#110;&#116;&#097;&#099;&#116;&#064;formal&#046;&#108;&#097;&#110;&#100;</a>!</div></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/land-512.png" alt="Logo" class="themedImage_1VuW themedImage--light_3UqQ"><img src="/img/land-512.png" alt="Logo" class="themedImage_1VuW themedImage--dark_hz6m"></div><b class="navbar__title">Formal Land</b></a><a class="navbar__item navbar__link" href="/docs/company/about">Company</a><a class="navbar__item navbar__link" href="/docs/verification/ocaml">Formal verification</a><a class="navbar__item navbar__link" href="/docs/services/solidity-development">Services</a><a class="navbar__item navbar__link" href="/docs/coq-of-ocaml/introduction">coq-of-ocaml</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/formal-land" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://gitlab.com/formal-land" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitLab<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_2ahu thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_2hhb margin-bottom--md">Recent posts</div><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2024/02/22/journey-coq-of-go">Translating Go to Coq, part 1</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2024/02/14/experiment-coq-of-hs">Experiment on translation from Haskell to Coq</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2024/02/02/formal-verification-for-aleph-zero">The importance of formal verification</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2024/01/18/update-coq-of-rust">Upgrade the Rust version of coq-of-rust</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2024/01/04/rust-translating-match">Translating Rust match patterns to Coq with coq-of-rust</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_GeHD" itemprop="headline">Optimizing Rust translation to Coq with THIR and bundled traits</h1><div class="blogPostData_291c margin-vert--md"><time datetime="2023-11-08T00:00:00.000Z" itemprop="datePublished">November 8, 2023</time> ¬∑ <!-- -->6 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a itemprop="url"><span itemprop="name">Guillaume Claret</span></a></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>We continued our work on <a href="https://github.com/formal-land/coq-of-rust" target="_blank" rel="noopener noreferrer">coq-of-rust</a>, a tool to formally verify <a href="https://www.rust-lang.org/" target="_blank" rel="noopener noreferrer">Rust</a> programs using the proof system <a href="https://coq.inria.fr/" target="_blank" rel="noopener noreferrer">Coq<!-- -->¬†<!-- -->üêì</a>. This tool translates Rust programs to an equivalent Coq program, which can then be verified using Coq&#x27;s proof assistant. It opens the door to building mathematically proven bug-free Rust programs.</p><p>We present two main improvements we made to <code>coq-of-rust</code>:</p><ul><li>Using the THIR intermediate language of Rust to have more information during the translation to Coq.</li><li>Bundling the type-classes representing the traits of Rust to have faster type-checking in Coq.</li></ul><p><img alt="Rust and Coq" src="/assets/images/rust_and_coq-24841df3c1f402ea1ff783770d999040.png"></p><h2 class="anchor anchorWithStickyNavbar_31ik" id="thir-intermediate-language">THIR intermediate language<a class="hash-link" href="#thir-intermediate-language" title="Direct link to heading">‚Äã</a></h2><p>To translate Rust programs to Coq, we plug into the compiler of Rust, which operates on a series of intermediate languages:</p><ul><li>source code (<code>.rs</code> files);</li><li>abstract syntax tree (AST): immediately after parsing;</li><li><a href="https://rustc-dev-guide.rust-lang.org/hir.html" target="_blank" rel="noopener noreferrer">High-Level Intermediate Representation</a> (HIR): after macro expansion, with name resolution and close to the AST;</li><li><a href="https://rustc-dev-guide.rust-lang.org/thir.html" target="_blank" rel="noopener noreferrer">Typed High-Level Intermediate Representation</a> (THIR): after the type-checking;</li><li><a href="https://rustc-dev-guide.rust-lang.org/mir/index.html" target="_blank" rel="noopener noreferrer">Mid-level Intermediate Representation</a> (MIR): low-level representation based on a <a href="https://en.wikipedia.org/wiki/Control-flow_graph" target="_blank" rel="noopener noreferrer">control-flow graph</a>, inlining traits and polymorphic functions, and with <a href="https://doc.rust-lang.org/book/ch04-02-references-and-borrowing.html" target="_blank" rel="noopener noreferrer">borrow checking</a>;</li><li>machine code (assembly, LLVM IR, ...).</li></ul><p>We were previously using the HIR language to start our translation to Coq, because it is not too low-level and close to what the user has originally in the <code>.rs</code> file. This helps relate the generated Coq code to the original Rust code.</p><p>However, at the level of HIR, there is still a lot of implicit information. For example, Rust has <a href="https://users.rust-lang.org/t/automatic-dereferencing/53828" target="_blank" rel="noopener noreferrer">automatic dereferencing rules</a> that are not yet explicit in HIR. In order not to make any mistakes during our translation to Coq, we prefer to use the next representation, THIR, that makes explicit such rules.</p><p>In addition, the THIR representation shows when a method call is from a trait (and which trait) or from a standalone <code>impl</code> block. Given that we still have trouble translating the traits with <a href="https://coq.inria.fr/doc/V8.18.0/refman/addendum/type-classes.html" target="_blank" rel="noopener noreferrer">type-classes</a> that are inferrable by Coq, this helps a lot.</p><p>A downside of the THIR representation is that it is much more verbose. For example, here is a formatting function generated from HIR:</p><div class="codeBlockContainer_K1bP language-coq theme-code-block"><div class="codeBlockContent_hGly coq"><pre tabindex="0" class="prism-code language-coq codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">Definition fmt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `{‚Ñã : State.Trait}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    (self : ref Self)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    (f : mut_ref core.fmt.Formatter)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    : M core.fmt.Result :=</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  let* Œ±0 := format_argument::[&quot;new_display&quot;] (addr_of self.[&quot;radius&quot;]) in</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  let* Œ±1 :=</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    format_arguments::[&quot;new_v1&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      (addr_of [ &quot;Circle of radius &quot; ])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      (addr_of [ Œ±0 ]) in</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  f.[&quot;write_fmt&quot;] Œ±1.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>This is the kind of functions generated by the <code>#[derive(Debug)]</code> macro of Rust, to implement a formatting function on a type. Here is the version translated from THIR, with explicit borrowing and dereferencing:</p><div class="codeBlockContainer_K1bP language-coq theme-code-block"><div class="codeBlockContent_hGly coq"><pre tabindex="0" class="prism-code language-coq codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">Definition fmt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `{‚Ñã : State.Trait}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    (self : ref Self)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    (f : mut_ref core.fmt.Formatter)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    : M ltac:(core.fmt.Result) :=</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  let* Œ±0 := deref f core.fmt.Formatter in</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  let* Œ±1 := borrow_mut Œ±0 core.fmt.Formatter in</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  let* Œ±2 := borrow [ mk_str &quot;Circle of radius &quot; ] (list (ref str)) in</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  let* Œ±3 := deref Œ±2 (list (ref str)) in</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  let* Œ±4 := borrow Œ±3 (list (ref str)) in</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  let* Œ±5 := pointer_coercion &quot;Unsize&quot; Œ±4 in</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  let* Œ±6 := deref self converting_to_string.Circle in</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  let* Œ±7 := Œ±6.[&quot;radius&quot;] in</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  let* Œ±8 := borrow Œ±7 i32 in</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  let* Œ±9 := deref Œ±8 i32 in</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  let* Œ±10 := borrow Œ±9 i32 in</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  let* Œ±11 := core.fmt.rt.Argument::[&quot;new_display&quot;] Œ±10 in</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  let* Œ±12 := borrow [ Œ±11 ] (list core.fmt.rt.Argument) in</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  let* Œ±13 := deref Œ±12 (list core.fmt.rt.Argument) in</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  let* Œ±14 := borrow Œ±13 (list core.fmt.rt.Argument) in</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  let* Œ±15 := pointer_coercion &quot;Unsize&quot; Œ±14 in</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  let* Œ±16 := core.fmt.Arguments::[&quot;new_v1&quot;] Œ±5 Œ±15 in</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  core.fmt.Formatter::[&quot;write_fmt&quot;] Œ±1 Œ±16.</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>We went from a function having two intermediate variables to seventeen intermediate variables. This code is much more verbose, but it is also more explicit. In particular, it details when the:</p><ul><li>borrowing (going from a value of type <code>T</code> to <code>&amp;T</code>), and the</li><li>dereferencing (going from a value of type <code>&amp;T</code> to <code>T</code>)</li></ul><p>occur. It also shows that the method<!-- -->¬†<code>write_fmt</code> is a method from the implementation of the type <code>core.fmt.Formatter</code>, generating:</p><div class="codeBlockContainer_K1bP language-coq theme-code-block"><div class="codeBlockContent_hGly coq"><pre tabindex="0" class="prism-code language-coq codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">core.fmt.Formatter::[&quot;write_fmt&quot;] Œ±1 Œ±16</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>instead of:</p><div class="codeBlockContainer_K1bP language-coq theme-code-block"><div class="codeBlockContent_hGly coq"><pre tabindex="0" class="prism-code language-coq codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">f.[&quot;write_fmt&quot;] Œ±1</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_31ik" id="bundled-traits">Bundled traits<a class="hash-link" href="#bundled-traits" title="Direct link to heading">‚Äã</a></h2><p>Some Rust codebases can have a lot of traits. For example in <a href="https://github.com/paritytech/ink/blob/ccb38d2c3ac27523fe3108f2bb7bffbbe908cdb7/crates/env/src/types.rs#L120" target="_blank" rel="noopener noreferrer">paritytech/ink/crates/env/src/types.rs</a> the trait<!-- -->¬†<code>Environment</code> references more than forty other traits:</p><div class="codeBlockContainer_K1bP language-rust theme-code-block"><div class="codeBlockContent_hGly rust"><pre tabindex="0" class="prism-code language-rust codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">pub trait Environment: Clone {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    const MAX_EVENT_TOPICS: usize;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    type AccountId: &#x27;static</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        + scale::Codec</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        + CodecAsType</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        + Clone</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        + PartialEq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        + ...;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    type Balance: &#x27;static</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        + scale::Codec</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        + CodecAsType</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        + ...;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>We first used an unbundled approach to represent this trait by a type-class in Coq, as it felt more natural:</p><div class="codeBlockContainer_K1bP language-coq theme-code-block"><div class="codeBlockContent_hGly coq"><pre tabindex="0" class="prism-code language-coq codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">Module Environment.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Class Trait (Self : Set) `{Clone.Trait Self}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {AccountId : Set}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `{scale.Codec.Trait AccountId}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `{CodecAsType AccountId}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `{Clone AccountId}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `{PartialEq AccountId}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>However, the backquote operator generated too many implicit arguments, and the type-checker of Coq was very slow. We then switched to a bundled approach, as advocated in this blog post: <a href="https://www.ralfj.de/blog/2019/05/15/typeclasses-exponential-blowup.html" target="_blank" rel="noopener noreferrer">Exponential blowup when using unbundled typeclasses to model algebraic hierarchies</a>. The Coq code for this trait now looks like this:</p><div class="codeBlockContainer_K1bP language-coq theme-code-block"><div class="codeBlockContent_hGly coq"><pre tabindex="0" class="prism-code language-coq codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">Module Environment.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Class Trait `{‚Ñã : State.Trait} (Self : Set) : Type := {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ‚Ñã_0 :: Clone.Trait Self;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MAX_EVENT_TOPICS : usize;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AccountId : Set;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ‚Ñí_0 :: parity_scale_codec.codec.Codec.Trait AccountId;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ‚Ñí_1 :: ink_env.types.CodecAsType.Trait AccountId;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ‚Ñí_2 :: core.clone.Clone.Trait AccountId;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ‚Ñí_3 ::</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      core.cmp.PartialEq.Trait AccountId</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        (Rhs := core.cmp.PartialEq.Default.Rhs AccountId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Balance : Set;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ‚Ñí_8 :: parity_scale_codec.codec.Codec.Trait Balance;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ‚Ñí_9 :: ink_env.types.CodecAsType.Trait Balance;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>We use the notation<!-- -->¬†<code>::</code> for fields that are trait instances. With this approach, traits have types as parameters but no other traits.</p><p>The type-checking is now much faster, and in particular, we avoid some cases with exponential blowup or non-terminating type-checking. But this is not a perfect solution as we still have cases where the instance inference does not terminate or fails with hard-to-understand error messages.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="conclusion">Conclusion<a class="hash-link" href="#conclusion" title="Direct link to heading">‚Äã</a></h2><p>We have illustrated here some improvements we recently made to our <a href="https://github.com/formal-land/coq-of-rust" target="_blank" rel="noopener noreferrer">coq-of-rust</a> translator for two key areas:</p><ul><li>the translation of traits;</li><li>the translation of the implicit borrowing and dereferencing, that can occur every time we call a function.</li></ul><p>These improvements will allow us to formally verify some more complex Rust codebases. In particular, we are applying <code>coq-of-rust</code> to verify smart contracts written for the <a href="https://use.ink/" target="_blank" rel="noopener noreferrer">ink!</a> platform, that is a subset of Rust.</p><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Contact</h5></div><div class="admonition-content"><p>If you have comments, similar experiences to share, or wish to formally verify your codebase to improve the security of your application, contact us at<!-- -->¬†<a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer">c<!-- -->o<!-- -->n<!-- -->t<!-- -->a<!-- -->c<!-- -->t<!-- -->@<!-- -->formal<!-- -->.<!-- -->l<!-- -->a<!-- -->n<!-- -->d</a>!</p></div></div></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_3kfx"><div class="col"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/blog/tags/coq-of-rust">coq-of-rust</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/blog/tags/rust">Rust</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/blog/tags/coq">Coq</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/blog/tags/trait">trait</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/blog/tags/thir">THIR</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/blog/tags/hir">HIR</a></li></ul></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blog/2023/11/26/rust-function-body"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">¬´ <!-- -->Translation of function bodies from Rust to Coq</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/2023/08/25/trait-representation-in-coq"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Trait representation in Coq<!-- --> ¬ª</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#thir-intermediate-language" class="table-of-contents__link toc-highlight">THIR intermediate language</a></li><li><a href="#bundled-traits" class="table-of-contents__link toc-highlight">Bundled traits</a></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Content</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/company/about">Company</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/company/claims">Claims</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/company/press">Press</a></li></ul></div><div class="col footer__col"><div class="footer__title">Links</div><ul class="footer__items"><li class="footer__item"><a href="https://twitter.com/LandFoobar" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://fr.linkedin.com/company/formal-land" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Linkedin<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://t.me/formal_land" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Telegram<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://www.tiktok.com/@formal.land" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>TikTok<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="mailto:contact@formal.land" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Email<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/formal-land" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://gitlab.com/formal-land" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitLab<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://formal-land.gitlab.io/coq-tezos-of-ocaml/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Coq Tezos of OCaml<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright ¬© 2024 Formal Land (Arae SARL) üê¶, Paris<br><em>Formal verification for everyday-life applications üèá</em><!-- Start of LiveChat (www.livechat.com) code -->
<script>window.__lc=window.__lc||{},window.__lc.license=14938650,function(n,t,c){function i(n){return e._h?e._h.apply(null,n):e._q.push(n)}var e={_q:[],_h:null,_v:"2.0",on:function(){i(["on",c.call(arguments)])},once:function(){i(["once",c.call(arguments)])},off:function(){i(["off",c.call(arguments)])},get:function(){if(!e._h)throw new Error("[LiveChatWidget] You can't use getters before load.");return i(["get",c.call(arguments)])},call:function(){i(["call",c.call(arguments)])},init:function(){var n=t.createElement("script");n.async=!0,n.type="text/javascript",n.src="https://cdn.livechatinc.com/tracking.js",t.head.appendChild(n)}};!n.__lc.asyncInit&&e.init(),n.LiveChatWidget=n.LiveChatWidget||e}(window,document,[].slice)</script>
<noscript><a href="https://www.livechat.com/chat-with/14938650/" rel="nofollow">Chat with us</a>, powered by <a href="https://www.livechat.com/?welcome" rel="noopener nofollow" target="_blank">LiveChat</a></noscript>
<!-- End of LiveChat code --></div></div></div></footer></div>
<script src="/assets/js/runtime~main.b15903ae.js"></script>
<script src="/assets/js/main.eb2a146d.js"></script>
</body>
</html>